function tileType(e,i){return i?tileVegetationTypeFromSteepness[e]:e}function heatmap(e,i,t,r,s){for(var n=0,a=0,l=0;s>l;l++){var o=Math.pow(2,l);n+=t.noise2D(e/r*o,i/r*o)/o,a+=1/o}return n/a}function Terrain(e){this.humanity=e,this.plans={}}var SimplexNoise=require("simplex-noise"),MersenneTwister=require("./mersenne-twister"),prng=new MersenneTwister(0),simplex1=new SimplexNoise(prng.random.bind(prng)),simplex2=new SimplexNoise(prng.random.bind(prng)),factor=50,tileTypes={water:0,steppe:1,hill:2,mountain:3,swamp:4,meadow:5,forest:6,taiga:7,farm:8,residence:9,skyscraper:10,factory:11,dock:12,airland:13,airport:14,gunsmith:15,road:16,wall:17,blackdeath:18,metal:19,lumber:20,mine:21,industry:22,citrus:23,university:24,beach:25,arsenal:26,smoke:27,impact:28,curvedRoad:29,whales:30,pearls:31,fish:32,algae:33,glass:34,salt:35,cattle:36,poultry:37,ivory:38,limestone:39,wool:40,wine:41,fur:42,pigments:43,rubber:44,coal:45,crocodile:46,petroleum:47,shrimp:48,clay:49,spices:50,cotton:51,coffee:52,tea:53,resin:54,cocoa:55,honey:56,silk:57,ruby:58,gems:59,pelt:60,amber:61,field:62,market:63,"space mission":64},buildingTypes=[8,9,10,11,12,13,14,15,16,17,20,21,22,24,26,62,63,64],resourceTypes={fuel:-1,production:-2,wealth:-3},listOfResourceTypes=[resourceTypes.fuel,resourceTypes.production,resourceTypes.wealth],tileVegetationTypeFromSteepness=[];tileVegetationTypeFromSteepness[tileTypes.water]=tileTypes.swamp,tileVegetationTypeFromSteepness[tileTypes.steppe]=tileTypes.meadow,tileVegetationTypeFromSteepness[tileTypes.hill]=tileTypes.forest,tileVegetationTypeFromSteepness[tileTypes.mountain]=tileTypes.taiga;var distancesNormal=[17,2,4,16,8,3,8,24,,,,,,,,,1,32],distancesBoat=[1,4,8,16,1,8,16,24,,,,,,,,,1,32],distancesPlane=[1,1,2,2,1,1,2,2,,,,,,,,,1,8],MAX_INT=9007199254740992,manufacture={boat:1,car:2,plane:4,artillery:8,gun:16},buildingDependencies=[,,,,,,,,,[[2,tileTypes.farm]],[[6,tileTypes.residence]],[[3,tileTypes.residence],[2,tileTypes.road]],[[1,tileTypes.residence],[1,tileTypes.water],[1,resourceTypes.fuel]],[[2,tileTypes.road]],[[1,tileTypes.gunsmith],[3,tileTypes.airland],[1,resourceTypes.fuel]],[[1,tileTypes.skyscraper],[1,tileTypes.factory]],,,,,[[1,tileTypes.residence]],[[1,resourceTypes.fuel],[1,tileTypes.factory]],[[10,resourceTypes.wealth],[1,tileTypes.mine],[5,tileTypes.road]],,[[1,tileTypes.meadow],[1,tileTypes.water],[2,tileTypes.residence]],,[[1,tileTypes.gunsmith],[1,resourceTypes.production]],,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,[],[[1,tileTypes.dock],[1,tileTypes.skyscraper],[4,resourceTypes.production]],[[2,tileTypes.airport],[20,resourceTypes.production],[20,resourceTypes.fuel]]],buildingTileDependency=[,,,,,,,,,,,,,,,,,,,,[tileTypes.forest,tileTypes.taiga],[tileTypes.metal],,,,,[tileTypes.steppe]],planTypes={move:1,build:2};Terrain.prototype={humanity:null,centerTile:{q:0,r:0},centerPoint:{x:0,y:0},tileTypes:tileTypes,buildingTypes:buildingTypes,resourceTypes:resourceTypes,listOfResourceTypes:listOfResourceTypes,tileType:tileType,heatmap:heatmap,setCenterTile:function(e){this.centerTile=e,this.centerPoint.x=Math.sqrt(3)*(e.q+e.r/2)|0,this.centerPoint.y=1.5*e.r},continent:function(e,i){var t=512,r=heatmap(e,i,simplex1,t,8),s=this.centerPoint,n=(e-s.x)*(e-s.x)+(i-s.y)*(i-s.y),a=heatmap(e,i,simplex1,4*t,8),l=+(r+.7)*Math.exp(-n/(t*t));return a>l&&(l=a),l=Math.min(1,l)},continentLimit:.42,tile:function e(i){var t,r;void 0===i.x?(t=Math.sqrt(3)*(i.q+i.r/2)|0,r=1.5*i.r):(t=i.x,r=i.y);var s=simplex2.noise2D(r/500,t/500),n=1-Math.abs((4*simplex1.noise2D(t/4/factor,r/4/factor)+2*simplex1.noise2D(t/2/factor,r/2/factor)+1*simplex1.noise2D(t/1/factor,r/1/factor)+.5*simplex1.noise2D(2*t/factor,2*r/factor))/7.5),a=Math.sin(-(5*s)*Math.abs(simplex1.noise2D(.25*t/factor,.25*r/factor))+simplex1.noise2D(t/factor,r/factor)-.5*simplex1.noise2D(2*t/factor,2*r/factor)+.25*simplex1.noise2D(4*t/factor,4*r/factor)-1/8*simplex1.noise2D(8*t/factor,8*r/factor)+1/16*simplex1.noise2D(16*t/factor,16*r/factor)),l=-simplex2.noise2D(r/factor/8,t/factor/8)+simplex2.noise2D(r/factor/4,t/factor/4)+a/2,o=s*simplex2.noise2D(t/factor,r/factor)+.5*simplex2.noise2D(2*t/factor,2*r/factor)+.25*simplex2.noise2D(4*t/factor,4*r/factor)+1/8*simplex2.noise2D(8*t/factor,8*r/factor)+1/16*simplex2.noise2D(16*t/factor,16*r/factor),p=a-n,u=this.continent(t,r);if(u>this.continentLimit)var c,y=-1.3,m=(a>.6?!1:n>.98)||-1>3*l/4+a/4?(c=(-1.5-y)/(this.continentLimit-1),p=u*c+y-c,tileTypes.water):-1>o?tileTypes.hill:-.2>p?tileTypes.steppe:.2>p?tileTypes.hill:tileTypes.mountain,f=o-(m===tileTypes.water?2*l:0)+Math.abs(a+.15)<0;else{var m=tileTypes.water,f=!1,h=u-1.92;p=h}var e={steepness:m,vegetation:f,type:this.tileType(m,f),height:p,rain:-o/2};return e},commodity:function(e,i){var t,r=e.q,s=e.r,n=(-simplex1.noise2D(r/60,s/60)/8+1)/2,a=(simplex1.noise2D(r/60,s/60)/8+1)/2,l=(-simplex2.noise2D(r/60,s/60)/8+1)/2,o=(simplex2.noise2D(r/60,s/60)/8+1)/2,p=n*simplex1.noise2D(r/4,s/4),u=a*simplex1.noise2D(r/16,s/16),c=l*simplex2.noise2D(r/2,s/2),y=o*simplex2.noise2D(r/8,s/8);if(p>.49)t=0;else if(u>.49)t=1;else if(c>.45)t=2;else{if(!(y>.45))return-1;t=3}var m;return m=null!=i?i.type:this.tile(e).type,tileTypes.whales+(m<<2)+t},distances:distancesNormal,distance:function(e){var i=this.tile(e),t=this.humanity.tile(e),r=this.distances[t&&t.b?t.b:i.type];return void 0===r&&(r=this.distances[i.type]),r},distanceBetweenTiles:function(e,i){return(Math.abs(e.q-i.q)+Math.abs(e.r-i.r)+Math.abs(e.q+e.r-i.q-i.r))/2},neighborFromTile:function(e,i){return 0===i?{q:e.q+1,r:e.r}:1===i?{q:e.q+1,r:e.r-1}:2===i?{q:e.q,r:e.r-1}:3===i?{q:e.q-1,r:e.r}:4===i?{q:e.q-1,r:e.r+1}:5===i?{q:e.q,r:e.r+1}:void 0},keyFromTile:function(e){return e.q+":"+e.r},tileFromKey:function(e){var i=e.split(":");return{q:0|i[0],r:0|i[1]}},manufacture:manufacture,manufactureFromBuilding:function(e){return e===tileTypes.dock?manufacture.boat:e===tileTypes.factory?manufacture.car:e===tileTypes.airport?manufacture.plane:e===tileTypes.gunsmith?manufacture.gun:null},speedFromHuman:function(e){var i=8;return 0!==(e.o&manufacture.car)&&(i+=8),i},travelFrom:function(e,i){var t=this.humanity.tile(e).c,r={},s=this.keyFromTile(e);r[s]=null;var n={};n[s]=0;var a=[];for(a.push(s);a.length>0;){s=a.shift();var l=this.humanity.tile(this.tileFromKey(s));if(!l||null==l.c||l.c===t)for(var o=0;6>o;o++){var p=this.neighborFromTile(this.tileFromKey(s),o),u=n[s]+this.distance(p);if(i>=u){var c=this.keyFromTile(p);if(void 0!==n[c]&&u<n[c]&&delete n[c],void 0===n[c]&&void 0===r[c]){n[c]=u,r[c]=s;for(var y=-1,m=0;m<a.length;m++)if(void 0!==n[a[m]]){if(n[c]<=n[a[m]]){y=m;break}}else a.splice(m,1),m--;-1===y?a.push(c):a.splice(y,0,c)}}}}return r},travelTo:function(e,i,t,r,s,n){null==s&&(s=MAX_INT),null==n&&(n=this.humanity.tile(e));var a=n.c,l=this.keyFromTile(i),o={},p={},u={},c=[],y={},m=this.keyFromTile(e);for(y[m]=null,p[m]=0,c.push(m);c.length>0&&l!==m;){m=c.shift(),o[m]=!0;var f=this.humanity.tile(this.tileFromKey(m));if(!f||null==f.c||f.c===a)for(var h=0;6>h;h++){var T=this.neighborFromTile(this.tileFromKey(m),h),d=this.distance(T);if(!(d>t)){if(0>=s)return null;s--;var v=p[m]+d;if(!(r&&v>t)){var g=this.keyFromTile(T);if(void 0!==p[g]&&v<p[g]&&delete p[g],void 0===p[g]&&void 0===o[g]){p[g]=v,u[g]=v+(Math.abs(i.q-T.q)+Math.abs(i.r-T.r)+Math.abs(i.q+i.r-T.q-T.r))/2;for(var b=-1,D=0;D<c.length;D++)if(void 0!==u[c[D]]){if(u[g]<=u[c[D]]){b=D;break}}else c.splice(D,1),D--;-1===b?c.push(g):c.splice(b,0,g),y[g]=m}}}}}return l!==m?null:{endKey:l,parents:y,costs:p}},pathFromParents:function(e,i){var t=[];if(null==i[e])return[];for(;null!==i[e];)t.push(e),e=i[e];return t.push(e),t.reverse()},setDistancesForHuman:function(e){0!==(e.o&manufacture.plane)?this.distances=distancesPlane:0!==(e.o&manufacture.boat)&&(this.distances=distancesBoat)},unsetDistancesForHuman:function(){this.distances=distancesNormal},humanTravelFrom:function(e){var i=this.humanity.tile(e);if(!i||i.h<=0)return{};this.setDistancesForHuman(i);var t=this.travelFrom(e,this.speedFromHuman(i));return this.unsetDistancesForHuman(i),t},humanTravelTo:function(e,i,t,r,s){if(null==s&&(s=this.humanity.tile(e)),!s||s.h<=0)return null;this.setDistancesForHuman(s);var n=this.travelTo(e,i,this.speedFromHuman(s),t,r,s);return this.unsetDistancesForHuman(s),n},humanTravelPath:function(e,i){var t=this.humanTravelTo(e,i);return null==t?[]:this.pathFromParents(t.endKey,t.parents)},humanTravelSpeedPath:function(e,i){var t=this.humanTravelTo(e,i,!0);return null==t?[]:this.pathFromParents(t.endKey,t.parents)},buildingDependencies:buildingDependencies,buildingTileDependency:buildingTileDependency,validConstruction:function(e,i,t){if(null==e)return!0;var r=this.humanity.tile(i),s=this.tile(i),n=t.fuel-t.usedFuel,a=t.production-t.usedProduction,l=t.wealth-t.usedWealth;if(!r||r.h<=0)return!1;if(e===tileTypes.field)return this.commodity(i,s)>=0;if(s.type===tileTypes.water&&(e===tileTypes.farm||e===tileTypes.residence||e===tileTypes.skyscraper||e===tileTypes.factory||e===tileTypes.airland||e===tileTypes.airport||e===tileTypes.gunsmith))return!1;if(void 0!==buildingTileDependency[e]){for(var o=!1,p=0;p<buildingTileDependency[e].length;p++)(buildingTileDependency[e][p]===s.type||buildingTileDependency[e][p]===r.b)&&(o=!0);if(!o)return!1}if(void 0!==buildingDependencies[e]){for(var u=buildingDependencies[e],c=new Array(u.length),p=0;p<c.length;p++)c[p]=0;for(var p=0;6>p;p++)for(var y=this.neighborFromTile(i,p),m=this.humanity.tile(y),f=this.tile(y),h=0;h<u.length;h++)if(u[h][1]>=0&&m&&m.b===u[h][1]||f.type===u[h][1])c[h]++;else if(u[h][1]<0){if(u[h][1]===resourceTypes.fuel&&n<u[h][0])return!1;if(u[h][1]===resourceTypes.production&&a<u[h][0])return!1;if(u[h][1]===resourceTypes.wealth&&l<u[h][0])return!1;c[h]=u[h][0]}for(var h=0;h<c.length;h++)if(c[h]<u[h][0])return!1;return!0}return!0},planTypes:planTypes,plans:{},addPlan:function(e){plans[e.at]=e},eachPlan:function(e){for(var i in plans)e(plans[i])},clearPlans:function(){plans={}}},module.exports=Terrain;