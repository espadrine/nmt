function tileType(e,t){return t?tileVegetationTypeFromSteepness[e]:e}function heatmap(e,t,i,r,n){for(var s=0,a=0,o=0;n>o;o++){var l=Math.pow(2,o);s+=i.noise2D(e/r*l,t/r*l)/l,a+=1/l}return s/a}function Terrain(e){this.humanity=e,this.plans={}}!function(){function e(e){e||(e=Math.random),this.p=new Uint8Array(256),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var t=0;256>t;t++)this.p[t]=256*e();for(t=0;512>t;t++)this.perm[t]=this.p[255&t],this.permMod12[t]=this.perm[t]%12}var t=.5*(Math.sqrt(3)-1),i=(3-Math.sqrt(3))/6,r=1/3,n=1/6,s=(Math.sqrt(5)-1)/4,a=(5-Math.sqrt(5))/20;e.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(e,r){var n,s,a=this.permMod12,o=this.perm,l=this.grad3,h=0,p=0,u=0,m=(e+r)*t,f=Math.floor(e+m),c=Math.floor(r+m),y=(f+c)*i,d=f-y,T=c-y,v=e-d,M=r-T;v>M?(n=1,s=0):(n=0,s=1);var g=v-n+i,w=M-s+i,b=v-1+2*i,D=M-1+2*i,x=255&f,F=255&c,q=.5-v*v-M*M;if(q>=0){var _=3*a[x+o[F]];q*=q,h=q*q*(l[_]*v+l[_+1]*M)}var N=.5-g*g-w*w;if(N>=0){var A=3*a[x+n+o[F+s]];N*=N,p=N*N*(l[A]*g+l[A+1]*w)}var S=.5-b*b-D*D;if(S>=0){var P=3*a[x+1+o[F+1]];S*=S,u=S*S*(l[P]*b+l[P+1]*D)}return 70*(h+p+u)},noise3D:function(e,t,i){var s,a,o,l,h,p,u,m,f,c,y=this.permMod12,d=this.perm,T=this.grad3,v=(e+t+i)*r,M=Math.floor(e+v),g=Math.floor(t+v),w=Math.floor(i+v),b=(M+g+w)*n,D=M-b,x=g-b,F=w-b,q=e-D,_=t-x,N=i-F;q>=_?_>=N?(h=1,p=0,u=0,m=1,f=1,c=0):q>=N?(h=1,p=0,u=0,m=1,f=0,c=1):(h=0,p=0,u=1,m=1,f=0,c=1):N>_?(h=0,p=0,u=1,m=0,f=1,c=1):N>q?(h=0,p=1,u=0,m=0,f=1,c=1):(h=0,p=1,u=0,m=1,f=1,c=0);var A=q-h+n,S=_-p+n,P=N-u+n,K=q-m+2*n,k=_-f+2*n,R=N-c+2*n,H=q-1+3*n,E=_-1+3*n,L=N-1+3*n,W=255&M,O=255&g,U=255&w,V=.6-q*q-_*_-N*N;if(0>V)s=0;else{var I=3*y[W+d[O+d[U]]];V*=V,s=V*V*(T[I]*q+T[I+1]*_+T[I+2]*N)}var X=.6-A*A-S*S-P*P;if(0>X)a=0;else{var C=3*y[W+h+d[O+p+d[U+u]]];X*=X,a=X*X*(T[C]*A+T[C+1]*S+T[C+2]*P)}var B=.6-K*K-k*k-R*R;if(0>B)o=0;else{var z=3*y[W+m+d[O+f+d[U+c]]];B*=B,o=B*B*(T[z]*K+T[z+1]*k+T[z+2]*R)}var j=.6-H*H-E*E-L*L;if(0>j)l=0;else{var G=3*y[W+1+d[O+1+d[U+1]]];j*=j,l=j*j*(T[G]*H+T[G+1]*E+T[G+2]*L)}return 32*(s+a+o+l)},noise4D:function(e,t,i,r){var n,o,l,h,p,u=(this.permMod12,this.perm),m=this.grad4,f=(e+t+i+r)*s,c=Math.floor(e+f),y=Math.floor(t+f),d=Math.floor(i+f),T=Math.floor(r+f),v=(c+y+d+T)*a,M=c-v,g=y-v,w=d-v,b=T-v,D=e-M,x=t-g,F=i-w,q=r-b,_=0,N=0,A=0,S=0;D>x?_++:N++,D>F?_++:A++,D>q?_++:S++,x>F?N++:A++,x>q?N++:S++,F>q?A++:S++;var P,K,k,R,H,E,L,W,O,U,V,I;P=_>=3?1:0,K=N>=3?1:0,k=A>=3?1:0,R=S>=3?1:0,H=_>=2?1:0,E=N>=2?1:0,L=A>=2?1:0,W=S>=2?1:0,O=_>=1?1:0,U=N>=1?1:0,V=A>=1?1:0,I=S>=1?1:0;var X=D-P+a,C=x-K+a,B=F-k+a,z=q-R+a,j=D-H+2*a,G=x-E+2*a,J=F-L+2*a,Q=q-W+2*a,Y=D-O+3*a,Z=x-U+3*a,$=F-V+3*a,et=q-I+3*a,tt=D-1+4*a,it=x-1+4*a,rt=F-1+4*a,nt=q-1+4*a,st=255&c,at=255&y,ot=255&d,lt=255&T,ht=.6-D*D-x*x-F*F-q*q;if(0>ht)n=0;else{var pt=u[st+u[at+u[ot+u[lt]]]]%32*4;ht*=ht,n=ht*ht*(m[pt]*D+m[pt+1]*x+m[pt+2]*F+m[pt+3]*q)}var ut=.6-X*X-C*C-B*B-z*z;if(0>ut)o=0;else{var mt=u[st+P+u[at+K+u[ot+k+u[lt+R]]]]%32*4;ut*=ut,o=ut*ut*(m[mt]*X+m[mt+1]*C+m[mt+2]*B+m[mt+3]*z)}var ft=.6-j*j-G*G-J*J-Q*Q;if(0>ft)l=0;else{var ct=u[st+H+u[at+E+u[ot+L+u[lt+W]]]]%32*4;ft*=ft,l=ft*ft*(m[ct]*j+m[ct+1]*G+m[ct+2]*J+m[ct+3]*Q)}var yt=.6-Y*Y-Z*Z-$*$-et*et;if(0>yt)h=0;else{var dt=u[st+O+u[at+U+u[ot+V+u[lt+I]]]]%32*4;yt*=yt,h=yt*yt*(m[dt]*Y+m[dt+1]*Z+m[dt+2]*$+m[dt+3]*et)}var Tt=.6-tt*tt-it*it-rt*rt-nt*nt;if(0>Tt)p=0;else{var vt=u[st+1+u[at+1+u[ot+1+u[lt+1]]]]%32*4;Tt*=Tt,p=Tt*Tt*(m[vt]*tt+m[vt+1]*it+m[vt+2]*rt+m[vt+3]*nt)}return 27*(n+o+l+h+p)}},"undefined"!=typeof define&&define.amd&&define(function(){return e}),"undefined"!=typeof exports?exports.SimplexNoise=e:"undefined"!=typeof navigator&&(this.SimplexNoise=e),"undefined"!=typeof module&&(module.exports=e)}();var MersenneTwister=function(e){void 0==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,this.init_genrand(e)};MersenneTwister.prototype.init_genrand=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++){var e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0}},MersenneTwister.prototype.init_by_array=function(e,t){var i,r,n;for(this.init_genrand(19650218),i=1,r=0,n=this.N>t?this.N:t;n;n--){var s=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&s)>>>16)<<16)+1664525*(65535&s))+e[r]+r,this.mt[i]>>>=0,i++,r++,i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),r>=t&&(r=0)}for(n=this.N-1;n;n--){var s=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1566083941*((4294901760&s)>>>16)<<16)+1566083941*(65535&s))-i,this.mt[i]>>>=0,i++,i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1)}this.mt[0]=2147483648},MersenneTwister.prototype.genrand_int32=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_genrand(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,e^=e>>>18,e>>>0},MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>>1},MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967295)},MersenneTwister.prototype.random=function(){return this.genrand_int32()*(1/4294967296)},MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)},MersenneTwister.prototype.genrand_res53=function(){var e=this.genrand_int32()>>>5,t=this.genrand_int32()>>>6;return(67108864*e+t)*(1/9007199254740992)};var prng=new MersenneTwister(0),simplex1=new SimplexNoise(prng.random.bind(prng)),simplex2=new SimplexNoise(prng.random.bind(prng)),factor=50,tileTypes={water:0,steppe:1,hill:2,mountain:3,swamp:4,meadow:5,forest:6,taiga:7,farm:8,residence:9,skyscraper:10,factory:11,dock:12,airland:13,airport:14,gunsmith:15,road:16,wall:17,blackdeath:18,metal:19,lumber:20,mine:21,industry:22,citrus:23,university:24,beach:25,arsenal:26},buildingTypes=[8,9,10,11,12,13,14,15,16,17,20,21,22,24,26],resourceTypes={lumber:-1,metal:-2,wealth:-3},listOfResourceTypes=[resourceTypes.lumber,resourceTypes.metal,resourceTypes.wealth],tileVegetationTypeFromSteepness=[];tileVegetationTypeFromSteepness[tileTypes.water]=tileTypes.swamp,tileVegetationTypeFromSteepness[tileTypes.steppe]=tileTypes.meadow,tileVegetationTypeFromSteepness[tileTypes.hill]=tileTypes.forest,tileVegetationTypeFromSteepness[tileTypes.mountain]=tileTypes.taiga;var distances=[];distances[tileTypes.water]=2989,distances[tileTypes.steppe]=2,distances[tileTypes.hill]=4,distances[tileTypes.mountain]=16,distances[tileTypes.swamp]=8,distances[tileTypes.meadow]=3,distances[tileTypes.forest]=8,distances[tileTypes.taiga]=24,distances[tileTypes.road]=1,distances[tileTypes.wall]=32;var normalWater=distances[tileTypes.water],normalSwamp=distances[tileTypes.swamp],MAX_INT=9007199254740992,manufacture={boat:1,car:2,plane:4,artillery:8,gun:16},buildingDependencies=[,,,,,,,,,[[2,tileTypes.farm]],[[6,tileTypes.residence]],[[3,tileTypes.residence],[2,tileTypes.road]],[[1,tileTypes.residence],[1,tileTypes.water],[1,resourceTypes.lumber]],[[2,tileTypes.road]],[[1,tileTypes.gunsmith],[3,tileTypes.airland],[1,resourceTypes.lumber]],[[1,tileTypes.skyscraper],[1,tileTypes.factory]],,,,,[[1,tileTypes.residence]],[[1,resourceTypes.lumber],[1,tileTypes.factory]],[[10,resourceTypes.wealth],[1,tileTypes.mine],[5,tileTypes.road]],,[[1,resourceTypes.metal],[20,resourceTypes.wealth],[2,tileTypes.wall]],,[[1,tileTypes.gunsmith],[1,resourceTypes.metal]]],buildingTileDependency=[,,,,,,,,,,,,,,,,,,,,[tileTypes.forest,tileTypes.taiga],[tileTypes.metal],,,[tileTypes.citrus],[tileTypes.steppe]],planTypes={move:1,build:2};Terrain.prototype={humanity:null,centerTile:{q:0,r:0},centerPoint:{x:0,y:0},tileTypes:tileTypes,buildingTypes:buildingTypes,resourceTypes:resourceTypes,listOfResourceTypes:listOfResourceTypes,tileType:tileType,heatmap:heatmap,setCenterTile:function(e){this.centerTile=e,this.centerPoint.x=Math.sqrt(3)*(e.q+e.r/2)|0,this.centerPoint.y=1.5*e.r},continent:function(e,t){var i=2500,r=heatmap(e,t,simplex1,.6*i,8),n=this.centerPoint,s=(e-n.x)*(e-n.x)+(t-n.y)*(t-n.y),a=300;return r=(r+1)/2,r=r*Math.exp(-s/(i*i))+r*Math.exp(-s/(a*a)),r=Math.min(1,r)},continentLimit:.42,tile:function e(t){var i,r;void 0===t.x?(i=Math.sqrt(3)*(t.q+t.r/2)|0,r=1.5*t.r):(i=t.x,r=t.y);var n=simplex2.noise2D(r/500,i/500),s=1-Math.abs((4*simplex1.noise2D(i/4/factor,r/4/factor)+2*simplex1.noise2D(i/2/factor,r/2/factor)+1*simplex1.noise2D(i/1/factor,r/1/factor)+.5*simplex1.noise2D(2*i/factor,2*r/factor))/7.5),a=Math.sin(-(5*n)*Math.abs(simplex1.noise2D(.25*i/factor,.25*r/factor))+simplex1.noise2D(i/factor,r/factor)-.5*simplex1.noise2D(2*i/factor,2*r/factor)+.25*simplex1.noise2D(4*i/factor,4*r/factor)-1/8*simplex1.noise2D(8*i/factor,8*r/factor)+1/16*simplex1.noise2D(16*i/factor,16*r/factor)),o=-simplex2.noise2D(r/factor/8,i/factor/8)+simplex2.noise2D(r/factor/4,i/factor/4)+a/2,l=n*simplex2.noise2D(i/factor,r/factor)+.5*simplex2.noise2D(2*i/factor,2*r/factor)+.25*simplex2.noise2D(4*i/factor,4*r/factor)+1/8*simplex2.noise2D(8*i/factor,8*r/factor)+1/16*simplex2.noise2D(16*i/factor,16*r/factor),h=a-s,p=this.continent(i,r);if(p>this.continentLimit)var u,m=-1.3,f=(a>.6?!1:s>.98)||-.7>3*o/4+a/4?(u=(-1.5-m)/(this.continentLimit-1),h=p*u+m-u,tileTypes.water):-1>l?tileTypes.hill:-.2>h?tileTypes.steppe:.2>h?tileTypes.hill:tileTypes.mountain,c=l-(f===tileTypes.water?2*o:0)+Math.abs(a+.15)<0;else{var f=tileTypes.water,c=!1,y=p-1.92;h=y}var e={steepness:f,vegetation:c,type:this.tileType(f,c),height:h,rain:-l/2};return e},distances:distances,distance:function(e){var t=this.tile(e),i=this.humanity.tile(e),r=distances[i&&i.b?i.b:t.type];return void 0===r&&(r=distances[t.type]),r},distanceBetweenTiles:function(e,t){return(Math.abs(e.q-t.q)+Math.abs(e.r-t.r)+Math.abs(e.q+e.r-t.q-t.r))/2},neighborFromTile:function(e,t){return 0===t?{q:e.q+1,r:e.r}:1===t?{q:e.q+1,r:e.r-1}:2===t?{q:e.q,r:e.r-1}:3===t?{q:e.q-1,r:e.r}:4===t?{q:e.q-1,r:e.r+1}:5===t?{q:e.q,r:e.r+1}:void 0},keyFromTile:function(e){return e.q+":"+e.r},tileFromKey:function(e){var t=e.split(":");return{q:0|t[0],r:0|t[1]}},manufacture:manufacture,manufactureFromBuilding:function(e){return e===tileTypes.dock?manufacture.boat:e===tileTypes.factory?manufacture.car:e===tileTypes.airport?manufacture.plane:e===tileTypes.gunsmith?manufacture.gun:null},speedFromHuman:function(e){return 0!==(e.o&manufacture.plane)?32:0!==(e.o&manufacture.car)?16:8},travelFrom:function(e,t){var i=this.humanity.tile(e).c,r={},n=this.keyFromTile(e);r[n]=null;var s={};s[n]=0;var a=[];for(a.push(n);a.length>0;){n=a.shift();var o=this.humanity.tile(this.tileFromKey(n));if(!o||null==o.c||o.c===i)for(var l=0;6>l;l++){var h=this.neighborFromTile(this.tileFromKey(n),l),p=s[n]+this.distance(h);if(t>=p){var u=this.keyFromTile(h);if(void 0!==s[u]&&p<s[u]&&delete s[u],void 0===s[u]&&void 0===r[u]){s[u]=p,r[u]=n;for(var m=-1,f=0;f<a.length;f++)if(void 0!==s[a[f]]){if(s[u]<=s[a[f]]){m=f;break}}else a.splice(f,1),f--;-1===m?a.push(u):a.splice(m,0,u)}}}}return r},travelTo:function(e,t,i,r,n,s){null==n&&(n=MAX_INT),null==s&&(s=this.humanity.tile(e));var a=s.c,o=this.keyFromTile(t),l={},h={},p={},u=[],m={},f=this.keyFromTile(e);for(m[f]=null,h[f]=0,u.push(f);u.length>0&&o!==f;){f=u.shift(),l[f]=!0;var c=this.humanity.tile(this.tileFromKey(f));if(!c||null==c.c||c.c===a)for(var y=0;6>y;y++){var d=this.neighborFromTile(this.tileFromKey(f),y),T=this.distance(d);if(!(T>i)){if(0>=n)return null;n--;var v=h[f]+T;if(!(r&&v>i)){var M=this.keyFromTile(d);if(void 0!==h[M]&&v<h[M]&&delete h[M],void 0===h[M]&&void 0===l[M]){h[M]=v,p[M]=v+(Math.abs(t.q-d.q)+Math.abs(t.r-d.r)+Math.abs(t.q+t.r-d.q-d.r))/2;for(var g=-1,w=0;w<u.length;w++)if(void 0!==p[u[w]]){if(p[M]<=p[u[w]]){g=w;break}}else u.splice(w,1),w--;-1===g?u.push(M):u.splice(g,0,M),m[M]=f}}}}}return o!==f?null:{endKey:o,parents:m,costs:h}},pathFromParents:function(e,t){var i=[];if(null==t[e])return[];for(;null!==t[e];)i.push(e),e=t[e];return i.push(e),i.reverse()},setDistancesForHuman:function(e){0!==(e.o&manufacture.boat)?(this.distances[tileTypes.water]=1,this.distances[tileTypes.swamp]=1):0!==(e.o&manufacture.plane)&&(this.distances[tileTypes.water]=2,this.distances[tileTypes.swamp]=2)},unsetDistancesForHuman:function(){this.distances[tileTypes.water]=normalWater,this.distances[tileTypes.swamp]=normalSwamp},humanTravelFrom:function(e){var t=this.humanity.tile(e);if(!t||t.h<=0)return{};this.setDistancesForHuman(t);var i=this.travelFrom(e,this.speedFromHuman(t));return this.unsetDistancesForHuman(t),i},humanTravelTo:function(e,t,i,r,n){if(null==n&&(n=this.humanity.tile(e)),!n||n.h<=0)return null;this.setDistancesForHuman(n);var s=this.travelTo(e,t,this.speedFromHuman(n),i,r,n);return this.unsetDistancesForHuman(n),s},humanTravelPath:function(e,t){var i=this.humanTravelTo(e,t);return null==i?[]:this.pathFromParents(i.endKey,i.parents)},humanTravelSpeedPath:function(e,t){var i=this.humanTravelTo(e,t,!0);return null==i?[]:this.pathFromParents(i.endKey,i.parents)},buildingDependencies:buildingDependencies,buildingTileDependency:buildingTileDependency,validConstruction:function(e,t,i){if(null==e)return!0;var r=this.humanity.tile(t),n=this.tile(t),s=i.lumber-i.usedLumber,a=i.metal-i.usedMetal,o=i.wealth-i.usedWealth;if(!r||r.h<=0)return!1;if(n.type===tileTypes.water&&(e===tileTypes.farm||e===tileTypes.residence||e===tileTypes.skyscraper||e===tileTypes.factory||e===tileTypes.airland||e===tileTypes.airport||e===tileTypes.gunsmith))return!1;if(void 0!==buildingTileDependency[e]){for(var l=!1,h=0;h<buildingTileDependency[e].length;h++)(buildingTileDependency[e][h]===n.type||buildingTileDependency[e][h]===r.b)&&(l=!0);if(!l)return!1}if(void 0!==buildingDependencies[e]){for(var p=buildingDependencies[e],u=new Array(p.length),h=0;h<u.length;h++)u[h]=0;for(var h=0;6>h;h++)for(var m=this.neighborFromTile(t,h),f=this.humanity.tile(m),c=this.tile(m),y=0;y<p.length;y++)if(p[y][1]>=0&&f&&f.b===p[y][1]||c.type===p[y][1])u[y]++;else if(p[y][1]<0){if(p[y][1]===resourceTypes.lumber&&s<p[y][0])return!1;if(p[y][1]===resourceTypes.metal&&a<p[y][0])return!1;if(p[y][1]===resourceTypes.wealth&&o<p[y][0])return!1;u[y]=p[y][0]}for(var y=0;y<u.length;y++)if(u[y]<p[y][0])return!1;return!0}return!0},planTypes:planTypes,plans:{},addPlan:function(e){plans[e.at]=e},eachPlan:function(e){for(var t in plans)e(plans[t])},clearPlans:function(){plans={}}};var terrain=new Terrain;!function(e){function t(e,t){var i=(y.noise2D(e/v/5,t/v/5),Math.sin(+y.noise2D(e/v,t/v)+.5*y.noise2D(e/v/2,t/v/2))/2+Math.sin(+y.noise2D(e/v/4,t/v/4))/2),i=Math.sin(+y.noise2D(e/v,t/v)+.5*y.noise2D(e/v*2,t/v*2)+.25*y.noise2D(e/v*4,t/v*4)+1/8*y.noise2D(e/v*8,t/v*8));return i}function i(e,t){var i=(d.noise2D(e/v/5,t/v/5),Math.sin(+d.noise2D(e/v,t/v)+.5*d.noise2D(e/v/2,t/v/2))/2+Math.sin(+d.noise2D(e/v/4,t/v/4))/2);return i}function r(e,t,i){return(e/2+1)*(i-t)+t}function n(e,t,i){for(var r=2,n=-r/2+1.9,s=n*i,a=n/i,o=0,l=0,h=0;r>h;h++){var p=Math.pow(3,h+2.5);l+=y.noise2D(e/p/s,t/p/a)*p,o+=p}return l/o}function s(e,t,i){for(var r=6,n=4,s=n*i,a=n/i,o=0,l=0,h=0;r>h;h++){var p=Math.pow(2,h);l+=d.noise2D(e/p/s,t/p/a)*p,o+=p}return 1.4*(1-2*Math.abs(l/o))}function a(e,t,i,r){if(0>=r)return-1;var n=(r-1)*e+i-1;return n}function o(e,t,i,r){if(i+1>=e)return-1;var n=r*e+i+1;return n}function l(e,t,i,r){if(r>t)return-1;var n=(r+1)*e+i+1;return n}function h(e,t,i,r){if(0>=i)return-1;var n=r*e+i-1;return n}function p(e,t,i,r){for(var n=new Float32Array(r),s=.5,p=new Float32Array(r),u=0,m=0,f=0;r>f;f++)n[f]=s,p[f]=0;for(var c=0;2e3>c;c++){for(var f=Math.random()*r|0,y=[],d=[],T=!0,v=Math.random(),M=0;40>M;M++){var g=e[f]+p[f]+n[f],w=g,b=g,D=f,x=f,u=f%t,m=f/t|0,F=a(t,i,u,m);if(F>=0){var q=e[F]+p[F]+n[F];q>w&&(D=F,w=q),b>q&&(x=F,b=q)}var _=o(t,i,u,m);if(_>=0){var q=e[_]+p[_]+n[_];q>w&&(D=_,w=q),b>q&&(x=_,b=q)}var N=l(t,i,u,m);if(N>=0){var q=e[N]+p[N]+n[N];q>w&&(D=N,w=q),b>q&&(x=N,b=q)}var A=h(t,i,u,m);if(A>=0){var q=e[A]+p[A]+n[A];q>w&&(D=A,w=q),b>q&&(x=A,b=q)}var S=[F,N,_,A].sort(function(t,i){return e[i]-e[t]}),P=Math.random(),K=.9;if(v>.4&&(K=1-K),D=P>K?S[0]:S[1],x=P>K?S[3]:S[2],v>.4){var k=D;D=x,x=k}var P=Math.random(),R=.25>P?F:.5>P?_:.75>P?N:A;y.push(Math.random()>.5?f:R);var H=T?x:D;d.push(T?-.002:.004),f===H?(f=T?D:x,T=!T):f=H}for(var f=0;f<y.length;f++)e[y[f]]+=d[f]}}function u(e){var t=e.q,i=e.r,r=-t-i,n=Math.round(t),s=Math.round(r),a=Math.round(i),o=Math.abs(n-t),l=Math.abs(s-r),h=Math.abs(a-i);return o>l&&o>h?n=-s-a:l>h?s=-n-a:a=-n-s,{q:n,r:a}}function m(e,t,i){var r=e.x+t.x0,n=e.y+t.y0;return u({q:(Math.sqrt(3)*r-n)/3/i,r:2*n/3/i})}function f(e,t,i,r,a,o){for(var l=a*o,h=a/o,u=new Float32Array(l),f=t*Math.sqrt(3),c=3*t/2,y=i/f,d=r/c,T=a/y,v=o/d,w=i/a,b=r/o,D={x:0,y:0},x=2*T,F=2*v,q=0,_=0,N=[],A=[],S=0,P=0,K=0,k=0;l>k;k++){0===q&&0===_&&(0===P&&(N=[],A=[]),D.x=P*w,D.y=K*b,N[S]=terrain.tile(m(D,e,t)).steepness,D.x=(P+x)*w,D.y=K*b,N[S+1]=terrain.tile(m(D,e,t)).steepness,D.x=P*w,D.y=(K+F)*b,A[S]=terrain.tile(m(D,e,t)).steepness,D.x=(P+x)*w,D.y=(K+F)*b,A[S+1]=terrain.tile(m(D,e,t)).steepness);var R=(M[N[S]]*(1-q)+M[N[S+1]]*q)*(1-_)+(M[A[S]]*(1-q)+M[A[S+1]]*q)*_,H=(g[N[S]]*(1-q)+g[N[S+1]]*q)*(1-_)+(g[A[S]]*(1-q)+g[A[S+1]]*q)*_,E=e.x0+P,L=e.y0+K;if(H>g[tileTypes.hill]){var W=(H-g[tileTypes.hill])/(g[tileTypes.mountain]-g[tileTypes.hill]),O=n(E,L,h);u[k]=(O*H+R)*(1-W)+((s(E,L,h)+O)/2*H+R)*W}else u[k]=n(E,L,h)*H+R;q+=1/x,q>=1&&(q=0,S+=1),P++,P>a&&(P=0,K++,S=0,q=0,_+=1/F,_>=1&&(_=0))}return p(u,a,o,l),u}var c=new MersenneTwister(0),y=new SimplexNoise(c.random.bind(c)),d=new SimplexNoise(c.random.bind(c)),T=new SimplexNoise(c.random.bind(c)),v=120;e.texture=function(e){for(var n=e.data,s=e.width*e.height*4|0,a=0,o=0,l=0;s>l;l+=4){var h=t(a,o),p=i(a,o),u=r(h,120,150),m=r(p,70,u+25),f=10*Math.random()|0;n[l+0]=u+10*(2*Math.random()-1)|0,n[l+1]=m+10*(2*Math.random()-1)|0,n[l+2]=0|f,n[l+3]=255;var c=T.noise2D(a,o),y=.5;if(c>y){c=1*(c-y)/(1-y);var d=5;if(u=u+12*(2*Math.random()-1)|0,m=m+12*(2*Math.random()-1)|0,c>.6)for(var v=1;d>v;v++)n[l+0-4*(e.width+1)*v]=u,n[l+1-4*(e.width+1)*v]=m,n[l+2-4*(e.width+1)*v]=f;else if(c>.3)for(var v=1;d>v;v++)n[l+0-4*e.width*v]=u,n[l+1-4*e.width*v]=m,n[l+2-4*e.width*v]=f;else for(var v=1;d>v;v++)n[l+0-4*(e.width-1)*v]=u,n[l+1-4*(e.width-1)*v]=m,n[l+2-4*(e.width-1)*v]=f}a++,a>=e.width&&(a=0,o++)}};var M={};M[tileTypes.water]=-.2,M[tileTypes.steppe]=0,M[tileTypes.hill]=0,M[tileTypes.mountain]=0;var g={};g[tileTypes.water]=0,g[tileTypes.steppe]=.2,g[tileTypes.hill]=.5,g[tileTypes.mountain]=1,e.contextHeightMap=f}(this),onmessage=function(e){if(e.data.centerTile)return terrain.setCenterTile(e.data.centerTile),void 0;var t=e.data.hexSize,i=e.data.origin,r=e.data.canvasWidth,n=e.data.canvasHeight;postMessage({heightmap:contextHeightMap(i,t,r,n,e.data.width,e.data.height),texture:e.data.textureImage})};