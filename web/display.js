function tileType(e,t){return t?tileVegetationTypeFromSteepness[e]:e}function heatmap(e,t,i,r,n){for(var a=0,o=0,s=0;n>s;s++){var l=Math.pow(2,s);a+=i.noise2D(e/r*l,t/r*l)/l,o+=1/l}return a/o}function Terrain(e){this.humanity=e,this.plans={}}function connectSocket(e){e=e||function(){},socket=new WebSocket("ws"+window.location.protocol.slice(4)+"//"+window.location.hostname+(window.location.port.length>0?":"+window.location.port:"")+"/$websocket:act"),socket.onmessage=socketMessage,socket.onclose=socket.onerror=socketError,socket.onopen=function(){retries=0,e()}}function socketMessage(e){var t=JSON.parse(e.data);t.winners?(gameOver={},gameOver.winners=t.winners,gameOver.winType=t.winType,gameOver.winners[0]===playerCamp&&(localStorage.getItem("gamesWon")||localStorage.setItem("gamesWon",0),localStorage.setItem("gamesWon",+localStorage.getItem("gamesWon")+1))):(void 0!==t.camp&&(playerCamp=t.camp,delete t.camp),void 0!==t.lockedTiles&&(lockedTiles=t.lockedTiles,delete t.lockedTiles),void 0!==t.resources&&(campResources=t.resources,resources=t.resources[playerCamp],delete t.resources),void 0!==t.population&&(humanityPopulation=t.population,delete t.population),void 0!==t.war&&(addHumanMessages(warTiles,t.war,warMessages),delete t.war),void 0!==t.surrender&&(addHumanMessages(surrenderTiles,t.surrender,surrenderMessages),delete t.surrender),void 0!==t.artilleryFire&&(addShells(movementAnimations,t.artilleryFire),delete t.artilleryFire),void 0!==t.goto&&(gotoPlace(t.goto),delete t.goto),void 0!==t.centerTile&&(terrain.setCenterTile(t.centerTile),sendCenterTile(t.centerTile),delete t.centerTile),void 0!==t.places&&(insertPlaces(t.places),fillMapIndex(t.places),delete t.places),void 0!==t.campNames&&(campNames=t.campNames,delete t.campNames),humanityPopulation&&setResourcesTable(),addStarveMessages(t),changeHumanity(humanityData,t),paintPopulation(),updateCurrentTileInformation(),updateCachedPaint(gs,t)),paint(gs),paintHumans(gs,humanityData)}function socketError(){retries++,1>retries?setTimeout(connectSocket,50):1===retries&&alert("You are disconnected.\nPlease reload the page.")}function sendMove(e,t,i){if(e&&t){var r=terrain.keyFromTile(t);if(registerMoves[r]=e,1===socket.readyState){var n=terrain.keyFromTile(e),a=layRoadBox.checked?terrain.tileTypes.road:terrain.tileTypes.wall;socket.send(JSON.stringify({at:n,"do":planTypes.move,to:r,h:i,lay:a}))}else connectSocket(function(){sendMove(e,t,i)})}}function sendPos(e,t){socket.send(JSON.stringify({at:e?terrain.keyFromTile(e):null,to:terrain.keyFromTile(t)}))}function sendBuild(e,t){if(e){var i=terrain.keyFromTile(e);registerBuilds[i]=t,1===socket.readyState?socket.send(JSON.stringify({at:i,"do":planTypes.build,b:t})):connectSocket(function(){sendBuild(e,t)})}}function insertPlaces(e){placesPanel.innerHTML=defaultPlacesPanelHTML;for(var t in e){var i=document.createElement("p");i.classList.add("buildSelection"),i.classList.add("validSelection");var r=document.createElement("hr");r.classList.add("separator"),placesPanel.appendChild(r);var n=terrain.tileFromKey(t);i.setAttribute("data-tilekey",t),i.innerHTML='<div style="position:absolute;">→</div> <br>'+e[t],i.addEventListener("click",function(e){return function(){gotoPlace(e),paint(gs)}}(n)),placesPanel.appendChild(i)}}function setResourcesTable(){for(var e="<th></th>",t=0;numberOfCamps>t;t++)e+='<th style="color:'+campHsl(t)+'">■</th>';e="<tr>"+e+"</tr>";var i="";["Folks","Wealth","Stock","Production","Health"].forEach(function(e){var t="",r=e;"Production"===r&&(r="Product"),t+="<th>"+r+"</th>";for(var n=0;numberOfCamps>n;n++){var a=resourceFromName[e](n);t+="<td>"+a+"</td>"}t='<tr class="'+e+'">'+t+"</tr>",i+=t});var r="<thead>"+e+"<thead>",n="<tbody>"+i+"<tbody>",a="<table>"+r+n+"</table>";resourcesPanel.innerHTML=a}function displayTravelInfo(e,t){var i=terrain.tile(e),r=terrain.tile(t),n=humanity.tile(e),a=humanity.tile(t),o=travelingNumber(n.h),s="";if(null!=a&&null!=a.c&&a.c!=n.c){var l=[];s+='<dl class="attack-info">';var c=attackForce(o,n,a,i,r,l);s+="<dt>Attack "+c+"</dt><dd>";for(var u=0;u<l.length;u++)s+=l[u]+"<br>";l=[];var d=defenseForce(a.h,n,a,i,r,l),h=c/d;s+=1>=h?"Lose all":"Lose "+(1/h*o|0),s+="</dd>",s+="<dt>Defense "+d+"</dt><dd>";for(var u=0;u<l.length;u++)s+=l[u]+"<br>";if(h>1){s+="Lose all";var m=surrender(t,n.c),p=m/6*a.h|0;p>0&&(s+="<br>Surrender "+p)}else s+="Lose "+(h*a.h|0);s+="</dd>",travelInfo.innerHTML=s}else travelInfo.innerHTML=""}function vehicleBonus(e,t,i,r){var n=1;return 0!==(e&terrain.manufacture.gun)&&(n*=2,r.push("2x guns")),0!==(e&terrain.manufacture.car)&&(0!==(t&terrain.manufacture.artillery)&&(n*=1.5,r.push("1.5x car vs. artillery")),0!==(t&terrain.manufacture.plane)&&(n*=.5,r.push("0.5x car vs. plane")),i===terrain.tileTypes.steppe&&(n*=1.5,r.push("1.5x flat terrain drive"))),0!==(e&terrain.manufacture.boat)&&(0!==(t&terrain.manufacture.car)&&(n*=1.5,r.push("1.5x boat vs. car")),0!==(t&terrain.manufacture.artillery)&&(n*=1.5,r.push("1.5x boat vs. artillery")),0!==(t&terrain.manufacture.plane)&&(n*=.5,r.push("0.5x boat vs. plane")),i===terrain.tileTypes.water&&(n*=1.5,r.push("1.5x battleship"))),0!==(e&terrain.manufacture.artillery)&&(0!==(t&terrain.manufacture.car)&&(n*=1.5,r.push("1.5x artillery vs. car")),0!==(t&terrain.manufacture.boat)&&(n*=.5,r.push("0.5x artillery vs. boat")),i===terrain.tileTypes.hill&&(n*=1.5,r.push("1.5x hill ballistics"))),0!==(e&terrain.manufacture.plane)&&(0!==(t&terrain.manufacture.car)&&(n*=1.5,r.push("1.5x plane vs. car")),0!==(t&terrain.manufacture.artillery)&&(n*=1.5,r.push("1.5x plane vs. artillery")),0!==(t&terrain.manufacture.boat)&&(n*=.5,r.push("0.5x plane vs. boat")),i===terrain.tileTypes.mountain&&(n*=1.5,r.push("1.5x mountain air strike"))),n}function attackForce(e,t,i,r,n,a){return e*=vehicleBonus(t.o,i.o,r.steepness,a),r.steepness>n.steepness&&(e*=1.5,a.push("1.5x high ground")),e}function defenseForce(e,t,i,r,n,a){return e*=vehicleBonus(i.o,0,n.steepness,a),n.vegetation&&(e*=1.5,a.push("1.5x vegetation cover")),e}function surrender(e,t){for(var i=0,r=0;6>r;r++){var n=humanity.tile(terrain.neighborFromTile(e,r));n&&n.c===t&&i++}return i}function gotoPlace(e){var t=pixelFromTile(e,{x0:0,y0:0},gs.hexSize);gs.origin.x0=t.x-(gs.width/2|0),gs.origin.y0=t.y-(gs.height/2|0)}function orientPlacesArrow(){for(var e=1;e<placesPanel.childNodes.length;e++){var t=placesPanel.childNodes[e];if(t.getAttribute&&null!=t.getAttribute("data-tilekey")){var i={x:gs.origin.x0+(gs.width/2|0),y:gs.origin.y0+(gs.height/2|0)},r=pixelFromTile(terrain.tileFromKey(t.getAttribute("data-tilekey")),{x0:0,y0:0},gs.hexSize),n=-orientation(i,r),a=t.firstChild;a.style.transform="rotate("+n+"rad)",a.style.WebkitTransform="rotate("+n+"rad)",a.nextSibling.textContent=kmDistance(i,r).toFixed(2)+"km"}}}function orientation(e,t){var i=Math.atan((e.y-t.y)/Math.abs(t.x-e.x));return t.x<e.x&&(i=Math.PI-i),i}function pixelDistance(e,t){var i=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y);return Math.sqrt(i*i+r*r)}function kmDistance(e,t){return pixelDistance(e,t)/gs.hexSize*.025}function campResourcePopulation(e){return humanityPopulation[e]}function campResourceWealth(e){var t=campResources[e];return t.wealth-t.usedWealth}function campResourceStock(e){var t=campResources[e];return t.stock-t.usedStock}function campResourceProduction(e){var t=campResources[e];return t.production-t.usedProduction}function campResourceHealth(e){var t=campResources[e];return t.health-t.usedHealth}function changeHumanity(e,t){for(var i in t)e[i]=t[i],delete registerMoves[i],delete registerBuilds[i]}function showHelp(e){helpPane.src="help/"+e+".html",helpPane.onload=function(){helpPane.style.display="block",helpPane.style.height=helpPane.contentWindow.document.body.clientHeight+40+"px",addEventListener("click",hideHelp)}}function hideHelp(){helpPane.style.display="none",removeEventListener("click",hideHelp)}function intPointFromReal(e){var t=e.q,i=e.r,r=-t-i,n=Math.round(t),a=Math.round(r),o=Math.round(i),s=Math.abs(n-t),l=Math.abs(a-r),c=Math.abs(o-i);return s>l&&s>c?n=-a-o:l>c?a=-n-o:o=-n-a,{q:n,r:o}}function tileFromPixel(e,t,i){var r=e.x+t.x0,n=e.y+t.y0;return intPointFromReal({q:(Math.sqrt(3)*r-n)/3/i,r:2*n/3/i})}function pixelFromTile(e,t,i){return{x:(i*Math.sqrt(3)*(e.q+e.r/2)|0)-t.x0,y:3*i/2*e.r-t.y0}}function noisyPixel(e,t){var i=terrain.tile(t),r={x:0,y:0};return r.x+=(t.q^t.r^(128*i.rain|0))%e,r.y+=(t.q^t.r^(256*i.rain|0))%e,r}function loadSprites(e){var t=new Image;return t.src=e,t}function makeGraphicState(e,t){var i=e.getContext("2d"),r=20;return{hexSize:r,origin:{x0:0,y0:0},canvas:e,ctx:i,width:e.width,height:e.height,sprites:t,spritesWidth:t.width}}function pathAlongTiles(e,t){var i=e.ctx,r=e.hexSize,n=e.origin;if(i.beginPath(),!(t.length<2)){{var a,o=pixelFromTile(terrain.tileFromKey(t[0]),n,r);0|o.x,0|o.y}i.moveTo(0|o.x,0|o.y);for(var s=0;s<t.length-1;s++){cpNext=pixelFromTile(terrain.tileFromKey(t[s+1]),n,r);var l=averagePoint(o,cpNext);i.quadraticCurveTo(0|o.x,0|o.y,0|l.x,0|l.y),s===t.length-2&&(a=o),o=cpNext}o=pixelFromTile(terrain.tileFromKey(t[t.length-1]),n,r);var c=(a.x-o.x)/10,u=(a.y-o.y)/10;i.lineTo(o.x+c,o.y+u),i.lineTo(o.x+c-2*u/3,o.y+u+2*c/3),i.lineTo(o.x,o.y),i.lineTo(o.x+c+2*u/3,o.y+u-2*c/3),i.lineTo(o.x+c,o.y+u)}}function paintAlongTiles(e,t){{var i=e.ctx;e.hexSize,e.origin}pathAlongTiles(e,t),i.strokeStyle="#ccf",i.lineWidth="5",i.stroke(),i.strokeStyle="red",i.lineWidth="3",i.stroke(),i.lineWidth="1"}function straightPathFromTiles(e,t,i,r){var n=e.ctx,a=e.hexSize,o=e.origin;n.beginPath();for(var s in t){for(var l=terrain.tileFromKey(s),c=pixelFromTile(l,o,a),u=(c.x,c.y,0),d=0;6>d;d++){var h=terrain.neighborFromTile(l,d);u|=(void 0!==t[terrain.keyFromTile(h)]|0)<<d}partialPathFromHex(e,c,u,i,r)}}function pathFromTiles(e,t,i,r,n,a){var o=e.ctx,s=e.hexSize,l=e.origin;o.beginPath();var c=[];for(var u in t)for(var d=terrain.tileFromKey(u),h=(pixelFromTile(d,l,s),0);6>h;h++){var m=terrain.neighborFromTile(d,h);void 0===t[terrain.keyFromTile(m)]&&(c=c.concat(vertexFromFace(u,h)))}pathFromPolygons(e,polygonFromVertices(e,c,i,n),!!a)}function straightPolygonPathFromTiles(e,t){var i=e.ctx,r=e.hexSize,n=e.origin,a=r*Math.sqrt(3);i.beginPath();var o=[];for(var s in t)for(var l=terrain.tileFromKey(s),c=(pixelFromTile(l,n,r),0);6>c;c++){var u=terrain.neighborFromTile(l,c);void 0===t[terrain.keyFromTile(u)]&&(o=o.concat(vertexFromFace(s,c)))}for(var d=polygonFromVertices(e,o,a),h=0;h<d.length;h++)partialPathFromPolygon(e,d[h])}function vertexFromFace(e,t){var i=(t+4)%6,r=(i+1)%6;return[vertexFromTileKey(e,i),vertexFromTileKey(e,r)]}function vertexFromTileKey(e,t){return 0===t?terrain.keyFromTile(terrain.neighborFromTile(terrain.tileFromKey(e),2))+":0":1===t?terrain.keyFromTile(terrain.neighborFromTile(terrain.tileFromKey(e),3))+":1":2===t?terrain.keyFromTile(terrain.neighborFromTile(terrain.tileFromKey(e),3))+":0":3===t?terrain.keyFromTile(terrain.neighborFromTile(terrain.tileFromKey(e),4))+":1":4===t?e+":0":5===t?e+":1":"invalid:vertex:key"}function pointFromVertex(e,t,i,r){var n=e.hexSize,a=e.origin,o=+t.slice(-1),s=t.slice(0,-2),l=terrain.tileFromKey(s),c=pixelFromTile(l,a,n),u=0|c.x,d=0|c.y,h=i/2|0,m=n/2|0,p=r?noisyPixel(n/2,l):{x:0,y:0};return 0===o?{x:u+h+p.x,y:d+m+p.y}:1===o?{x:u+h,y:d-m}:void 0}function polygonFromVertices(e,t,i,r){for(var n=(e.hexSize,e.origin,new Array(t.length)),a=0;a<t.length;a++)n[a]=t[a];for(var o=[];n.length>0;){for(var s=n.shift(),l=n.shift(),c=[pointFromVertex(e,s,i,r),pointFromVertex(e,l,i,r)],u=1e4;l!==s&&u-->0;)for(var a=0;a<n.length;a+=2){if(n[a]===l){c.push(pointFromVertex(e,n[a+1],i,r)),l=n[a+1],n.splice(a,2);break}if(n[a+1]===l){c.push(pointFromVertex(e,n[a],i,r)),l=n[a],n.splice(a,2);break}}c.pop(),o.push(c)}return o}function partialPathFromPolygon(e,t){var i=e.ctx;i.moveTo(t[0].x,t[0].y);for(var r=1;r<t.length;r++)i.lineTo(t[r].x,t[r].y);i.closePath()}function pathFromPolygons(e,t,i){var r=e.ctx;r.beginPath();for(var n=0;n<t.length;n++)partialPathForSmoothPolygon(e,t[n],!!i)}function averagePoint(e,t){return{x:e.x+t.x>>1,y:e.y+t.y>>1}}function extremizePoint(e,t){var i=averagePoint(a1,c2),r=averagePoint(a2,c1);return{x:t.x-(i.x-t.x)/2|0+(r.x-t.x)/2|0,y:t.y-(i.y-t.y)/2|0+(r.y-t.y)/2|0}}function partialPathForSmoothPolygon(e,t,i){i=!!i;var r=e.ctx;if(t.length<3)return partialPathFromPolygon(e,t);for(var n,a=new Array(t.length),o=0;o<t.length;o++)n=averagePoint(t[o],t[(o+1)%t.length]),a[o]=n;var n=averagePoint(a[0],a[1]);r.moveTo(n.x,n.y);for(var o=1;o<a.length;o++)n=averagePoint(a[o],a[(o+1)%a.length]),i&&o%2===0?r.moveTo(n.x,n.y):r.quadraticCurveTo(a[o].x,a[o].y,n.x,n.y);i||(n=averagePoint(a[0],a[1]),r.quadraticCurveTo(a[0].x,a[0].y,n.x,n.y))}function partialPathFromHex(e,t,i,r){var n=e.ctx,a=e.hexSize;i=0|i;var o=0|t.x,s=0|t.y,l=r/2|0,c=a/2|0;n.moveTo(o,s-a);var u=o-l,d=s-c;0===(4&i)?n.lineTo(u,d):n.moveTo(u,d),u=o-l,d=s+c,0===(8&i)?n.lineTo(u,d):n.moveTo(u,d),u=o,d=s+a,0===(16&i)?n.lineTo(u,d):n.moveTo(u,d),u=o+l,d=s+c,0===(32&i)?n.lineTo(u,d):n.moveTo(u,d),u=o+l,d=s-c,0===(1&i)?n.lineTo(u,d):n.moveTo(u,d),u=o,d=s-a,0===(2&i)?n.lineTo(u,d):n.moveTo(u,d)}function pathFromHex(e,t,i,r){{var n=e.ctx;e.hexSize}n.beginPath(),partialPathFromHex(e,t,0,i,r)}function paintAroundTiles(e,t,i){var r=e.ctx,n=e.hexSize,a=(e.origin,n*Math.sqrt(3)),o=3*n/2;pathFromTiles(e,t,a,o,!0),r.strokeStyle=i||"white",r.stroke()}function paintStraightAroundTiles(e,t,i){var r=e.ctx,n=e.hexSize,a=(e.origin,n*Math.sqrt(3)),o=3*n/2;straightPathFromTiles(e,t,a,o),r.strokeStyle=i||"white",r.stroke()}function paintTileHexagon(e,t,i,r){var n=e.ctx,a=e.hexSize,o=e.origin,s=(a*Math.sqrt(3),3*a/2),l=pixelFromTile(t,o,a),c=s;n.beginPath(),n.arc(l.x,l.y,c,0,2*Math.PI,!0),n.closePath(),n.strokeStyle=i,n.lineWidth=r?r:3,n.stroke(),n.lineWidth=1}function paintRotatedSprite(e,t,i,r,n){var a=e.ctx,o=e.hexSize,s=e.spritesWidth;a.save(),a.translate(t,i),a.rotate(n);var l=o/20,c=0|-(s*l/2),u=s*l|0;a.drawImage(e.sprites,0,s*r|0,s,s,c,c,u,u),a.restore()}function paintSprite(e,t,i,r,n){return paintRotatedSprite(e,t,i,r,n*mπd3)}function paintBuilding(e,t,i,r,n,a,o){if(null!=n)if(n===tileTypes.road){for(var s=tileTypes.curvedRoad,l=!1,c=[humanity.tile(terrain.neighborFromTile(r,0)),humanity.tile(terrain.neighborFromTile(r,1)),humanity.tile(terrain.neighborFromTile(r,2)),humanity.tile(terrain.neighborFromTile(r,3)),humanity.tile(terrain.neighborFromTile(r,4)),humanity.tile(terrain.neighborFromTile(r,5))],u=0;6>u;u++)if(c[u]&&c[u].b===n){var d=c[(u+2)%6],h=c[(u+4)%6];d&&d.b===n?paintSprite(e,t,i,s,u):h&&h.b===n||paintSprite(e,t,i,n,u),l=!0}l||paintSprite(e,t,i,n,0)}else if(n===tileTypes.wall||n===tileTypes.airland){for(var l=!1,u=0;6>u;u++){var m=humanity.tile(terrain.neighborFromTile(r,u));m&&((n===tileTypes.road||n===tileTypes.wall)&&m.b===n||n===tileTypes.airland&&m.b===tileTypes.airport)&&(paintSprite(e,t,i,n,u),l=!0)}l||paintSprite(e,t,i,n,0)}else n>26&&63>n?paintRotatedSprite(e,t,i,n,r.q*r.r*(128*o.rain|0)%64/64*πx2):n===tileTypes.airport||n===tileTypes.factory||n>tileTypes.wall?paintSprite(e,t,i,n,0):paintSprite(e,t,i,n,a)}function paintLoneBuilding(e,t,i){var r=pixelFromTile(t,e.origin,e.hexSize),n=terrain.tile(t),a=(t.q^t.r^(128*n.rain|0))%6;paintBuilding(e,r.x,r.y,t,i,a,n)}function paintBuildingsSprited(e){for(var t=e.width,i=e.height,r=(e.ctx,e.origin),n=e.hexSize,a=tileFromPixel({x:0,y:0},r,n),o=pixelFromTile({q:a.q,r:a.r-1},r,n),s=o.x,l=o.y,c=n*Math.sqrt(3),u=3*n/2,d=!0;i>l-u;){for(;t>s-c;){a=tileFromPixel({x:s,y:l},e.origin,n);var h=terrain.tile(a),m=(a.q^a.r^(128*h.rain|0))%6,p=humanity.tile(a);paintBuilding(e,s,l,a,p?p.b:null,m,h),s+=c}l+=u,s=o.x,d?(s-=c/2,d=!1):d=!0,s=Math.floor(s),l=Math.floor(l)}}function paintTerrain(e,t,i,r,n){n=n||terrain.tile(r);var a=(r.q^r.r^(128*n.rain|0))%6;paintSprite(e,t,i,n.type,a)}function paintTilesSprited(e){var t=e.width,i=e.height,r=e.ctx,n=e.hexSize,a=e.origin,o=tileFromPixel({x:0,y:0},a,n),s=pixelFromTile({q:o.q,r:o.r-1},a,n),l=s.x,c=s.y,u=n*Math.sqrt(3),d=3*n/2,h=n+":"+a.x0+":"+a.y0;if(void 0===cachedTerrainPaint[h]){var m=document.createElement("canvas");m.width=e.width,m.height=e.height;var p=makeGraphicState(m,sprites);p.hexSize=e.hexSize,p.origin=e.origin;for(var g=0;9>g;g++)for(var y=!0,l=s.x,c=s.y;i>c-d;){for(;t>l-u;){o=tileFromPixel({x:l,y:c},a,n);var f=terrain.tile(o),v=terrain.commodity(o,f);if(f.type===g)paintTerrain(p,l,c,o,f),v>=0&&(p.ctx.textAlign="center",p.ctx.fillText(tileNames[v],l,c));else if(8===g&&f.type===tileTypes.water)for(var T=0;6>T;T++){var x=terrain.neighborFromTile(o,T),w=terrain.tile(x);w.type!==tileTypes.water&&w.type!==tileTypes.swamp&&paintSprite(p,l,c,tileTypes.beach,T%6)}l+=u}c+=d,l=s.x,y?(l-=u/2,y=!1):y=!0,l=0|l,c=0|c}cachedTerrainPaint[h]=m;var M=getWorkerFromPool();M.addEventListener("message",function P(e){if(e.data.origin.x0===a.x0&&e.data.origin.y0===a.y0&&e.data.size===n){workerCanvasBuffer.getContext("2d").putImageData(e.data.image,0,0),p.ctx.drawImage(workerCanvasBuffer,0,0),M.removeEventListener("message",P);var r=s.x+a.x0-n/2,o=s.y+a.y0-n/2;updateCachedRegion(r,o,t,i),updateCachedRegion(r+t,o,t,i),updateCachedRegion(r,o+i,t,i),updateCachedRegion(r+t,o+i,t,i),paint(globalGs),paintHumans(globalGs,humanityData)}}),workerMessage.image=workerImageBuffer,workerMessage.size=n,workerMessage.origin=a,workerMessage.type="rainfall",M.postMessage(workerMessage)}r.drawImage(cachedTerrainPaint[h],0,0)}function paintTilesRaw(e){for(var t=r.canvas.width,i=r.canvas.height,r=e.ctx,n=e.hexSize,a=e.origin,o=r.getImageData(0,0,t,i),s=o.data,l=0;i>l;l++)for(var c=0;t>c;c++){var u=tileFromPixel({x:c,y:l},a,n),d=terrain.tile(u),h=[180,0,0];d.steepness==tileTypes.water?h=[50,50,180]:d.steepness==tileTypes.steppe?h=[0,180,0]:d.steepness==tileTypes.hill&&(h=[180,100,0]);var m=Math.min(Math.abs(h[0]-h[1])/2*d.rain,255);h[0]-=m,h[1]-=m,h[2]-=Math.min(50*d.rain,255),d.vegetation&&(h[0]-=100,h[1]-=50,h[2]-=100);var p=4*(c+l*t);s[p+0]=h[0],s[p+1]=h[1],s[p+2]=h[2],s[p+3]=255}r.putImageData(o,0,0)}function getWorkerFromPool(){return workerPoolRoundRobin++,workerPoolRoundRobin%=workerPool.length,workerPool[workerPoolRoundRobin]}function paintTiles(e,t){var i=e.ctx,r=e.hexSize,n=e.origin;if(5>r){var a=getWorkerFromPool();a.addEventListener("message",function o(e){e.data.origin.x0===n.x0&&e.data.origin.y0===n.y0&&e.data.size===r&&(i.putImageData(e.data.image,0,0),a.removeEventListener("message",o),t())}),workerMessage.image=workerImageBuffer,workerMessage.size=r,workerMessage.origin=n,workerMessage.type="raw",a.postMessage(workerMessage)}else paintTilesSprited(e),paintBuildingsSprited(e),t()}function getCachedPaint(e,t,i,r,n){var a=t+":"+i,o=cachedPaint[a];if(null==o){var s=document.createElement("canvas");if(s.width=e.width,s.height=e.height,void 0===o&&n instanceof Function){var l=s.getContext("2d");l.fillStyle="black",l.fillRect(0,0,e.width,e.height),n(s)}if(void 0===cachePending[a]){cachePending[a]=r;var c=makeGraphicState(s,sprites);c.hexSize=e.hexSize,c.origin={x0:t,y0:i},paintTiles(c,function(){o=cachedPaint[a]=s,cachePending[a](o),delete cachePending[a]})}else cachePending[a]=r}else r(o)}function drawCachedPaint(e,t,i,r,n){var a=t+":"+i,o=cachedPaint[a];null!=o&&e.ctx.drawImage(o,r,n)}function regionFromPixel(e,t,i,r){var n,a,n=e%i;0>n&&(n+=i);var a=t%r;0>a&&(a+=r);var o=e-n,s=t-a;return o+":"+s}function updateCachedRegion(e,t,i,r){cachedPaint[regionFromPixel(e,t,i,r)]=null}function updateCachedPaint(e,t){var i=e.hexSize,r=e.origin;for(var n in t){var a=terrain.tileFromKey(n),o=pixelFromTile(a,r,i),s=e.width,l=e.height,c=o.x+r.x0-i/2,u=o.y+r.y0-i/2;updateCachedRegion(c,u,s,l),updateCachedRegion(c+i,u,s,l),updateCachedRegion(c,u+i,s,l),updateCachedRegion(c+i,u+i,s,l)}}function paintTilesFromCache(e,t){var i=e.ctx,r=e.origin,n=document.createElement("canvas");n.width=e.width,n.height=e.height;var a=n.getContext("2d"),o=e.width,s=e.height,l=r.x0%o;0>l&&(l+=o);var c=r.y0%s;0>c&&(c+=s);var u=r.x0-l,d=r.x0+o-l,h=r.y0-c,m=r.y0+s-c,p=0,g=function(r,o,s){return function(l){a.drawImage(l,r,o),s?(p++,4===p&&(i.drawImage(n,0,0),t())):(i.drawImage(n,0,0),paintTilesFromCurrentCache(e))}},y=g(-l,-c,!0),f=g(o-l,-c,!0),v=g(-l,s-c,!0),T=g(o-l,s-c,!0),x=g(-l,-c,!1),w=g(o-l,-c,!1),M=g(-l,s-c,!1),P=g(o-l,s-c,!1);getCachedPaint(e,u,h,y,x),getCachedPaint(e,d,h,f,w),getCachedPaint(e,u,m,v,M),getCachedPaint(e,d,m,T,P)}function paintTilesFromCurrentCache(e){var t=(e.ctx,e.origin),i=e.width,r=e.height,n=t.x0%i;0>n&&(n+=i);var a=t.y0%r;0>a&&(a+=r);var o=t.x0-n,s=t.x0+i-n,l=t.y0-a,c=t.y0+r-a;drawCachedPaint(e,o,l,-n,-a),drawCachedPaint(e,s,l,i-n,-a),drawCachedPaint(e,o,c,-n,r-a),drawCachedPaint(e,s,c,i-n,r-a)}function paint(e){e.ctx,e.hexSize,e.origin;selectionMode===selectionModes.places&&orientPlacesArrow(),spritesLoaded&&paintTilesFromCache(e,function(){paintIntermediateUI(e)})}function paintIntermediateUI(e){{var t=e.ctx,i=e.hexSize;e.origin}5>i&&drawMapPlaces(e);for(var r in lockedTiles)paintTileHexagon(e,terrain.tileFromKey(r),campHsl(lockedTiles[r]),1);null!=currentTile&&null!=playerCamp&&paintTileHexagon(e,currentTile,campHsl(playerCamp,100,40)),paintCamps(e),t.lineWidth=1.5,t.setLineDash([2,7]),paintAroundTiles(e,accessibleTiles),t.setLineDash([]),t.lineWidth=1,null!=currentTile&&null!=targetTile&&selectionMode===selectionModes.travel&&(paintAlongTiles(e,terrain.pathFromParents(terrain.keyFromTile(targetTile),accessibleTiles)),displayTravelInfo(currentTile,targetTile));for(var n in registerMoves){var a=terrain.tileFromKey(n);paintAlongTiles(e,terrain.humanTravelSpeedPath(registerMoves[n],a))}for(var o in registerBuilds){var s=terrain.tileFromKey(o);paintLoneBuilding(e,s,registerBuilds[o])}paintTileMessages(e),void 0!==gameOver&&drawTitle(e,[campNames[gameOver.winners[0]]+" won a "+gameOver.winType+" Victory.",gameOver.winners[0]===playerCamp?"YOU WON! ("+nth(localStorage.getItem("gamesWon"))+" win!)":"YOU NEARLY WON! ("+nth(gameOver.winners.indexOf(playerCamp)+1)+" place!)","You can reload to engage in the next game!"],campHsl(gameOver.winners[0])),showTitleScreen&&drawTitle(e,["Welcome to Thaddée Tyl's…","NOT MY TERRITORY","(YET)"]),displayedPaintContext.drawImage(canvas,0,0)}function nth(e){e=0|e;var t=""+e;if(49===t.charCodeAt(t.length-2))return t+"th";var i=e%10;return 1===i?t+"st":2===i?t+"nd":3===i?t+"rd":t+"th"}function drawTitle(e,t,i){var r=e.ctx,n=e.width,a=e.height,o=t[0],s=t[1],l=t[2];r.fillStyle=i||"black",i&&(r.strokeStyle="black"),r.textAlign="center",r.font=a/16+'px "Linux Biolinum", sans-serif',r.fillText(o,n/2,1*a/3),i&&r.strokeText(o,n/2,1*a/3),r.font=a/8+'px "Linux Biolinum", sans-serif',r.fillText(s,n/2,13*a/24),i&&r.strokeText(s,n/2,13*a/24),r.font=a/16+'px "Linux Biolinum", sans-serif',r.fillText(l,n/2,2*a/3),i&&r.strokeText(l,n/2,2*a/3),r.textAlign="start"}function fillMapIndex(e){for(var t in e)mapIndex["2:"+t]=e[t]}function drawMapPlaces(e){var t=e.ctx;t.fillStyle="black",t.textAlign="center";for(var i in mapIndex){var r=i.split(":"),n=+r[0],a={q:0|r[1],r:0|r[2]},o=pixelFromTile(a,e.origin,e.hexSize),s=mapIndex[i];t.font="italic "+e.hexSize*n*7+'px "Linux Biolinum", sans-serif',t.fillText(s,o.x,o.y-15)}t.textAlign="start"}function initHumans(){for(var e=0;numberOfHumanAnimations>e;e++)humanAnimation[e]={x:Math.random(),y:Math.random(),targetx:Math.random(),targety:Math.random(),period:20*Math.random()+3|0,tick:0}}function updateHumans(){for(var e=0;e<humanAnimation.length;e++){var t=humanAnimation[e];t.x+=(t.targetx-t.x)/t.period,t.y+=(t.targety-t.y)/t.period,t.tick++,t.tick>t.period&&(t.targetx=Math.random(),t.targety=Math.random(),t.tick=0)}}function paintHumans(e,t){var i=e.ctx,r=e.hexSize,n=e.origin;if(!(20>r)){i.drawImage(displayedPaint,0,0);for(var a in t){for(var o=a.split(":"),s=+o[0],l=+o[1],c=t[a],u=terrain.tile(terrain.tileFromKey(a)),d=pixelFromTile({q:s,r:l},n,r),h=d.x,m=d.y,p=[],g=[2,4,8,16,32,64],y=0;y<g.length;y++)0!==(c.o&g[y])&&p.push(g[y]);var f=(u.type===tileTypes.water||u.type===tileTypes.swamp)&&0!==(c.o&manufacture.boat),v=(u.type===tileTypes.water||u.type===tileTypes.swamp)&&0!==(c.o&manufacture.plane),T=c.h;T>humanAnimation.length&&(T=humanAnimation.length);for(var x=0;T>x;x++){var w=humanAnimation[Math.abs(x+s^l^c.f)%humanAnimation.length],M=h-r+2*w.x*r|0,P=m-r+2*w.y*r|0,k=-1;f?k=manufacture.boat:v?k=manufacture.plane:p.length>0&&(k=p[x%p.length]),paintHuman(e,k,u,M,P,r)}}}}function paintHuman(e,t,i,r,n){var a=e.ctx,o=e.hexSize,s=o/20;0>t?(a.fillStyle="black",a.fillRect(r,n,s,2*s)):t===manufacture.boat?(a.fillStyle="#aaf",a.fillRect(r-s,n-s,s,s),a.fillRect(r,n,7*s,s),a.fillRect(r+7*s,n-s,s,s)):t===manufacture.car?(a.fillStyle="#420",a.fillRect(r,n,3*s,2*s)):t===manufacture.plane?(a.fillStyle="#edf",a.fillRect(r-s,n-s,2*s,s),a.fillRect(r,n,9*s,s),a.fillRect(r+5*s,n-s,s,s),a.fillRect(r+3*s,n+s,s,s)):t===manufacture.artillery?(a.fillStyle="#425",a.fillRect(r-2*s,n,5*s,2*s),a.fillRect(r,n-1*s,5*s,1*s)):t===manufacture.gun&&(a.fillStyle="#440",a.fillRect(r,n,s,2*s))}function animateHumans(){paintHumans(gs,humanityData),updateHumans(),paintMovementAnimations()}function InterpolationAnimation(e,t,i,r,n){this.gs=e,this.from=t,this.to=i,this.pos={x:this.from.x,y:this.from.y},this.velocity=r,this.deltaX=i.x-t.x,this.deltaY=i.y-t.y,this.length=Math.sqrt(this.deltaX*this.deltaX+this.deltaY*this.deltaY),this.portions=this.length/r,this.usedPortions=0,this.dx=this.deltaX/this.portions,this.dy=this.deltaY/this.portions,this.normalizedDx=this.deltaX/this.length,this.normalizedDy=this.deltaY/this.length,this.drawFunction=n}function paintMovementAnimations(){for(var e=0;e<movementAnimations.length;e++)movementAnimations[e].draw()}function drawShell(){var e=this.gs.ctx;e.lineWidth=2;for(var t=Math.min(this.usedPortions,8),i=this.pos.x,r=this.pos.y,n=4,a=n*this.normalizedDx,o=n*this.normalizedDy,s=9;s>8-t;s--)e.beginPath(),e.moveTo(i,r),i-=a,r-=o,e.lineTo(i,r),e.strokeStyle="rgba(0,0,0,0."+s+")",e.stroke()}function addShells(e,t){var i=listVisibleHumans(gs);for(var r in t)for(var n=t[r],a=0;a<n.length;a++){var o=n[a];if(i.indexOf(o)>=0||i.indexOf(r)>=0){var s=terrain.tileFromKey(o),l=terrain.tileFromKey(r),c=pixelFromTile(s,gs.origin,gs.hexSize),u=pixelFromTile(l,gs.origin,gs.hexSize),d=new InterpolationAnimation(gs,c,u,animationVelocity,drawShell);e.push(d)}}}function listVisibleHumans(e){var t,i,r,n,a,o=(e.ctx,e.hexSize),s=e.origin;a=tileFromPixel({x:0,y:e.height},s,o),i=a.q-1,r=a.r+1,a=tileFromPixel({x:e.width,y:0},s,o),t=a.q+1,n=a.r-1;var l=[];for(var c in humanityData)tile=terrain.tileFromKey(c),tile.q>=i&&tile.q<=t&&tile.r>=n&&tile.r<=r&&null!=humanityData[c].c&&l.push(c);return l}function paintCamps(e){for(var t=e.ctx,i=e.hexSize,r=e.origin,n=listVisibleHumans(e),a=new Array(numberOfCamps),o=0;numberOfCamps>o;o++)a[o]={};for(var o=0;o<n.length;o++){var s=humanityData[n[o]];a[s.c][n[o]]=!0}var l=2*e.hexSize/9,c=e.hexSize*Math.sqrt(3),u=3*e.hexSize/2;if(5>i){t.fillStyle="black";for(var d=2*i,o=0;numberOfCamps>o;o++){var h=a[o];for(var m in h){var p=pixelFromTile(terrain.tileFromKey(m),r,i);t.fillRect(p.x-d,p.y-d,2*d,2*d)}}for(var o=0;numberOfCamps>o;o++){t.fillStyle=campHsl(o);var h=a[o];for(var m in h){var p=pixelFromTile(terrain.tileFromKey(m),r,i);t.fillRect(p.x-i,p.y-i,2*i,2*i)}}}else{for(var o=0;numberOfCamps>o;o++)pathFromTiles(e,a[o],c,u,!0,!1),t.lineWidth=2*l,t.strokeStyle="hsla("+campHueCreator9000(o)+",30%,40%,0.4)",t.stroke();for(var o=0;numberOfCamps>o;o++)pathFromTiles(e,a[o],c,u,!0,!1),t.save(),t.clip(),t.lineWidth=l,t.strokeStyle=campHsl(o,70,35,.4),t.stroke(),pathFromTiles(e,a[o],c,u,!0,!0),t.strokeStyle=campHsl(o,80,42,.4),t.stroke(),t.restore();t.lineWidth=1}}function campHsl(e,t,i,r){return null==t&&(t=100),null==i&&(i=45),null==r?"hsl("+campHueCreator9000(e)+","+t+"%,"+i+"%)":"hsla("+campHueCreator9000(e)+","+t+"%,"+i+"%,"+r+")"}function campHueCreator9000(e){return void 0!==campHue[e]?campColors[e]:0===e?270:(campHueCreator9000(e-1)+60)%360}function paintPopulation(){if(humanityPopulation){var e=187,t=10,i="<svg id=populationMonitor>";i+='<rect stroke="hsl(0,0%,40%)" stroke-width="1" x="0" y="0" rx="3" ry="3" width="'+e+'" height="'+t+'" />';for(var r=0,n=0;n<humanityPopulation.length;n++)r+=humanityPopulation[n];for(var a,o=1,s=e-2,l=0,n=0;n<humanityPopulation.length-1;n++)a=s*humanityPopulation[n]/r|0,l+=a,i+='<rect fill="'+campHsl(n)+'" x="'+o+'" y="1" width="'+a+'" height="'+(t-2)+'" />',o+=a;a=s-l,i+='<rect fill="'+campHsl(n)+'" x="'+o+'" y="1" width="'+a+'" height="'+(t-2)+'" /><linearGradient id="grad" y2="100%" x2="0"><stop offset="0" stop-color="#fff" stop-opacity=".1"/><stop offset="1" stop-color="#000" stop-opacity=".2"/></linearGradient><rect fill="url(#grad)" x="1" y="1" width="'+(e-2)+'" height="'+(t-2)+'"/></svg>',populationMonitor.outerHTML=i}}function addHumanMessages(e,t,i){for(var r=0;r<t.length;r++){var n=t[r];e[n]&&clearTimeout(e[n].timeout);var a=i[i.length*Math.random()|0];e[n]={message:a,timeout:setTimeout(function(t){return function(){delete e[t],paint(gs)}}(n),2e3)}}}function addStarveMessages(e){var t=[];for(var i in e)e[i].h>0&&e[i].f<4&&t.push(i);addHumanMessages(starvedTiles,t,hungerMessages)}function paintMessage(e,t,i){var r=e.ctx,n=e.hexSize,a=e.origin;r.font='14px "Linux Biolinum", sans-serif';var o=r.measureText(i).width,s=pixelFromTile(terrain.tileFromKey(t),a,n),l=s.x+n/4,c=s.y-n/4;r.beginPath(),r.moveTo(l,c),r.lineTo(l+2,c-10),r.lineTo(l-12,c-10),r.lineTo(l-10,c-40),r.lineTo(l+o+10,c-35),r.lineTo(l+o,c-10),r.lineTo(l+12,c-10),r.closePath(),r.fillStyle="rgba(0,0,0,0.8)",r.fill(),r.strokeStyle="white",r.strokeText(i,l-4,c-20)}function paintTileMessages(e){e.ctx,e.hexSize,e.origin;for(var t in warTiles)paintMessage(e,t,warTiles[t].message);for(var t in surrenderTiles)paintMessage(e,t,surrenderTiles[t].message);for(var t in starvedTiles)paintMessage(e,t,starvedTiles[t].message)}function attributeNameFromTile(){var e=[],t=0;for(var i in tileTypes)e[t++]=i;return e}function showTileInformation(e){var t=terrain.tile(e),i="a "+tileNames[t.type],r=humanity.tile(e);if(null!=r&&(null!=r.b&&(i=("a"===tileNames[r.b][0]?"an ":"a ")+tileNames[r.b]+" built in "+i),r.h>0)){var n="",a=!1;0!==(r.o&manufacture.plane)&&(n+="on a plane ",a=!0),0!==(r.o&manufacture.boat)&&(n+=(t.type!==tileTypes.water||a?"with":(a=!0,"in"))+" a boat "),0!==(r.o&manufacture.artillery)&&(n+="with cannons "),0!==(r.o&manufacture.car)&&(n+=(a?"with":"in")+" a car "),i=r.h+(0!==(r.o&manufacture.gun)?" armed":"")+" folk"+(1===r.h?"":"s")+" "+n+"in "+i}tileInfo.value=i}function indicateValidConstructions(e){for(var t=0;t<buildSelectionButtons.length;t++){var i=+buildSelectionButtons[t].dataset.b;terrain.validConstruction(i,e,resources)?buildSelectionButtons[t].classList.add("validSelection"):buildSelectionButtons[t].classList.remove("validSelection")}}function hookBuildSelectionButtons(){for(var e=0;e<buildSelectionButtons.length;e++){var t=function(e){return function(){sendBuild(currentTile,e),enterMode(selectionModes.normal)}}(+buildSelectionButtons[e].dataset.b);buildSelectionButtons[e].addEventListener("click",t)}}function updateCurrentTileInformation(){void 0!==currentTile&&(showTileInformation(currentTile),accessibleTiles=terrain.humanTravelFrom(currentTile),indicateValidConstructions(currentTile))}function hidePanel(e,t){e.style.display="none",t.style.fill="black",t.firstElementChild.style.display="block",t.firstElementChild.nextElementSibling.style.display="none"}function showPanel(e,t){e.style.display="block",t.style.fill="#800080",t.firstElementChild.style.display="none",t.firstElementChild.nextElementSibling.style.display="block"}function enterMode(e){selectionMode!==e&&(selectionMode===selectionModes.settings?(hidePanel(settingsPanel,settingsBut),settingsBut.removeEventListener("click",enterNormalMode),settingsBut.addEventListener("click",enterSettingsMode)):selectionMode===selectionModes.travel?(hidePanel(travelPanel,travelBut),targetTile=null,travelBut.removeEventListener("click",enterNormalMode),travelBut.addEventListener("click",enterTravelMode)):selectionMode===selectionModes.build?(hidePanel(buildPanel,buildBut),buildBut.removeEventListener("click",enterNormalMode),buildBut.addEventListener("click",enterBuildMode)):selectionMode===selectionModes.places&&(hidePanel(placesPanel,placesBut),placesBut.removeEventListener("click",enterNormalMode),placesBut.addEventListener("click",enterPlacesMode)),e===selectionModes.settings?(showPanel(settingsPanel,settingsBut),settingsBut.addEventListener("click",enterNormalMode)):e===selectionModes.travel?(splitPanelSetMoveStay(),showPanel(travelPanel,travelBut),travelBut.addEventListener("click",enterNormalMode)):e===selectionModes.build?(showPanel(buildPanel,buildBut),buildBut.addEventListener("click",enterNormalMode)):e===selectionModes.places&&(orientPlacesArrow(),showPanel(placesPanel,placesBut),placesBut.addEventListener("click",enterNormalMode)),selectionMode=e,mousePosition&&showPath({clientX:mousePosition.x,clientY:mousePosition.y}),e===selectionModes.normal&&paint(gs))
}function enterNormalMode(){enterMode(selectionModes.normal)}function enterSettingsMode(){enterMode(selectionModes.settings)}function enterTravelMode(){enterMode(selectionModes.travel)}function enterBuildMode(){enterMode(selectionModes.build)}function enterPlacesMode(){enterMode(selectionModes.places)}function splitPanelSlider(e){splitInputWidget.value=""+e,splitPanelPortion.textContent=""+e}function splitPanelSetMoveStay(){var e=humanity.tile(currentTile),t=0;null!=e&&(t=e.h);var i=t*splitInputWidget.value/100|0,r=t-i;splitPanelPortionMove.textContent=""+i,splitPanelPortionStay.textContent=""+r}function travelingNumber(e){return e*splitInputWidget.value/100|0}function mouseSelection(e){gs.canvas.removeEventListener("mousemove",mouseDrag),gs.canvas.removeEventListener("mouseup",mouseSelection);var t=tileFromPixel({x:e.clientX,y:e.clientY},gs.origin,gs.hexSize);if(selectionMode===selectionModes.travel&&void 0!==currentTile&&void 0!==humanity.tile(currentTile)){var i=humanity.tile(currentTile),r=travelingNumber(i.h),n=t;if(terrain.humanTravelSpeedPath(currentTile,n).length>1&&i.c===playerCamp){if(i.f<=0){var a={};a[terrain.keyFromTile(currentTile)]=i,addStarveMessages(a)}sendMove(currentTile,n,r)}else if(r>0){var o,s=MAX_INT;for(var l in accessibleTiles){var c=terrain.tileFromKey(l),u=terrain.distanceBetweenTiles(c,n);s>u&&(o=c,s=u)}null!=o&&(sendMove(currentTile,o,r),t=o)}enterMode(selectionModes.normal)}else sendPos(currentTile,t);currentTile=t,updateCurrentTileInformation(),paint(gs)}function showPath(e){mousePosition={x:e.clientX,y:e.clientY},currentTile&&selectionMode===selectionModes.travel&&(targetTile=tileFromPixel(mousePosition,gs.origin,gs.hexSize),paint(gs),paintHumans(gs,humanityData))}function mouseDrag(){gs.canvas.style.cursor="move",gs.canvas.removeEventListener("mousemove",mouseDrag),gs.canvas.removeEventListener("mouseup",mouseSelection),gs.canvas.addEventListener("mouseup",mouseEndDrag),gs.canvas.addEventListener("mousemove",dragMap),clearInterval(humanAnimationTimeout),currentlyDragging=!0,resetDragVector(),dragVelTo=setInterval(resetDragVector,dragVelInterval)}function mouseEndDrag(){gs.canvas.style.cursor="",gs.canvas.removeEventListener("mousemove",dragMap),gs.canvas.removeEventListener("mouseup",mouseEndDrag),humanAnimationTimeout=setInterval(animateHumans,100),currentlyDragging=!1,paint(gs),clearInterval(dragVelTo),computeDragVelocity(),inertiaDragMap()}function dragMap(e){if(!drawingWhileDragging){drawingWhileDragging=!0;var t=lastMousePosition.clientX-e.clientX,i=lastMousePosition.clientY-e.clientY;gs.origin.x0+=t,gs.origin.y0+=i,lastMousePosition.clientX=e.clientX,lastMousePosition.clientY=e.clientY,paint(gs),requestAnimationFrame(function(){drawingWhileDragging=!1})}}function resetDragVector(){dragTime=Date.now(),dragVector[0]=gs.origin.x0,dragVector[1]=gs.origin.y0}function computeDragVelocity(){dragTime=Date.now()-dragTime,dragVector[0]=gs.origin.x0-dragVector[0],dragVector[1]=gs.origin.y0-dragVector[1];var e=.03*dragTime;dragVelocity[0]=dragVector[0]/e|0,dragVelocity[1]=dragVector[1]/e|0}function inertiaDragMap(){gs.origin.x0+=dragVelocity[0],gs.origin.y0+=dragVelocity[1],dragVelocity[0]=dragVelocity[0]/1.1|0,dragVelocity[1]=dragVelocity[1]/1.1|0,paint(gs),requestAnimationFrame(function(){(0!==dragVelocity[0]||0!==dragVelocity[1])&&inertiaDragMap()})}!function(){function e(e){e||(e=Math.random),this.p=new Uint8Array(256),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var t=0;256>t;t++)this.p[t]=256*e();for(t=0;512>t;t++)this.perm[t]=this.p[255&t],this.permMod12[t]=this.perm[t]%12}var t=.5*(Math.sqrt(3)-1),i=(3-Math.sqrt(3))/6,r=1/3,n=1/6,a=(Math.sqrt(5)-1)/4,o=(5-Math.sqrt(5))/20;e.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(e,r){var n,a,o=this.permMod12,s=this.perm,l=this.grad3,c=0,u=0,d=0,h=(e+r)*t,m=Math.floor(e+h),p=Math.floor(r+h),g=(m+p)*i,y=m-g,f=p-g,v=e-y,T=r-f;v>T?(n=1,a=0):(n=0,a=1);var x=v-n+i,w=T-a+i,M=v-1+2*i,P=T-1+2*i,k=255&m,b=255&p,S=.5-v*v-T*T;if(S>=0){var F=3*o[k+s[b]];S*=S,c=S*S*(l[F]*v+l[F+1]*T)}var C=.5-x*x-w*w;if(C>=0){var D=3*o[k+n+s[b+a]];C*=C,u=C*C*(l[D]*x+l[D+1]*w)}var A=.5-M*M-P*P;if(A>=0){var I=3*o[k+1+s[b+1]];A*=A,d=A*A*(l[I]*M+l[I+1]*P)}return 70*(c+u+d)},noise3D:function(e,t,i){var a,o,s,l,c,u,d,h,m,p,g=this.permMod12,y=this.perm,f=this.grad3,v=(e+t+i)*r,T=Math.floor(e+v),x=Math.floor(t+v),w=Math.floor(i+v),M=(T+x+w)*n,P=T-M,k=x-M,b=w-M,S=e-P,F=t-k,C=i-b;S>=F?F>=C?(c=1,u=0,d=0,h=1,m=1,p=0):S>=C?(c=1,u=0,d=0,h=1,m=0,p=1):(c=0,u=0,d=1,h=1,m=0,p=1):C>F?(c=0,u=0,d=1,h=0,m=1,p=1):C>S?(c=0,u=1,d=0,h=0,m=1,p=1):(c=0,u=1,d=0,h=1,m=1,p=0);var D=S-c+n,A=F-u+n,I=C-d+n,H=S-h+2*n,R=F-m+2*n,B=C-p+2*n,q=S-1+3*n,L=F-1+3*n,E=C-1+3*n,N=255&T,z=255&x,W=255&w,V=.6-S*S-F*F-C*C;if(0>V)a=0;else{var O=3*g[N+y[z+y[W]]];V*=V,a=V*V*(f[O]*S+f[O+1]*F+f[O+2]*C)}var K=.6-D*D-A*A-I*I;if(0>K)o=0;else{var _=3*g[N+c+y[z+u+y[W+d]]];K*=K,o=K*K*(f[_]*D+f[_+1]*A+f[_+2]*I)}var Y=.6-H*H-R*R-B*B;if(0>Y)s=0;else{var X=3*g[N+h+y[z+m+y[W+p]]];Y*=Y,s=Y*Y*(f[X]*H+f[X+1]*R+f[X+2]*B)}var U=.6-q*q-L*L-E*E;if(0>U)l=0;else{var G=3*g[N+1+y[z+1+y[W+1]]];U*=U,l=U*U*(f[G]*q+f[G+1]*L+f[G+2]*E)}return 32*(a+o+s+l)},noise4D:function(e,t,i,r){var n,s,l,c,u,d=(this.permMod12,this.perm),h=this.grad4,m=(e+t+i+r)*a,p=Math.floor(e+m),g=Math.floor(t+m),y=Math.floor(i+m),f=Math.floor(r+m),v=(p+g+y+f)*o,T=p-v,x=g-v,w=y-v,M=f-v,P=e-T,k=t-x,b=i-w,S=r-M,F=0,C=0,D=0,A=0;P>k?F++:C++,P>b?F++:D++,P>S?F++:A++,k>b?C++:D++,k>S?C++:A++,b>S?D++:A++;var I,H,R,B,q,L,E,N,z,W,V,O;I=F>=3?1:0,H=C>=3?1:0,R=D>=3?1:0,B=A>=3?1:0,q=F>=2?1:0,L=C>=2?1:0,E=D>=2?1:0,N=A>=2?1:0,z=F>=1?1:0,W=C>=1?1:0,V=D>=1?1:0,O=A>=1?1:0;var K=P-I+o,_=k-H+o,Y=b-R+o,X=S-B+o,U=P-q+2*o,G=k-L+2*o,j=b-E+2*o,J=S-N+2*o,$=P-z+3*o,Q=k-W+3*o,Z=b-V+3*o,et=S-O+3*o,tt=P-1+4*o,it=k-1+4*o,rt=b-1+4*o,nt=S-1+4*o,at=255&p,ot=255&g,st=255&y,lt=255&f,ct=.6-P*P-k*k-b*b-S*S;if(0>ct)n=0;else{var ut=d[at+d[ot+d[st+d[lt]]]]%32*4;ct*=ct,n=ct*ct*(h[ut]*P+h[ut+1]*k+h[ut+2]*b+h[ut+3]*S)}var dt=.6-K*K-_*_-Y*Y-X*X;if(0>dt)s=0;else{var ht=d[at+I+d[ot+H+d[st+R+d[lt+B]]]]%32*4;dt*=dt,s=dt*dt*(h[ht]*K+h[ht+1]*_+h[ht+2]*Y+h[ht+3]*X)}var mt=.6-U*U-G*G-j*j-J*J;if(0>mt)l=0;else{var pt=d[at+q+d[ot+L+d[st+E+d[lt+N]]]]%32*4;mt*=mt,l=mt*mt*(h[pt]*U+h[pt+1]*G+h[pt+2]*j+h[pt+3]*J)}var gt=.6-$*$-Q*Q-Z*Z-et*et;if(0>gt)c=0;else{var yt=d[at+z+d[ot+W+d[st+V+d[lt+O]]]]%32*4;gt*=gt,c=gt*gt*(h[yt]*$+h[yt+1]*Q+h[yt+2]*Z+h[yt+3]*et)}var ft=.6-tt*tt-it*it-rt*rt-nt*nt;if(0>ft)u=0;else{var vt=d[at+1+d[ot+1+d[st+1+d[lt+1]]]]%32*4;ft*=ft,u=ft*ft*(h[vt]*tt+h[vt+1]*it+h[vt+2]*rt+h[vt+3]*nt)}return 27*(n+s+l+c+u)}},"undefined"!=typeof define&&define.amd&&define(function(){return e}),"undefined"!=typeof exports?exports.SimplexNoise=e:"undefined"!=typeof navigator&&(this.SimplexNoise=e),"undefined"!=typeof module&&(module.exports=e)}();var MersenneTwister=function(e){void 0==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,this.init_genrand(e)};MersenneTwister.prototype.init_genrand=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++){var e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0}},MersenneTwister.prototype.init_by_array=function(e,t){var i,r,n;for(this.init_genrand(19650218),i=1,r=0,n=this.N>t?this.N:t;n;n--){var a=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&a)>>>16)<<16)+1664525*(65535&a))+e[r]+r,this.mt[i]>>>=0,i++,r++,i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),r>=t&&(r=0)}for(n=this.N-1;n;n--){var a=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1566083941*((4294901760&a)>>>16)<<16)+1566083941*(65535&a))-i,this.mt[i]>>>=0,i++,i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1)}this.mt[0]=2147483648},MersenneTwister.prototype.genrand_int32=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_genrand(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,e^=e>>>18,e>>>0},MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>>1},MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967295)},MersenneTwister.prototype.random=function(){return this.genrand_int32()*(1/4294967296)},MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)},MersenneTwister.prototype.genrand_res53=function(){var e=this.genrand_int32()>>>5,t=this.genrand_int32()>>>6;return(67108864*e+t)*(1/9007199254740992)};var prng=new MersenneTwister(0),simplex1=new SimplexNoise(prng.random.bind(prng)),simplex2=new SimplexNoise(prng.random.bind(prng)),factor=50,tileTypes={water:0,steppe:1,hill:2,mountain:3,swamp:4,meadow:5,forest:6,taiga:7,farm:8,residence:9,skyscraper:10,factory:11,dock:12,airland:13,airport:14,gunsmith:15,road:16,wall:17,blackdeath:18,metal:19,lumber:20,mine:21,industry:22,citrus:23,hospital:24,beach:25,arsenal:26,smoke:27,impact:28,curvedRoad:29,whales:30,pearls:31,fish:32,algae:33,pigments:34,salt:35,cattle:36,poultry:37,ivory:38,granite:39,wool:40,wine:41,fur:42,glass:43,rubber:44,marble:45,crocodile:46,petroleum:47,shrimp:48,clay:49,spices:50,cotton:51,coffee:52,tea:53,resin:54,cocoa:55,honey:56,silk:57,ruby:58,gems:59,pelt:60,amber:61,field:62},buildingTypes=[8,9,10,11,12,13,14,15,16,17,20,21,22,24,26,62],resourceTypes={stock:-1,production:-2,wealth:-3},listOfResourceTypes=[resourceTypes.stock,resourceTypes.production,resourceTypes.wealth],tileVegetationTypeFromSteepness=[];tileVegetationTypeFromSteepness[tileTypes.water]=tileTypes.swamp,tileVegetationTypeFromSteepness[tileTypes.steppe]=tileTypes.meadow,tileVegetationTypeFromSteepness[tileTypes.hill]=tileTypes.forest,tileVegetationTypeFromSteepness[tileTypes.mountain]=tileTypes.taiga;var distances=[];distances[tileTypes.water]=2989,distances[tileTypes.steppe]=2,distances[tileTypes.hill]=4,distances[tileTypes.mountain]=16,distances[tileTypes.swamp]=8,distances[tileTypes.meadow]=3,distances[tileTypes.forest]=8,distances[tileTypes.taiga]=24,distances[tileTypes.road]=1,distances[tileTypes.wall]=32;var normalWater=distances[tileTypes.water],normalSwamp=distances[tileTypes.swamp],MAX_INT=9007199254740992,manufacture={boat:1,car:2,plane:4,artillery:8,gun:16},buildingDependencies=[,,,,,,,,,[[2,tileTypes.farm]],[[6,tileTypes.residence]],[[3,tileTypes.residence],[2,tileTypes.road]],[[1,tileTypes.residence],[1,tileTypes.water],[1,resourceTypes.stock]],[[2,tileTypes.road]],[[1,tileTypes.gunsmith],[3,tileTypes.airland],[1,resourceTypes.stock]],[[1,tileTypes.skyscraper],[1,tileTypes.factory]],,,,,[[1,tileTypes.residence]],[[1,resourceTypes.stock],[1,tileTypes.factory]],[[10,resourceTypes.wealth],[1,tileTypes.mine],[5,tileTypes.road]],,[[1,resourceTypes.production],[20,resourceTypes.wealth],[2,tileTypes.wall]],,[[1,tileTypes.gunsmith],[1,resourceTypes.production]],,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,[]],buildingTileDependency=[,,,,,,,,,,,,,,,,,,,,[tileTypes.forest,tileTypes.taiga],[tileTypes.metal],,,[tileTypes.citrus],[tileTypes.steppe]],planTypes={move:1,build:2};Terrain.prototype={humanity:null,centerTile:{q:0,r:0},centerPoint:{x:0,y:0},tileTypes:tileTypes,buildingTypes:buildingTypes,resourceTypes:resourceTypes,listOfResourceTypes:listOfResourceTypes,tileType:tileType,heatmap:heatmap,setCenterTile:function(e){this.centerTile=e,this.centerPoint.x=Math.sqrt(3)*(e.q+e.r/2)|0,this.centerPoint.y=1.5*e.r},continent:function(e,t){var i=512,r=heatmap(e,t,simplex1,i,8),n=this.centerPoint,a=(e-n.x)*(e-n.x)+(t-n.y)*(t-n.y),o=heatmap(e,t,simplex1,4*i,8),s=+(r+.7)*Math.exp(-a/(i*i));return o>s&&(s=o),s=Math.min(1,s)},continentLimit:.42,tile:function e(t){var i,r;void 0===t.x?(i=Math.sqrt(3)*(t.q+t.r/2)|0,r=1.5*t.r):(i=t.x,r=t.y);var n=simplex2.noise2D(r/500,i/500),a=1-Math.abs((4*simplex1.noise2D(i/4/factor,r/4/factor)+2*simplex1.noise2D(i/2/factor,r/2/factor)+1*simplex1.noise2D(i/1/factor,r/1/factor)+.5*simplex1.noise2D(2*i/factor,2*r/factor))/7.5),o=Math.sin(-(5*n)*Math.abs(simplex1.noise2D(.25*i/factor,.25*r/factor))+simplex1.noise2D(i/factor,r/factor)-.5*simplex1.noise2D(2*i/factor,2*r/factor)+.25*simplex1.noise2D(4*i/factor,4*r/factor)-1/8*simplex1.noise2D(8*i/factor,8*r/factor)+1/16*simplex1.noise2D(16*i/factor,16*r/factor)),s=-simplex2.noise2D(r/factor/8,i/factor/8)+simplex2.noise2D(r/factor/4,i/factor/4)+o/2,l=n*simplex2.noise2D(i/factor,r/factor)+.5*simplex2.noise2D(2*i/factor,2*r/factor)+.25*simplex2.noise2D(4*i/factor,4*r/factor)+1/8*simplex2.noise2D(8*i/factor,8*r/factor)+1/16*simplex2.noise2D(16*i/factor,16*r/factor),c=o-a,u=this.continent(i,r);if(u>this.continentLimit)var d,h=-1.3,m=(o>.6?!1:a>.98)||-1>3*s/4+o/4?(d=(-1.5-h)/(this.continentLimit-1),c=u*d+h-d,tileTypes.water):-1>l?tileTypes.hill:-.2>c?tileTypes.steppe:.2>c?tileTypes.hill:tileTypes.mountain,p=l-(m===tileTypes.water?2*s:0)+Math.abs(o+.15)<0;else{var m=tileTypes.water,p=!1,g=u-1.92;c=g}var e={steepness:m,vegetation:p,type:this.tileType(m,p),height:c,rain:-l/2};return e},commodity:function(e,t){var i,r=e.q,n=e.r,a=(-simplex1.noise2D(r/60,n/60)/8+1)/2,o=(simplex1.noise2D(r/60,n/60)/8+1)/2,s=(-simplex2.noise2D(r/60,n/60)/8+1)/2,l=(simplex2.noise2D(r/60,n/60)/8+1)/2,c=a*simplex1.noise2D(r/4,n/4),u=o*simplex1.noise2D(r/16,n/16),d=s*simplex2.noise2D(r/2,n/2),h=l*simplex2.noise2D(r/8,n/8);if(c>.49)i=0;else if(u>.49)i=1;else if(d>.45)i=2;else{if(!(h>.45))return-1;i=3}var m;return m=null!=t?t.type:this.tile(e).type,tileTypes.whales+(m<<2)+i},distances:distances,distance:function(e){var t=this.tile(e),i=this.humanity.tile(e),r=distances[i&&i.b?i.b:t.type];return void 0===r&&(r=distances[t.type]),r},distanceBetweenTiles:function(e,t){return(Math.abs(e.q-t.q)+Math.abs(e.r-t.r)+Math.abs(e.q+e.r-t.q-t.r))/2},neighborFromTile:function(e,t){return 0===t?{q:e.q+1,r:e.r}:1===t?{q:e.q+1,r:e.r-1}:2===t?{q:e.q,r:e.r-1}:3===t?{q:e.q-1,r:e.r}:4===t?{q:e.q-1,r:e.r+1}:5===t?{q:e.q,r:e.r+1}:void 0},keyFromTile:function(e){return e.q+":"+e.r},tileFromKey:function(e){var t=e.split(":");return{q:0|t[0],r:0|t[1]}},manufacture:manufacture,manufactureFromBuilding:function(e){return e===tileTypes.dock?manufacture.boat:e===tileTypes.factory?manufacture.car:e===tileTypes.airport?manufacture.plane:e===tileTypes.gunsmith?manufacture.gun:null},speedFromHuman:function(e){return 0!==(e.o&manufacture.plane)?32:0!==(e.o&manufacture.car)?16:8},travelFrom:function(e,t){var i=this.humanity.tile(e).c,r={},n=this.keyFromTile(e);r[n]=null;var a={};a[n]=0;var o=[];for(o.push(n);o.length>0;){n=o.shift();var s=this.humanity.tile(this.tileFromKey(n));if(!s||null==s.c||s.c===i)for(var l=0;6>l;l++){var c=this.neighborFromTile(this.tileFromKey(n),l),u=a[n]+this.distance(c);if(t>=u){var d=this.keyFromTile(c);if(void 0!==a[d]&&u<a[d]&&delete a[d],void 0===a[d]&&void 0===r[d]){a[d]=u,r[d]=n;for(var h=-1,m=0;m<o.length;m++)if(void 0!==a[o[m]]){if(a[d]<=a[o[m]]){h=m;break}}else o.splice(m,1),m--;-1===h?o.push(d):o.splice(h,0,d)}}}}return r},travelTo:function(e,t,i,r,n,a){null==n&&(n=MAX_INT),null==a&&(a=this.humanity.tile(e));var o=a.c,s=this.keyFromTile(t),l={},c={},u={},d=[],h={},m=this.keyFromTile(e);for(h[m]=null,c[m]=0,d.push(m);d.length>0&&s!==m;){m=d.shift(),l[m]=!0;var p=this.humanity.tile(this.tileFromKey(m));if(!p||null==p.c||p.c===o)for(var g=0;6>g;g++){var y=this.neighborFromTile(this.tileFromKey(m),g),f=this.distance(y);if(!(f>i)){if(0>=n)return null;n--;var v=c[m]+f;if(!(r&&v>i)){var T=this.keyFromTile(y);if(void 0!==c[T]&&v<c[T]&&delete c[T],void 0===c[T]&&void 0===l[T]){c[T]=v,u[T]=v+(Math.abs(t.q-y.q)+Math.abs(t.r-y.r)+Math.abs(t.q+t.r-y.q-y.r))/2;for(var x=-1,w=0;w<d.length;w++)if(void 0!==u[d[w]]){if(u[T]<=u[d[w]]){x=w;break}}else d.splice(w,1),w--;-1===x?d.push(T):d.splice(x,0,T),h[T]=m}}}}}return s!==m?null:{endKey:s,parents:h,costs:c}},pathFromParents:function(e,t){var i=[];if(null==t[e])return[];for(;null!==t[e];)i.push(e),e=t[e];return i.push(e),i.reverse()},setDistancesForHuman:function(e){0!==(e.o&manufacture.boat)?(this.distances[tileTypes.water]=1,this.distances[tileTypes.swamp]=1):0!==(e.o&manufacture.plane)&&(this.distances[tileTypes.water]=2,this.distances[tileTypes.swamp]=2)},unsetDistancesForHuman:function(){this.distances[tileTypes.water]=normalWater,this.distances[tileTypes.swamp]=normalSwamp},humanTravelFrom:function(e){var t=this.humanity.tile(e);if(!t||t.h<=0)return{};this.setDistancesForHuman(t);var i=this.travelFrom(e,this.speedFromHuman(t));return this.unsetDistancesForHuman(t),i},humanTravelTo:function(e,t,i,r,n){if(null==n&&(n=this.humanity.tile(e)),!n||n.h<=0)return null;this.setDistancesForHuman(n);var a=this.travelTo(e,t,this.speedFromHuman(n),i,r,n);return this.unsetDistancesForHuman(n),a},humanTravelPath:function(e,t){var i=this.humanTravelTo(e,t);return null==i?[]:this.pathFromParents(i.endKey,i.parents)},humanTravelSpeedPath:function(e,t){var i=this.humanTravelTo(e,t,!0);return null==i?[]:this.pathFromParents(i.endKey,i.parents)},buildingDependencies:buildingDependencies,buildingTileDependency:buildingTileDependency,validConstruction:function(e,t,i){if(null==e)return!0;var r=this.humanity.tile(t),n=this.tile(t),a=i.stock-i.usedStock,o=i.production-i.usedProduction,s=i.wealth-i.usedWealth;if(!r||r.h<=0)return!1;if(e===tileTypes.field)return this.commodity(t,n)>=0;if(n.type===tileTypes.water&&(e===tileTypes.farm||e===tileTypes.residence||e===tileTypes.skyscraper||e===tileTypes.factory||e===tileTypes.airland||e===tileTypes.airport||e===tileTypes.gunsmith))return!1;if(void 0!==buildingTileDependency[e]){for(var l=!1,c=0;c<buildingTileDependency[e].length;c++)(buildingTileDependency[e][c]===n.type||buildingTileDependency[e][c]===r.b)&&(l=!0);if(!l)return!1}if(void 0!==buildingDependencies[e]){for(var u=buildingDependencies[e],d=new Array(u.length),c=0;c<d.length;c++)d[c]=0;for(var c=0;6>c;c++)for(var h=this.neighborFromTile(t,c),m=this.humanity.tile(h),p=this.tile(h),g=0;g<u.length;g++)if(u[g][1]>=0&&m&&m.b===u[g][1]||p.type===u[g][1])d[g]++;else if(u[g][1]<0){if(u[g][1]===resourceTypes.stock&&a<u[g][0])return!1;if(u[g][1]===resourceTypes.production&&o<u[g][0])return!1;if(u[g][1]===resourceTypes.wealth&&s<u[g][0])return!1;d[g]=u[g][0]}for(var g=0;g<d.length;g++)if(d[g]<u[g][0])return!1;return!0}return!0},planTypes:planTypes,plans:{},addPlan:function(e){plans[e.at]=e},eachPlan:function(e){for(var t in plans)e(plans[t])},clearPlans:function(){plans={}}};var gameOver,socket,retries=0;connectSocket();var registerMoves=Object.create(null),registerBuilds=Object.create(null),sendCenterTile=function(e){for(var t=0;t<workerPool.length;t++)workerPool[t].postMessage({centerTile:e})},campNames,defaultPlacesPanelHTML=placesPanel.innerHTML,resourceFromName={Folks:campResourcePopulation,Wealth:campResourceWealth,Stock:campResourceStock,Production:campResourceProduction,Health:campResourceHealth},humanityData={},humanityPopulation,playerCamp,resources={wealth:0,usedWealth:0,stock:0,usedStock:0,production:0,usedProduction:0},campResources,humanity={tile:function(e){return humanityData[e.q+":"+e.r]}},terrain=new Terrain(humanity),helpPane=document.getElementById("helpPane");addEventListener("load",function(){localStorage.getItem("firstRun")?Math.random()<.5&&localStorage.getItem("paid")!==""+(new Date).getFullYear()&&showHelp("intro"):localStorage.setItem("firstRun","no")}),buildPanel.firstElementChild.onclick=function(){showHelp("build")};var sprites=loadSprites("sprites.png"),spritesLoaded=!1;sprites.onload=function(){spritesLoaded=!0,paint(gs)};var canvas=document.getElementById("canvas");canvas.width=document.documentElement.clientWidth,canvas.height=document.documentElement.clientHeight;var gs=makeGraphicState(canvas,sprites),globalGs=gs;document.styleSheets[0].insertRule("div.controlPanel { max-height:"+(gs.height-16-58)+"px; }",0);var πx2=2*Math.PI,mπd3=-Math.PI/3,cachedTerrainPaint={},workerCanvasBuffer=document.createElement("canvas");workerCanvasBuffer.width=gs.width,workerCanvasBuffer.height=gs.height;var workerImageBuffer=workerCanvasBuffer.getContext("2d").getImageData(0,0,gs.width,gs.height),workerMessage={image:null,size:gs.hexSize,origin:gs.origin},workerPool=[new Worker("render-worker.js"),new Worker("render-worker.js"),new Worker("render-worker.js"),new Worker("render-worker.js")],workerPoolRoundRobin=0,cachedPaint={},cachePending={},displayedPaint=document.createElement("canvas");displayedPaint.width=gs.width,displayedPaint.height=gs.height;var displayedPaintContext=displayedPaint.getContext("2d"),showTitleScreen=!0;setTimeout(function(){showTitleScreen=!1},2e3);var mapIndex=Object.create(null),numberOfHumanAnimations=20,humanAnimation=new Array(numberOfHumanAnimations);initHumans();var humanAnimationTimeout=setInterval(animateHumans,100);InterpolationAnimation.prototype={draw:function(){if(this.drawFunction(),this.pos.x+=this.dx,this.pos.y+=this.dy,this.usedPortions++,this.usedPortions>this.portions){var e=movementAnimations.indexOf(this);movementAnimations.splice(e,1)}}};var movementAnimations=[],animationVelocity=32,numberOfCamps=3,campHue=[],surrenderMessages=["We surrender!","I give up!","Enemies captured!","I, for one, welcome our new overlords."],hungerMessages=["Make a farm.","Hungry!","Is dinner ready?","I can't feel my stomach!","You're starving us!","I could eat anything. Rats. Babies.","You look like a sandwich to me."],warMessages=["You've got red on you.","Silence will fall!","Silence! I kill you!","Boy, that escalated quickly.","Sorry Mommy!","New legs, please!","Have you seen my head?","There is wine on the floor…","They're bleeding demised!","Them ex-people make daisies happy.","⬐ Acclimated to the being dead position","So much for survival!","Today I died.","I dare you! I double-dare you!","Mayday!","Area pacified, over!","Resistance is futile.","All your base are belong to us.","Nobody expects the Spanish Inquisition!","Whoop-de-doo!","You'll never take me alive!","Told you he wasn't immortal!","Tu quoque, fili mi!","Do not disturb my circles!","This is no time to be making enemies.","I owe a cock to Asclepius.","More light!","Life's too short!","What will you do, kill m—?!","Drink to me!"],warTiles={},surrenderTiles={},starvedTiles={},tileNames=attributeNameFromTile(),tileInfo=document.getElementById("info"),lockedTiles,accessibleTiles,currentTile,buildSelectionButtons=document.querySelectorAll("p.buildSelection");hookBuildSelectionButtons();var selectionModes={normal:1,settings:2,travel:3,build:4,places:5},selectionMode=selectionModes.normal;travelBut.addEventListener("click",enterTravelMode),buildBut.addEventListener("click",enterBuildMode),settingsBut.addEventListener("click",enterSettingsMode),placesBut.addEventListener("click",enterPlacesMode),splitInputWidget.addEventListener("input",function(){splitPanelPortion.textContent=""+splitInputWidget.value,splitPanelSetMoveStay()});var buildHotKeys={48:tileTypes.airport,51:tileTypes.farm,52:tileTypes.residence,53:tileTypes.skyscraper,54:tileTypes.factory,55:tileTypes.dock,56:tileTypes.gunsmith,57:tileTypes.airland};window.onkeydown=function(e){var t=!1,i=!1;39===e.keyCode||68===e.keyCode?(gs.origin.x0+=gs.width/2|0,i=!0):38===e.keyCode||87===e.keyCode?(gs.origin.y0-=gs.height/2|0,i=!0):37===e.keyCode||65===e.keyCode?(gs.origin.x0-=gs.width/2|0,i=!0):40===e.keyCode||83===e.keyCode?(gs.origin.y0+=gs.height/2|0,i=!0):187===e.keyCode||61===e.keyCode?(gs.hexSize*=4,gs.origin.x0=4*gs.origin.x0+1.5*gs.width|0,gs.origin.y0=4*gs.origin.y0+1.5*gs.height|0,t=!0,i=!0):173===e.keyCode||189===e.keyCode||109===e.keyCode||219===e.keyCode||169===e.keyCode?(gs.hexSize/=4,gs.origin.x0=(gs.origin.x0/4|0)-(gs.width*(3/8)|0),gs.origin.y0=(gs.origin.y0/4|0)-(gs.height*(3/8)|0),t=!0,i=!0):84===e.keyCode?(splitPanelSlider(100),enterMode(selectionModes.travel)):70===e.keyCode?(splitPanelSlider(50),enterMode(selectionModes.travel)):67===e.keyCode?enterMode(selectionModes.build):192===e.keyCode?sendBuild(currentTile,null):27===e.keyCode?(enterMode(selectionModes.normal),helpPane.style.display="none"):48<=e.keyCode&&e.keyCode<=57&&sendBuild(currentTile,buildHotKeys[e.keyCode]),t&&(cachedPaint={}),i&&paint(gs)};var mousePosition,targetTile;canvas.addEventListener("mousemove",showPath),gs.canvas.onmousedown=function(e){0===e.button?(gs.canvas.addEventListener("mouseup",mouseSelection),gs.canvas.addEventListener("mousemove",mouseDrag),lastMousePosition.clientX=e.clientX,lastMousePosition.clientY=e.clientY):2===e.button&&(enterTravelMode(),splitPanelSlider(100),mouseSelection(e),enterNormalMode())},gs.canvas.oncontextmenu=function(e){e.preventDefault()},function(){var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,0)};window.requestAnimationFrame=e}();var lastMousePosition={clientX:0,clientY:0},drawingWhileDragging=!1,currentlyDragging=!1;canvas.onselectstart=function(){return!1};var dragVelocity=[0,0],dragVector=[0,0],dragTime=0,dragVelTo,dragVelInterval=200;