!function(){var C=.5*(Math.sqrt(3)-1),D=(3-Math.sqrt(3))/6,_=1/6,me=(Math.sqrt(5)-1)/4,pe=(5-Math.sqrt(5))/20;function e(e){e||(e=Math.random),this.p=new Uint8Array(256),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var t=0;t<256;t++)this.p[t]=256*e();for(t=0;t<512;t++)this.perm[t]=this.p[255&t],this.permMod12[t]=this.perm[t]%12}e.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(e,t){var i,r,n=this.permMod12,a=this.perm,o=this.grad3,s=0,l=0,c=0,u=(e+t)*C,d=Math.floor(e+u),h=Math.floor(t+u),m=(d+h)*D,p=e-(d-m),g=t-(h-m);g<p?(i=1,r=0):(i=0,r=1);var y=p-i+D,f=g-r+D,v=p-1+2*D,T=g-1+2*D,x=255&d,w=255&h,M=.5-p*p-g*g;if(0<=M){var P=3*n[x+a[w]];s=(M*=M)*M*(o[P]*p+o[P+1]*g)}var k=.5-y*y-f*f;if(0<=k){var b=3*n[x+i+a[w+r]];l=(k*=k)*k*(o[b]*y+o[b+1]*f)}var F=.5-v*v-T*T;if(0<=F){var S=3*n[x+1+a[w+1]];c=(F*=F)*F*(o[S]*v+o[S+1]*T)}return 70*(s+l+c)},noise3D:function(e,t,i){var r,n,a,o,s,l,c,u,d,h,m=this.permMod12,p=this.perm,g=this.grad3,y=(e+t+i)*(1/3),f=Math.floor(e+y),v=Math.floor(t+y),T=Math.floor(i+y),x=(f+v+T)*_,w=e-(f-x),M=t-(v-x),P=i-(T-x);M<=w?P<=M?(d=u=s=1,h=c=l=0):P<=w?(d=c=l=0,h=u=s=1):(d=l=s=0,h=u=c=1):M<P?(u=l=s=0,h=d=c=1):w<P?(u=c=s=0,h=d=l=1):(d=u=l=1,h=c=s=0);var k=w-s+_,b=M-l+_,F=P-c+_,S=w-u+2*_,C=M-d+2*_,D=P-h+2*_,R=w-1+.5,H=M-1+.5,A=P-1+.5,B=255&f,I=255&v,q=255&T,L=.6-w*w-M*M-P*P;if(L<0)r=0;else{var N=3*m[B+p[I+p[q]]];r=(L*=L)*L*(g[N]*w+g[N+1]*M+g[N+2]*P)}var E=.6-k*k-b*b-F*F;if(E<0)n=0;else{var W=3*m[B+s+p[I+l+p[q+c]]];n=(E*=E)*E*(g[W]*k+g[W+1]*b+g[W+2]*F)}var z=.6-S*S-C*C-D*D;if(z<0)a=0;else{var O=3*m[B+u+p[I+d+p[q+h]]];a=(z*=z)*z*(g[O]*S+g[O+1]*C+g[O+2]*D)}var V=.6-R*R-H*H-A*A;if(V<0)o=0;else{var K=3*m[B+1+p[I+1+p[q+1]]];o=(V*=V)*V*(g[K]*R+g[K+1]*H+g[K+2]*A)}return 32*(r+n+a+o)},noise4D:function(e,t,i,r){this.permMod12;var n,a,o,s,l,c,u,d,h,m,p,g,y,f,v,T,x,w=this.perm,M=this.grad4,P=(e+t+i+r)*me,k=Math.floor(e+P),b=Math.floor(t+P),F=Math.floor(i+P),S=Math.floor(r+P),C=(k+b+F+S)*pe,D=e-(k-C),R=t-(b-C),H=i-(F-C),A=r-(S-C),B=0,I=0,q=0,L=0;R<D?B++:I++,H<D?B++:q++,A<D?B++:L++,H<R?I++:q++,A<R?I++:L++,A<H?q++:L++;var N=D-(c=3<=B?1:0)+pe,E=R-(u=3<=I?1:0)+pe,W=H-(d=3<=q?1:0)+pe,z=A-(h=3<=L?1:0)+pe,O=D-(m=2<=B?1:0)+2*pe,V=R-(p=2<=I?1:0)+2*pe,K=H-(g=2<=q?1:0)+2*pe,_=A-(y=2<=L?1:0)+2*pe,Y=D-(f=1<=B?1:0)+3*pe,X=R-(v=1<=I?1:0)+3*pe,U=H-(T=1<=q?1:0)+3*pe,j=A-(x=1<=L?1:0)+3*pe,G=D-1+4*pe,J=R-1+4*pe,Q=H-1+4*pe,Z=A-1+4*pe,$=255&k,ee=255&b,te=255&F,ie=255&S,re=.6-D*D-R*R-H*H-A*A;if(re<0)n=0;else{var ne=w[$+w[ee+w[te+w[ie]]]]%32*4;n=(re*=re)*re*(M[ne]*D+M[ne+1]*R+M[ne+2]*H+M[ne+3]*A)}var ae=.6-N*N-E*E-W*W-z*z;if(ae<0)a=0;else{var oe=w[$+c+w[ee+u+w[te+d+w[ie+h]]]]%32*4;a=(ae*=ae)*ae*(M[oe]*N+M[oe+1]*E+M[oe+2]*W+M[oe+3]*z)}var se=.6-O*O-V*V-K*K-_*_;if(se<0)o=0;else{var le=w[$+m+w[ee+p+w[te+g+w[ie+y]]]]%32*4;o=(se*=se)*se*(M[le]*O+M[le+1]*V+M[le+2]*K+M[le+3]*_)}var ce=.6-Y*Y-X*X-U*U-j*j;if(ce<0)s=0;else{var ue=w[$+f+w[ee+v+w[te+T+w[ie+x]]]]%32*4;s=(ce*=ce)*ce*(M[ue]*Y+M[ue+1]*X+M[ue+2]*U+M[ue+3]*j)}var de=.6-G*G-J*J-Q*Q-Z*Z;if(de<0)l=0;else{var he=w[$+1+w[ee+1+w[te+1+w[ie+1]]]]%32*4;l=(de*=de)*de*(M[he]*G+M[he+1]*J+M[he+2]*Q+M[he+3]*Z)}return 27*(n+a+o+s+l)}},"undefined"!=typeof define&&define.amd&&define(function(){return e}),"undefined"!=typeof exports?exports.SimplexNoise=e:"undefined"!=typeof navigator&&(this.SimplexNoise=e),"undefined"!=typeof module&&(module.exports=e)}();var MersenneTwister=function(e){null==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,this.init_genrand(e)};MersenneTwister.prototype.init_genrand=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++){e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0}},MersenneTwister.prototype.init_by_array=function(e,t){var i,r,n;for(this.init_genrand(19650218),i=1,r=0,n=this.N>t?this.N:t;n;n--){var a=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&a)>>>16)<<16)+1664525*(65535&a))+e[r]+r,this.mt[i]>>>=0,r++,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),t<=r&&(r=0)}for(n=this.N-1;n;n--){a=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1566083941*((4294901760&a)>>>16)<<16)+1566083941*(65535&a))-i,this.mt[i]>>>=0,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1)}this.mt[0]=2147483648},MersenneTwister.prototype.genrand_int32=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_genrand(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,(e^=e>>>18)>>>0},MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>>1},MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967295)},MersenneTwister.prototype.random=function(){return this.genrand_int32()*(1/4294967296)},MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)},MersenneTwister.prototype.genrand_res53=function(){return(67108864*(this.genrand_int32()>>>5)+(this.genrand_int32()>>>6))*(1/9007199254740992)};var prng=new MersenneTwister(0),simplex1=new SimplexNoise(prng.random.bind(prng)),simplex2=new SimplexNoise(prng.random.bind(prng)),factor=50,tileTypes={water:0,steppe:1,hill:2,mountain:3,swamp:4,meadow:5,forest:6,taiga:7,farm:8,residence:9,skyscraper:10,factory:11,dock:12,airland:13,airport:14,gunsmith:15,road:16,wall:17,blackdeath:18,metal:19,lumber:20,mine:21,industry:22,citrus:23,university:24,beach:25,arsenal:26,smoke:27,impact:28,curvedRoad:29,whales:30,pearls:31,fish:32,algae:33,glass:34,salt:35,cattle:36,poultry:37,ivory:38,limestone:39,wool:40,grapes:41,fur:42,pigments:43,rubber:44,coal:45,crocodile:46,petroleum:47,shrimp:48,clay:49,spices:50,cotton:51,coffee:52,tea:53,resin:54,cocoa:55,honey:56,silk:57,gems:58,fungus:59,pelt:60,amber:61,field:62,market:63,"space mission":64,"stock exchange":65,monument:66},buildingTypes=[8,9,10,11,12,13,14,15,16,17,20,21,22,24,26,62,63,64,65,66],resourceTypes={fuel:-1,metal:-2,wealth:-3},listOfResourceTypes=[resourceTypes.fuel,resourceTypes.metal,resourceTypes.wealth];function setupStringFromTileType(){var e=Object.create(null);for(var t in tileTypes)e[tileTypes[t]]=t;for(var t in resourceTypes)e[resourceTypes[t]]=t;return e}var stringFromTileType=setupStringFromTileType(),tileVegetationTypeFromSteepness=[];function tileType(e,t){return t?tileVegetationTypeFromSteepness[e]:e}function heatmap(e,t,i,r,n){for(var a=0,o=0,s=0;s<n;s++){var l=Math.pow(2,s);a+=i.noise2D(e/r*l,t/r*l)/l,o+=1/l}return a/o}tileVegetationTypeFromSteepness[tileTypes.water]=tileTypes.swamp,tileVegetationTypeFromSteepness[tileTypes.steppe]=tileTypes.meadow,tileVegetationTypeFromSteepness[tileTypes.hill]=tileTypes.forest,tileVegetationTypeFromSteepness[tileTypes.mountain]=tileTypes.taiga;var gameOver,socket,distancesNormal=[17,2,4,16,8,3,8,24,,,,,,,,,1,32],distancesBoat=[1,4,8,16,1,8,16,24,,,,,,,,,1,32],distancesPlane=[1,1,2,2,1,1,2,2,,,,,,,,,1,8],MAX_INT=9007199254740992,manufacture={boat:1,car:2,plane:4,artillery:8,gun:16},buildingDependencies=[,,,,,,,,,[[2,tileTypes.farm]],[[6,tileTypes.residence]],[[3,tileTypes.residence]],[[1,tileTypes.residence],[1,tileTypes.water],[1,resourceTypes.fuel]],[[2,tileTypes.road]],[[1,tileTypes.gunsmith],[3,tileTypes.airland],[1,resourceTypes.fuel]],[[1,tileTypes.skyscraper],[1,tileTypes.factory]],,,,,[[1,tileTypes.residence]],[[1,resourceTypes.fuel],[1,tileTypes.factory]],[[10,resourceTypes.wealth],[1,tileTypes.mine],[5,tileTypes.road]],,[[1,tileTypes.meadow],[1,tileTypes.water],[2,tileTypes.residence]],,[[1,tileTypes.gunsmith],[1,resourceTypes.metal]],,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,[],[[1,tileTypes.dock],[1,tileTypes.skyscraper],[4,resourceTypes.metal]],[[2,tileTypes.airport],[20,resourceTypes.metal],[20,resourceTypes.fuel]],[[1,tileTypes.market],[1,tileTypes.university],[200,resourceTypes.wealth],[20,resourceTypes.metal]],[[3,tileTypes.skyscraper],[200,resourceTypes.wealth],[20,resourceTypes.fuel]]],buildingTileDependency=[,,,,,,,,,,,,,,,,,,,,[tileTypes.forest,tileTypes.taiga],[tileTypes.metal],,,,,[tileTypes.steppe]],planTypes={move:1,build:2};function Terrain(e){this.humanity=e,this.plans={}}Terrain.prototype={humanity:null,centerTile:{q:0,r:0},centerPoint:{x:0,y:0},tileTypes:tileTypes,buildingTypes:buildingTypes,resourceTypes:resourceTypes,listOfResourceTypes:listOfResourceTypes,stringFromTileType:function(e){return stringFromTileType[e]},tileType:tileType,heatmap:heatmap,setCenterTile:function(e){this.centerTile=e,this.centerPoint.x=Math.sqrt(3)*(e.q+e.r/2)|0,this.centerPoint.y=1.5*e.r},continent:function(e,t){var i=heatmap(e,t,simplex1,512,8),r=this.centerPoint,n=(e-r.x)*(e-r.x)+(t-r.y)*(t-r.y),a=heatmap(e,t,simplex1,2048,8),o=+(i+.7)*Math.exp(-n/262144);return o<a&&(o=a),o=Math.min(1,o)},continentLimit:.42,tile:function(e){var t,i;void 0===e.x?(t=Math.sqrt(3)*(e.q+e.r/2)|0,i=1.5*e.r):(t=e.x,i=e.y);var r=simplex2.noise2D(i/4/factor,t/4/factor),n=1-Math.abs((4*simplex1.noise2D(t/4/factor,i/4/factor)+2*simplex1.noise2D(t/2/factor,i/2/factor)+1*simplex1.noise2D(t/1/factor,i/1/factor)+.5*simplex1.noise2D(2*t/factor,2*i/factor))/7.5),a=Math.sin(-5*r*Math.abs(simplex1.noise2D(1/8*t/factor,1/8*i/factor))+simplex1.noise2D(t/factor,i/factor)-.5*simplex1.noise2D(2*t/factor,2*i/factor)+.25*simplex1.noise2D(4*t/factor,4*i/factor)-1/8*simplex1.noise2D(8*t/factor,8*i/factor)+1/16*simplex1.noise2D(16*t/factor,16*i/factor)),o=-simplex2.noise2D(i/factor/8,t/factor/8)+simplex2.noise2D(i/factor/4,t/factor/4)+a/2,s=r*simplex2.noise2D(t/factor,i/factor)+.5*simplex2.noise2D(2*t/factor,2*i/factor)+.25*simplex2.noise2D(4*t/factor,4*i/factor)+1/8*simplex2.noise2D(8*t/factor,8*i/factor)+1/16*simplex2.noise2D(16*t/factor,16*i/factor),l=a-n,c=this.continent(t,i);if(c>this.continentLimit)var u,d=s-((h=!(.6<a)&&.98<n||3*o/4+a/4<-1?(l=c*(u=(-1.5- -1.3)/(this.continentLimit-1))-1.3-u,tileTypes.water):s<-1?tileTypes.hill:l<-.2?tileTypes.steppe:l<.2?tileTypes.hill:tileTypes.mountain)===tileTypes.water?2*o:0)+Math.abs(a+.15)<0;else{var h=tileTypes.water;d=!1;l=c-1.92}var m={steepness:h,vegetation:d,type:this.tileType(h,d),height:l,rain:-s/2};return m},commodity:function(e,t){var i,r,n=e.q,a=e.r,o=(-simplex1.noise2D(n/60,a/60)/8+1)/2,s=(simplex1.noise2D(n/60,a/60)/8+1)/2,l=(-simplex2.noise2D(n/60,a/60)/8+1)/2,c=(simplex2.noise2D(n/60,a/60)/8+1)/2,u=o*simplex1.noise2D(n/4,a/4),d=s*simplex1.noise2D(n/16,a/16),h=l*simplex2.noise2D(n/2,a/2),m=c*simplex2.noise2D(n/8,a/8);if(.49<u)i=0;else if(.49<d)i=1;else if(.45<h)i=2;else{if(!(.45<m))return-1;i=3}return r=null!=t?t.type:this.tile(e).type,tileTypes.whales+(r<<2)+i},distances:distancesNormal,distance:function(e){var t=this.tile(e),i=this.humanity.tile(e),r=this.distances[i&&i.b?i.b:t.type];return void 0===r&&(r=this.distances[t.type]),r},distanceBetweenTiles:function(e,t){return(Math.abs(e.q-t.q)+Math.abs(e.r-t.r)+Math.abs(e.q+e.r-t.q-t.r))/2},neighborFromTile:function(e,t){return 0===t?{q:e.q+1,r:e.r}:1===t?{q:e.q+1,r:e.r-1}:2===t?{q:e.q,r:e.r-1}:3===t?{q:e.q-1,r:e.r}:4===t?{q:e.q-1,r:e.r+1}:5===t?{q:e.q,r:e.r+1}:void 0},keyFromTile:function(e){return e.q+":"+e.r},tileFromKey:function(e){var t=e.split(":");return{q:0|t[0],r:0|t[1]}},manufacture:manufacture,manufactureFromBuilding:function(e){return e===tileTypes.dock?manufacture.boat:e===tileTypes.factory?manufacture.car:e===tileTypes.airport?manufacture.plane:e===tileTypes.gunsmith?manufacture.gun:null},speedFromHuman:function(e){var t=8;return 0!=(e.o&manufacture.car)&&(t+=8),t},travelFrom:function(e,t){var i=this.humanity.tile(e).c,r={},n=this.keyFromTile(e);r[n]=null;var a={};a[n]=0;var o=[];for(o.push(n);0<o.length;){n=o.shift();var s=this.humanity.tile(this.tileFromKey(n));if(!s||null==s.c||s.c===i)for(var l=0;l<6;l++){var c=this.neighborFromTile(this.tileFromKey(n),l),u=a[n]+this.distance(c);if(u<=t){var d=this.keyFromTile(c);if(void 0!==a[d]&&u<a[d]&&delete a[d],void 0===a[d]&&void 0===r[d]){a[d]=u,r[d]=n;for(var h=-1,m=0;m<o.length;m++)if(void 0!==a[o[m]]){if(a[d]<=a[o[m]]){h=m;break}}else o.splice(m,1),m--;-1===h?o.push(d):o.splice(h,0,d)}}}}return r},travelTo:function(e,t,i,r,n,a){null==n&&(n=MAX_INT),null==a&&(a=this.humanity.tile(e));var o=a.c,s=this.keyFromTile(t),l={},c={},u={},d=[],h={},m=this.keyFromTile(e);for(h[m]=null,c[m]=0,d.push(m);0<d.length&&s!==m;){l[m=d.shift()]=!0;var p=this.humanity.tile(this.tileFromKey(m));if(!p||null==p.c||p.c===o)for(var g=0;g<6;g++){var y=this.neighborFromTile(this.tileFromKey(m),g),f=this.distance(y);if(!(i<f)){if(n<=0)return null;n--;var v=c[m]+f;if(!(r&&i<v)){var T=this.keyFromTile(y);if(void 0!==c[T]&&v<c[T]&&delete c[T],void 0===c[T]&&void 0===l[T]){c[T]=v,u[T]=v+(Math.abs(t.q-y.q)+Math.abs(t.r-y.r)+Math.abs(t.q+t.r-y.q-y.r))/2;for(var x=-1,w=0;w<d.length;w++)if(void 0!==u[d[w]]){if(u[T]<=u[d[w]]){x=w;break}}else d.splice(w,1),w--;-1===x?d.push(T):d.splice(x,0,T),h[T]=m}}}}}return s!==m?null:{endKey:s,parents:h,costs:c}},pathFromParents:function(e,t){var i=[];if(null==t[e])return[];for(;null!==t[e];)i.push(e),e=t[e];return i.push(e),i.reverse()},setDistancesForHuman:function(e){0!=(e.o&manufacture.plane)?this.distances=distancesPlane:0!=(e.o&manufacture.boat)&&(this.distances=distancesBoat)},unsetDistancesForHuman:function(e){this.distances=distancesNormal},humanTravelFrom:function(e){var t=this.humanity.tile(e);if(!t||t.h<=0)return{};this.setDistancesForHuman(t);var i=this.travelFrom(e,this.speedFromHuman(t));return this.unsetDistancesForHuman(t),i},humanTravelTo:function(e,t,i,r,n){if(null==n&&(n=this.humanity.tile(e)),!n||n.h<=0)return null;this.setDistancesForHuman(n);var a=this.travelTo(e,t,this.speedFromHuman(n),i,r,n);return this.unsetDistancesForHuman(n),a},humanTravelPath:function(e,t){var i=this.humanTravelTo(e,t);return null==i?[]:this.pathFromParents(i.endKey,i.parents)},humanTravelSpeedPath:function(e,t){var i=this.humanTravelTo(e,t,!0);return null==i?[]:this.pathFromParents(i.endKey,i.parents)},buildingDependencies:buildingDependencies,buildingTileDependency:buildingTileDependency,validConstruction:function(e,t,i){if(null==e)return!0;var r=this.humanity.tile(t),n=this.tile(t),a=i.fuel-i.usedFuel,o=i.metal-i.usedMetal,s=i.wealth-i.usedWealth;if(!r||r.h<=0)return!1;if(e===tileTypes.field)return 0<=this.commodity(t,n);if(n.type===tileTypes.water&&(e===tileTypes.farm||e===tileTypes.residence||e===tileTypes.skyscraper||e===tileTypes.factory||e===tileTypes.airland||e===tileTypes.airport||e===tileTypes.gunsmith))return!1;if(void 0!==buildingTileDependency[e]){for(var l=!1,c=0;c<buildingTileDependency[e].length;c++)buildingTileDependency[e][c]!==n.type&&buildingTileDependency[e][c]!==r.b||(l=!0);if(!l)return!1}if(void 0!==buildingDependencies[e]){var u=buildingDependencies[e],d=new Array(u.length);for(c=0;c<d.length;c++)d[c]=0;for(c=0;c<6;c++)for(var h=this.neighborFromTile(t,c),m=this.humanity.tile(h),p=this.tile(h),g=0;g<u.length;g++)if(0<=u[g][1]&&m&&m.b===u[g][1]||p.type===u[g][1])d[g]++;else if(u[g][1]<0){if(u[g][1]===resourceTypes.fuel&&a<u[g][0])return!1;if(u[g][1]===resourceTypes.metal&&o<u[g][0])return!1;if(u[g][1]===resourceTypes.wealth&&s<u[g][0])return!1;d[g]=u[g][0]}for(g=0;g<d.length;g++)if(d[g]<u[g][0])return!1;return!0}return!0},planTypes:planTypes,plans:{},addPlan:function(e){plans[e.at]=e},eachPlan:function(e){for(var t in plans)e(plans[t])},clearPlans:function(){plans={}}};var retries=0;function connectSocket(e){e=e||function(){},(socket=new WebSocket("ws"+window.location.protocol.slice(4)+"//"+window.location.hostname+(0<window.location.port.length?":"+window.location.port:"")+"/act")).onmessage=socketMessage,socket.onclose=socket.onerror=socketError,socket.onopen=function(){retries=0,e()}}function socketMessage(e){var t=JSON.parse(e.data);t.winners?((gameOver={}).winners=t.winners,gameOver.winType=t.winType,gameOver.winners[0]===playerCamp&&(localStorage.getItem("gamesWon")||localStorage.setItem("gamesWon",0),localStorage.setItem("gamesWon",+localStorage.getItem("gamesWon")+1))):(void 0!==t.camp&&(playerCamp=t.camp,delete t.camp),void 0!==t.lockedTiles&&(lockedTiles=t.lockedTiles,delete t.lockedTiles),void 0!==t.resources&&(campResources=t.resources,resources=t.resources[playerCamp],delete t.resources),void 0!==t.commodities&&(campCommodities=t.commodities,delete t.commodities),void 0!==t.population&&(humanityPopulation=t.population,delete t.population),void 0!==t.war&&(addHumanMessages(warTiles,t.war,warMessages),delete t.war),void 0!==t.surrender&&(addHumanMessages(surrenderTiles,t.surrender,surrenderMessages),delete t.surrender),void 0!==t.artilleryFire&&(addShells(movementAnimations,t.artilleryFire),delete t.artilleryFire),void 0!==t.goto&&(gotoPlace(t.goto),delete t.goto),void 0!==t.centerTile&&(terrain.setCenterTile(t.centerTile),sendCenterTile(t.centerTile),delete t.centerTile),void 0!==t.places&&(insertPlaces(t.places),fillMapIndex(t.places),delete t.places),void 0!==t.campNames&&(campNames=t.campNames,delete t.campNames),humanityPopulation&&setResourcesTable(),addStarveMessages(t),changeHumanity(humanityData,t),paintPopulation(),updateCurrentTileInformation(),updateCachedPaint(gs,t)),paint(gs),paintHumans(gs,humanityData)}function socketError(e){++retries<1?setTimeout(connectSocket,50):1===retries&&alert("You are disconnected.\nPlease reload the page.")}connectSocket();var registerMoves=Object.create(null),registerBuilds=Object.create(null);function sendMove(e,t,i){if(e&&t){var r=terrain.keyFromTile(t);if(registerMoves[r]=e,1===socket.readyState){var n=terrain.keyFromTile(e),a=layRoadBox.checked?terrain.tileTypes.road:terrain.tileTypes.wall;socket.send(JSON.stringify({at:n,do:planTypes.move,to:r,h:i,lay:a}))}else connectSocket(function(){sendMove(e,t,i)})}}function sendPos(e,t){socket.send(JSON.stringify({at:e?terrain.keyFromTile(e):null,to:terrain.keyFromTile(t)}))}function sendBuild(e,t){if(e){var i=terrain.keyFromTile(e);registerBuilds[i]=t,1===socket.readyState?socket.send(JSON.stringify({at:i,do:planTypes.build,b:t})):connectSocket(function(){sendBuild(e,t)})}}var campNames,sendCenterTile=function(e){for(var t=0;t<workerPool.length;t++)workerPool[t].postMessage({centerTile:e})},defaultPlacesPanelHTML=placesPanel.innerHTML;function insertPlaces(e){placesPanel.innerHTML=defaultPlacesPanelHTML;for(var t=Object.keys(e),i=t.length-1,r=0;r<=i;r++){var n=t[r],a=document.createElement("p");a.classList.add("buildSelection"),a.classList.add("validSelection");var o=terrain.tileFromKey(n);a.setAttribute("data-tilekey",n);var s='<div class="arrow">➢</div><span class=buildHelp></span>'+e[n];r<i&&(s+="<hr class=separator>"),a.innerHTML=s,a.addEventListener("click",function(e){return function(){gotoPlace(e),paint(gs)}}(o)),placesPanel.appendChild(a)}}var resourceFromName={Folks:campResourcePopulation,Wealth:campResourceWealth,Fuel:campResourceFuel,Metal:campResourceMetal,Health:campResourceHealth};function setResourcesTable(){for(var e="<th></th>",t=0;t<numberOfCamps;t++)e+='<th style="color:'+campHsl(t)+'">■</th>';e="<tr>"+e+"</tr>";var o="";["Folks","Wealth","Fuel","Metal","Health"].forEach(function(e){var t="",i="Wealth"===e;t+="<th>"+e+"</th>";for(var r=0;r<numberOfCamps;r++){var n=resourceFromName[e](r),a="";i&&(a=hoverWealthAction(r)),t+="<td "+a+">"+n+"</td>"}o+=t='<tr class="'+e+'">'+t+"</tr>"});var i="<table>"+("<thead>"+e+"<thead>")+("<tbody>"+o+"<tbody>")+"</table>";resourcesPanel.innerHTML=i}function capitalize(e){return String.fromCharCode(e.charCodeAt(0)-32)+e.slice(1)}function hoverResourceDisplayWealth(e){var t=campCommodities[e],i=[];for(var r in t)if(!(t[r]<=0)){for(var n=0,a=0;a<numberOfCamps;a++)n+=campCommodities[a][r]||0;var o=t[r]||0;if(0===n)var s=0;else s=o/n;var l=50*s*(2-1/o);i.push({name:capitalize(tileNames[r]),wealth:l.toFixed(0)})}var c="";if(0===i.length)c="Nothing";else{i.sort(function(e,t){return t.wealth-e.wealth});for(a=0;a<i.length;a++){var u=i[a];c+=u.name+" ("+u.wealth+")<br>"}}return c}function hoverWealthAction(e){return'onmouseover="showHoverResourceDisplayWealth(event, hoverResourceDisplayWealth('+e+'))" onmouseout="hideHoverResourceDisplay()"'}function hideHoverResourceDisplay(){hoverResourceDisplay.style.display="none"}function showHoverResourceDisplayWealth(e,t){hoverResourceDisplay.innerHTML=t,hoverResourceDisplay.style.color="#bb0";var i=e.target.getBoundingClientRect();hoverResourceDisplay.style.display="block";var r=hoverResourceDisplay.offsetWidth;hoverResourceDisplay.style.left=i.left+(i.width-r>>1)+5+"px",hoverResourceDisplay.style.top=i.top+20+"px"}function displayTravelInfo(e,t){var i=terrain.tile(e),r=terrain.tile(t),n=humanity.tile(e),a=humanity.tile(t),o=travelingNumber(n.h),s="";if(void 0!==n)if(null!=a&&null!=a.c&&a.c!=n.c){var l=[];s+='<dl class="attack-info">';var c=attackForce(o,n,a,i,r,l);s+="<dt>Attack "+c+"</dt><dd>";for(var u=0;u<l.length;u++)s+=l[u]+"<br>";l=[];var d=defenseForce(a.h,n,a,i,r,l),h=c/d;s+=h<=1?"Lose all":"Lose "+(1/h*o|0),s+="</dd>",s+="<dt>Defense "+d+"</dt><dd>";for(u=0;u<l.length;u++)s+=l[u]+"<br>";if(1<h){s+="Lose all";var m=surrender(t,n.c)/6*a.h|0;0<m&&(s+="<br>Surrender "+m)}else s+="Lose "+(h*a.h|0);s+="</dd>",travelInfo.innerHTML=s}else travelInfo.innerHTML=""}function vehicleBonus(e,t,i,r){var n=1;return 0!=(e&terrain.manufacture.gun)&&(n*=2,r.push("2x guns")),0!=(e&terrain.manufacture.car)&&(0!=(t&terrain.manufacture.artillery)&&(n*=1.5,r.push("1.5x car vs. artillery")),0!=(t&terrain.manufacture.plane)&&(n*=.5,r.push("0.5x car vs. plane")),i===terrain.tileTypes.steppe&&(n*=1.5,r.push("1.5x flat terrain drive"))),0!=(e&terrain.manufacture.boat)&&(0!=(t&terrain.manufacture.car)&&(n*=1.5,r.push("1.5x boat vs. car")),0!=(t&terrain.manufacture.artillery)&&(n*=1.5,r.push("1.5x boat vs. artillery")),0!=(t&terrain.manufacture.plane)&&(n*=.5,r.push("0.5x boat vs. plane")),i===terrain.tileTypes.water&&(n*=1.5,r.push("1.5x battleship"))),0!=(e&terrain.manufacture.artillery)&&(0!=(t&terrain.manufacture.car)&&(n*=1.5,r.push("1.5x artillery vs. car")),0!=(t&terrain.manufacture.boat)&&(n*=.5,r.push("0.5x artillery vs. boat")),i===terrain.tileTypes.hill&&(n*=1.5,r.push("1.5x hill ballistics"))),0!=(e&terrain.manufacture.plane)&&(0!=(t&terrain.manufacture.car)&&(n*=1.5,r.push("1.5x plane vs. car")),0!=(t&terrain.manufacture.artillery)&&(n*=1.5,r.push("1.5x plane vs. artillery")),0!=(t&terrain.manufacture.boat)&&(n*=.5,r.push("0.5x plane vs. boat")),i===terrain.tileTypes.mountain&&(n*=1.5,r.push("1.5x mountain air strike"))),n}function attackForce(e,t,i,r,n,a){return e*=vehicleBonus(t.o,i.o,r.steepness,a),r.steepness>n.steepness&&(e*=1.5,a.push("1.5x high ground")),e}function defenseForce(e,t,i,r,n,a){return e*=vehicleBonus(i.o,0,n.steepness,a),n.vegetation&&(e*=1.5,a.push("1.5x vegetation cover")),e}function surrender(e,t){for(var i=0,r=0;r<6;r++){var n=humanity.tile(terrain.neighborFromTile(e,r));n&&n.c===t&&i++}return i}function gotoPlace(e){var t=pixelFromTile(e,{x0:0,y0:0},gs.hexSize);gs.origin.x0=t.x-(gs.width/2|0),gs.origin.y0=t.y-(gs.height/2|0)}function orientPlacesArrow(){for(var e=1;e<placesPanel.childNodes.length;e++){var t=placesPanel.childNodes[e];if(t.getAttribute&&null!=t.getAttribute("data-tilekey")){var i={x:gs.origin.x0+(gs.width/2|0),y:gs.origin.y0+(gs.height/2|0)},r=pixelFromTile(terrain.tileFromKey(t.getAttribute("data-tilekey")),{x0:0,y0:0},gs.hexSize),n=-orientation(i,r),a=t.firstChild;a.style.transform="rotate("+n+"rad)",a.style.WebkitTransform="rotate("+n+"rad)",a.nextSibling.textContent=kmDistance(i,r).toFixed(2)+" km"}}}function orientation(e,t){var i=Math.atan((e.y-t.y)/Math.abs(t.x-e.x));return t.x<e.x&&(i=Math.PI-i),i}function pixelDistance(e,t){var i=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y);return Math.sqrt(i*i+r*r)}function kmDistance(e,t){return pixelDistance(e,t)/gs.hexSize*.025}var humanityPopulation,playerCamp,campResources,humanityData={},resources={wealth:0,usedWealth:0,fuel:0,usedFuel:0,metal:0,usedMetal:0};function campResourcePopulation(e){return humanityPopulation[e]}function campResourceWealth(e){var t=campResources[e];return t.wealth-t.usedWealth}function campResourceFuel(e){var t=campResources[e];return t.fuel-t.usedFuel}function campResourceMetal(e){var t=campResources[e];return t.metal-t.usedMetal}function campResourceHealth(e){var t=campResources[e];return t.health-t.usedHealth}var humanity={tile:function(e){return humanityData[e.q+":"+e.r]}},terrain=new Terrain(humanity);function changeHumanity(e,t){for(var i in t)t[i].c>=numberOfCamps&&addCamp(t[i].c),e[i]=t[i],delete registerMoves[i],delete registerBuilds[i]}function addCamp(e){numberOfCamps+=e-numberOfCamps+1}var helpPane=document.getElementById("helpPane");function showHelp(e){helpPane.src="help/"+e+".html",helpPane.onload=function(){helpPane.style.display="block",helpPane.style.height=helpPane.contentWindow.document.body.clientHeight+40+"px",addEventListener("click",hideHelp)}}function hideHelp(){helpPane.style.display="none",removeEventListener("click",hideHelp)}function intPointFromReal(e){var t=e.q,i=e.r,r=-t-i,n=Math.round(t),a=Math.round(r),o=Math.round(i),s=Math.abs(n-t),l=Math.abs(a-r),c=Math.abs(o-i);return l<s&&c<s?n=-a-o:c<l?a=-n-o:o=-n-a,{q:n,r:o}}function tileFromPixel(e,t,i){var r=e.x+t.x0,n=e.y+t.y0;return intPointFromReal({q:(Math.sqrt(3)*r-n)/3/i,r:2*n/3/i})}function pixelFromTile(e,t,i){return{x:(i*Math.sqrt(3)*(e.q+e.r/2)|0)-t.x0,y:3*i/2*e.r-t.y0}}function noisyPixel(e,t){var i=terrain.tile(t),r={x:0,y:0};return r.x+=(t.q^t.r^(128*i.rain|0))%e,r.y+=(t.q^t.r^(256*i.rain|0))%e,r}function loadSprites(e){var t=new Image;return t.src=e,t}addEventListener("load",function(){localStorage.getItem("firstRun")?Math.random()<.5&&localStorage.getItem("paid")!==""+(new Date).getFullYear()&&showHelp("intro"):localStorage.setItem("firstRun","no")}),buildPanel.firstElementChild.onclick=function(){showHelp("build")};var sprites=loadSprites("sprites.png"),spritesLoaded=!1;function makeGraphicState(e,t){return{hexSize:20,origin:{x0:0,y0:0},canvas:e,ctx:e.getContext("2d"),width:e.width,height:e.height,sprites:t,spritesWidth:t.width}}sprites.onload=function(){spritesLoaded=!0,paint(gs)};var canvas=document.getElementById("canvas");canvas.width=document.documentElement.clientWidth,canvas.height=document.documentElement.clientHeight;var gs=makeGraphicState(canvas,sprites),globalGs=gs;function pathAlongTiles(e,t){var i=e.ctx,r=e.hexSize,n=e.origin;if(i.beginPath(),!(t.length<2)){var a,o=pixelFromTile(terrain.tileFromKey(t[0]),n,r);o.x,o.y;i.moveTo(0|o.x,0|o.y);for(var s=0;s<t.length-1;s++){cpNext=pixelFromTile(terrain.tileFromKey(t[s+1]),n,r);var l=averagePoint(o,cpNext);i.quadraticCurveTo(0|o.x,0|o.y,0|l.x,0|l.y),s===t.length-2&&(a=o),o=cpNext}o=pixelFromTile(terrain.tileFromKey(t[t.length-1]),n,r);var c=(a.x-o.x)/10,u=(a.y-o.y)/10;i.lineTo(o.x+c,o.y+u),i.lineTo(o.x+c-2*u/3,o.y+u+2*c/3),i.lineTo(o.x,o.y),i.lineTo(o.x+c+2*u/3,o.y+u-2*c/3),i.lineTo(o.x+c,o.y+u)}}function paintAlongTiles(e,t){var i=e.ctx;e.hexSize,e.origin;pathAlongTiles(e,t),i.strokeStyle="#ccf",i.lineWidth="5",i.stroke(),i.strokeStyle="red",i.lineWidth="3",i.stroke(),i.lineWidth="1"}function straightPathFromTiles(e,t,i,r){var n=e.ctx,a=e.hexSize,o=e.origin;for(var s in n.beginPath(),t){for(var l=terrain.tileFromKey(s),c=pixelFromTile(l,o,a),u=(c.x,c.y,0),d=0;d<6;d++){var h=terrain.neighborFromTile(l,d);u|=(void 0!==t[terrain.keyFromTile(h)]|0)<<d}partialPathFromHex(e,c,u,i,r)}}function pathFromTiles(e,t,i,r,n,a){var o=e.ctx,s=e.hexSize,l=e.origin;o.beginPath();var c=[];for(var u in t)for(var d=terrain.tileFromKey(u),h=(pixelFromTile(d,l,s),0);h<6;h++){var m=terrain.neighborFromTile(d,h);void 0===t[terrain.keyFromTile(m)]&&(c=c.concat(vertexFromFace(u,h)))}pathFromPolygons(e,polygonFromVertices(e,c,i,n),!!a)}function straightPolygonPathFromTiles(e,t){var i=e.ctx,r=e.hexSize,n=e.origin,a=r*Math.sqrt(3);i.beginPath();var o=[];for(var s in t)for(var l=terrain.tileFromKey(s),c=(pixelFromTile(l,n,r),0);c<6;c++){var u=terrain.neighborFromTile(l,c);void 0===t[terrain.keyFromTile(u)]&&(o=o.concat(vertexFromFace(s,c)))}for(var d=polygonFromVertices(e,o,a),h=0;h<d.length;h++)partialPathFromPolygon(e,d[h])}function vertexFromFace(e,t){var i=(t+4)%6,r=(i+1)%6;return[vertexFromTileKey(e,i),vertexFromTileKey(e,r)]}function vertexFromTileKey(e,t){return 0===t?terrain.keyFromTile(terrain.neighborFromTile(terrain.tileFromKey(e),2))+":0":1===t?terrain.keyFromTile(terrain.neighborFromTile(terrain.tileFromKey(e),3))+":1":2===t?terrain.keyFromTile(terrain.neighborFromTile(terrain.tileFromKey(e),3))+":0":3===t?terrain.keyFromTile(terrain.neighborFromTile(terrain.tileFromKey(e),4))+":1":4===t?e+":0":5===t?e+":1":"invalid:vertex:key"}function pointFromVertex(e,t,i,r){var n=e.hexSize,a=e.origin,o=+t.slice(-1),s=t.slice(0,-2),l=terrain.tileFromKey(s),c=pixelFromTile(l,a,n),u=0|c.x,d=0|c.y,h=i/2|0,m=n/2|0,p=r?noisyPixel(n/2,l):{x:0,y:0};return 0===o?{x:u+h+p.x,y:d+m+p.y}:1===o?{x:u+h,y:d-m}:void 0}function polygonFromVertices(e,t,i,r){e.hexSize,e.origin;for(var n=new Array(t.length),a=0;a<t.length;a++)n[a]=t[a];for(var o=[];0<n.length;){for(var s=n.shift(),l=n.shift(),c=[pointFromVertex(e,s,i,r),pointFromVertex(e,l,i,r)],u=1e4;l!==s&&0<u--;)for(a=0;a<n.length;a+=2){if(n[a]===l){c.push(pointFromVertex(e,n[a+1],i,r)),l=n[a+1],n.splice(a,2);break}if(n[a+1]===l){c.push(pointFromVertex(e,n[a],i,r)),l=n[a],n.splice(a,2);break}}c.pop(),o.push(c)}return o}function partialPathFromPolygon(e,t){var i=e.ctx;i.moveTo(t[0].x,t[0].y);for(var r=1;r<t.length;r++)i.lineTo(t[r].x,t[r].y);i.closePath()}function pathFromPolygons(e,t,i){e.ctx.beginPath();for(var r=0;r<t.length;r++)partialPathForSmoothPolygon(e,t[r],!!i)}function averagePoint(e,t){return{x:e.x+t.x>>1,y:e.y+t.y>>1}}function extremizePoint(e,t,i){var r=averagePoint(a1,c2),n=averagePoint(a2,c1);return{x:t.x-(r.x-t.x)/2|0+(n.x-t.x)/2|0,y:t.y-(r.y-t.y)/2|0+(n.y-t.y)/2|0}}function partialPathForSmoothPolygon(e,t,i){i=!!i;var r=e.ctx;if(t.length<3)return partialPathFromPolygon(e,t);for(var n=new Array(t.length),a=0;a<t.length;a++)o=averagePoint(t[a],t[(a+1)%t.length]),n[a]=o;var o=averagePoint(n[0],n[1]);r.moveTo(o.x,o.y);for(a=1;a<n.length;a++)o=averagePoint(n[a],n[(a+1)%n.length]),i&&a%2==0?r.moveTo(o.x,o.y):r.quadraticCurveTo(n[a].x,n[a].y,o.x,o.y);i||(o=averagePoint(n[0],n[1]),r.quadraticCurveTo(n[0].x,n[0].y,o.x,o.y))}function partialPathFromHex(e,t,i,r,n){var a=e.ctx,o=e.hexSize;i|=0;var s=0|t.x,l=0|t.y,c=r/2|0,u=o/2|0;a.moveTo(s,l-o);var d=s-c,h=l-u;0==(4&i)?a.lineTo(d,h):a.moveTo(d,h),d=s-c,h=l+u,0==(8&i)?a.lineTo(d,h):a.moveTo(d,h),d=s,h=l+o,0==(16&i)?a.lineTo(d,h):a.moveTo(d,h),d=s+c,h=l+u,0==(32&i)?a.lineTo(d,h):a.moveTo(d,h),d=s+c,h=l-u,0==(1&i)?a.lineTo(d,h):a.moveTo(d,h),d=s,h=l-o,0==(2&i)?a.lineTo(d,h):a.moveTo(d,h)}function pathFromHex(e,t,i,r){var n=e.ctx;e.hexSize;n.beginPath(),partialPathFromHex(e,t,0,i,r)}function paintAroundTiles(e,t,i){var r=e.ctx,n=e.hexSize;e.origin;pathFromTiles(e,t,n*Math.sqrt(3),3*n/2,!0),r.strokeStyle=i||"white",r.stroke()}function paintStraightAroundTiles(e,t,i){var r=e.ctx,n=e.hexSize;e.origin;straightPathFromTiles(e,t,n*Math.sqrt(3),3*n/2),r.strokeStyle=i||"white",r.stroke()}function paintTileHexagon(e,t,i,r){var n=e.ctx,a=e.hexSize,o=e.origin,s=(Math.sqrt(3),3*a/2),l=pixelFromTile(t,o,a),c=s;n.beginPath(),n.arc(l.x,l.y,c,0,2*Math.PI,!0),n.closePath(),n.strokeStyle=i,n.lineWidth=r||3,n.stroke(),n.lineWidth=1}document.styleSheets[0].insertRule("div.controlPanel { max-height:"+(gs.height-16-58)+"px; }",0);var πx2=2*Math.PI,mπd3=-Math.PI/3;function paintRotatedSprite(e,t,i,r,n){var a=e.ctx,o=e.hexSize,s=e.spritesWidth;a.save(),a.translate(t,i),a.rotate(n);var l=o/20,c=-s*l/2|0,u=s*l|0;a.drawImage(e.sprites,0,s*r|0,s,s,c,c,u,u),a.restore()}function paintSprite(e,t,i,r,n){return paintRotatedSprite(e,t,i,r,n*mπd3)}function paintBuilding(e,t,i,r,n,a,o){if(null!=n)if(n===tileTypes.road){for(var s=tileTypes.curvedRoad,l=!1,c=[humanity.tile(terrain.neighborFromTile(r,0)),humanity.tile(terrain.neighborFromTile(r,1)),humanity.tile(terrain.neighborFromTile(r,2)),humanity.tile(terrain.neighborFromTile(r,3)),humanity.tile(terrain.neighborFromTile(r,4)),humanity.tile(terrain.neighborFromTile(r,5))],u=0;u<6;u++)if(c[u]&&c[u].b===n){var d=c[(u+2)%6],h=c[(u+4)%6];d&&d.b===n?paintSprite(e,t,i,s,u):h&&h.b===n||paintSprite(e,t,i,n,u),l=!0}l||paintSprite(e,t,i,n,0)}else if(n===tileTypes.wall||n===tileTypes.airland){for(l=!1,u=0;u<6;u++){var m=humanity.tile(terrain.neighborFromTile(r,u));m&&((n===tileTypes.road||n===tileTypes.wall)&&m.b===n||n===tileTypes.airland&&m.b===tileTypes.airport)&&(paintSprite(e,t,i,n,u),l=!0)}l||paintSprite(e,t,i,n,0)}else 26<n&&n<63?paintRotatedSprite(e,t,i,n,r.q*r.r*(128*o.rain|0)%64/64*πx2):n===tileTypes.airport||n===tileTypes.factory||n>tileTypes.wall?paintSprite(e,t,i,n,0):paintSprite(e,t,i,n,a=a||0)}function paintLoneBuilding(e,t,i){var r=pixelFromTile(t,e.origin,e.hexSize),n=terrain.tile(t),a=(t.q^t.r^(128*n.rain|0))%6;paintBuilding(e,r.x,r.y,t,i,a,n)}function paintBuildingsSprited(e){for(var t=e.width,i=e.height,r=(e.ctx,e.origin),n=e.hexSize,a=tileFromPixel({x:0,y:0},r,n),o=pixelFromTile({q:a.q,r:a.r-1},r,n),s=o.x,l=o.y,c=n*Math.sqrt(3),u=3*n/2,d=!0;l-u<i;){for(;s-c<t;){a=tileFromPixel({x:s,y:l},e.origin,n);var h=terrain.tile(a),m=(a.q^a.r^(128*h.rain|0))%6,p=humanity.tile(a);paintBuilding(e,s,l,a,p?p.b:null,m,h),s+=c}l+=u,s=o.x,d?(s-=c/2,d=!1):d=!0,s=Math.floor(s),l=Math.floor(l)}}function paintTerrain(e,t,i,r,n){n=n||terrain.tile(r);var a=(r.q^r.r^(128*n.rain|0))%6;paintSprite(e,t,i,n.type,a)}var cachedTerrainPaint={};function paintTilesSprited(e){var n=e.width,a=e.height,t=e.ctx,o=e.hexSize,s=e.origin,i=tileFromPixel({x:0,y:0},s,o),l=pixelFromTile({q:i.q,r:i.r-1},s,o),r=l.x,c=l.y,u=o*Math.sqrt(3),d=3*o/2,h=o+":"+s.x0+":"+s.y0;if(void 0===cachedTerrainPaint[h]){var m=document.createElement("canvas");m.width=e.width,m.height=e.height;var p=makeGraphicState(m,sprites);p.hexSize=e.hexSize,p.origin=e.origin;for(var g=0;g<9;g++){var y=!0;for(r=l.x,c=l.y;c-d<a;){for(;r-u<n;){i=tileFromPixel({x:r,y:c},s,o);var f=terrain.tile(i),v=terrain.commodity(i,f);if(f.type===g)paintTerrain(p,r,c,i,f),0<=v&&paintBuilding(p,r,c,i,v,null,f);else if(8===g&&f.type===tileTypes.water)for(var T=0;T<6;T++){var x=terrain.neighborFromTile(i,T),w=terrain.tile(x);w.type!==tileTypes.water&&w.type!==tileTypes.swamp&&paintSprite(p,r,c,tileTypes.beach,T%6)}r+=u}c+=d,r=l.x,y?(r-=u/2,y=!1):y=!0,r|=0,c|=0}}cachedTerrainPaint[h]=m;var M=getWorkerFromPool();M.addEventListener("message",function e(t){if(t.data.origin.x0===s.x0&&t.data.origin.y0===s.y0&&t.data.size===o){workerCanvasBuffer.getContext("2d").putImageData(t.data.image,0,0),p.ctx.drawImage(workerCanvasBuffer,0,0),M.removeEventListener("message",e);var i=l.x+s.x0-o/2,r=l.y+s.y0-o/2;updateCachedRegion(i,r,n,a),updateCachedRegion(i+n,r,n,a),updateCachedRegion(i,r+a,n,a),updateCachedRegion(i+n,r+a,n,a),paint(globalGs),paintHumans(globalGs,humanityData)}}),workerMessage.image=workerImageBuffer,workerMessage.size=o,workerMessage.origin=s,workerMessage.type="rainfall",M.postMessage(workerMessage)}t.drawImage(cachedTerrainPaint[h],0,0)}function paintTilesRaw(e){for(var t=r.canvas.width,i=r.canvas.height,r=e.ctx,n=e.hexSize,a=e.origin,o=r.getImageData(0,0,t,i),s=o.data,l=0;l<i;l++)for(var c=0;c<t;c++){var u=tileFromPixel({x:c,y:l},a,n),d=terrain.tile(u),h=[180,0,0];d.steepness==tileTypes.water?h=[50,50,180]:d.steepness==tileTypes.steppe?h=[0,180,0]:d.steepness==tileTypes.hill&&(h=[180,100,0]);var m=Math.min(Math.abs(h[0]-h[1])/2*d.rain,255);h[0]-=m,h[1]-=m,h[2]-=Math.min(50*d.rain,255),d.vegetation&&(h[0]-=100,h[1]-=50,h[2]-=100);var p=4*(c+l*t);s[p+0]=h[0],s[p+1]=h[1],s[p+2]=h[2],s[p+3]=255}r.putImageData(o,0,0)}var workerCanvasBuffer=document.createElement("canvas");workerCanvasBuffer.width=gs.width,workerCanvasBuffer.height=gs.height;var workerImageBuffer=workerCanvasBuffer.getContext("2d").getImageData(0,0,gs.width,gs.height),workerMessage={image:null,size:gs.hexSize,origin:gs.origin},workerPool=[new Worker("render-worker.js"),new Worker("render-worker.js"),new Worker("render-worker.js"),new Worker("render-worker.js")],workerPoolRoundRobin=0;function getWorkerFromPool(){return workerPoolRoundRobin++,workerPoolRoundRobin%=workerPool.length,workerPool[workerPoolRoundRobin]}function paintTiles(e,i){var r=e.ctx,n=e.hexSize,a=e.origin;if(n<5){var o=getWorkerFromPool();o.addEventListener("message",function e(t){t.data.origin.x0===a.x0&&t.data.origin.y0===a.y0&&t.data.size===n&&(r.putImageData(t.data.image,0,0),o.removeEventListener("message",e),i())}),workerMessage.image=workerImageBuffer,workerMessage.size=n,workerMessage.origin=a,workerMessage.type="raw",o.postMessage(workerMessage)}else paintTilesSprited(e),paintBuildingsSprited(e),i()}var cachedPaint={},cachePending={};function getCachedPaint(e,t,i,r,n){var a=t+":"+i,o=cachedPaint[a];if(null==o){var s=document.createElement("canvas");if(s.width=e.width,s.height=e.height,void 0===o&&n instanceof Function){var l=s.getContext("2d");l.fillStyle="black",l.fillRect(0,0,e.width,e.height),n(s)}if(void 0===cachePending[a]){cachePending[a]=r;var c=makeGraphicState(s,sprites);c.hexSize=e.hexSize,c.origin={x0:t,y0:i},paintTiles(c,function(){o=cachedPaint[a]=s,cachePending[a](o),delete cachePending[a]})}else cachePending[a]=r}else r(o)}function drawCachedPaint(e,t,i,r,n){var a=cachedPaint[t+":"+i];null!=a&&e.ctx.drawImage(a,r,n)}function regionFromPixel(e,t,i,r){var n,a;return(n=e%i)<0&&(n+=i),(a=t%r)<0&&(a+=r),e-n+":"+(t-a)}function updateCachedRegion(e,t,i,r){cachedPaint[regionFromPixel(e,t,i,r)]=null}function updateCachedPaint(e,t){var i=e.hexSize,r=e.origin;for(var n in t){var a=pixelFromTile(terrain.tileFromKey(n),r,i),o=e.width,s=e.height,l=a.x+r.x0-i/2,c=a.y+r.y0-i/2;updateCachedRegion(l,c,o,s),updateCachedRegion(l+i,c,o,s),updateCachedRegion(l,c+i,o,s),updateCachedRegion(l+i,c+i,o,s)}}function paintTilesFromCache(n,a){var o=n.ctx,e=n.origin,s=document.createElement("canvas");s.width=n.width,s.height=n.height;var l=s.getContext("2d"),t=n.width,i=n.height,r=e.x0%t;r<0&&(r+=t);var c=e.y0%i;c<0&&(c+=i);var u=e.x0-r,d=e.x0+t-r,h=e.y0-c,m=e.y0+i-c,p=0,g=function(t,i,r){return function(e){l.drawImage(e,t,i),r?4===++p&&(o.drawImage(s,0,0),a()):(o.drawImage(s,0,0),paintTilesFromCurrentCache(n))}},y=g(-r,-c,!0),f=g(t-r,-c,!0),v=g(-r,i-c,!0),T=g(t-r,i-c,!0),x=g(-r,-c,!1),w=g(t-r,-c,!1),M=g(-r,i-c,!1),P=g(t-r,i-c,!1);getCachedPaint(n,u,h,y,x),getCachedPaint(n,d,h,f,w),getCachedPaint(n,u,m,v,M),getCachedPaint(n,d,m,T,P)}function paintTilesFromCurrentCache(e){e.ctx;var t=e.origin,i=e.width,r=e.height,n=t.x0%i;n<0&&(n+=i);var a=t.y0%r;a<0&&(a+=r);var o=t.x0-n,s=t.x0+i-n,l=t.y0-a,c=t.y0+r-a;drawCachedPaint(e,o,l,-n,-a),drawCachedPaint(e,s,l,i-n,-a),drawCachedPaint(e,o,c,-n,r-a),drawCachedPaint(e,s,c,i-n,r-a)}var displayedPaint=document.createElement("canvas");displayedPaint.width=gs.width,displayedPaint.height=gs.height;var displayedPaintContext=displayedPaint.getContext("2d"),showTitleScreen=!0;function paint(e){e.ctx,e.hexSize,e.origin;selectionMode===selectionModes.places&&orientPlacesArrow(),spritesLoaded&&paintTilesFromCache(e,function(){paintIntermediateUI(e)})}function paintIntermediateUI(e){var t=e.ctx,i=e.hexSize;e.origin;for(var r in i<5&&drawMapPlaces(e),lockedTiles)paintTileHexagon(e,terrain.tileFromKey(r),campHsl(lockedTiles[r]),1);for(var n in null!=currentTile&&null!=playerCamp&&paintTileHexagon(e,currentTile,campHsl(playerCamp,100,40)),paintCamps(e),t.lineWidth=1.5,t.setLineDash([2,7]),paintAroundTiles(e,accessibleTiles),t.setLineDash([]),t.lineWidth=1,null!=currentTile&&null!=targetTile&&selectionMode===selectionModes.travel&&(paintAlongTiles(e,terrain.pathFromParents(terrain.keyFromTile(targetTile),accessibleTiles)),displayTravelInfo(currentTile,targetTile)),registerMoves){var a=terrain.tileFromKey(n);paintAlongTiles(e,terrain.humanTravelSpeedPath(registerMoves[n],a))}for(var o in registerBuilds){paintLoneBuilding(e,terrain.tileFromKey(o),registerBuilds[o])}paintTileMessages(e),void 0!==gameOver&&drawTitle(e,[campNames[gameOver.winners[0]]+" won a "+gameOver.winType+" Victory.",gameOver.winners[0]===playerCamp?"YOU WON! ("+nth(localStorage.getItem("gamesWon"))+" win!)":"YOU NEARLY WON! ("+nth(gameOver.winners.indexOf(playerCamp)+1)+" place!)","You can reload to engage in the next game!"],campHsl(gameOver.winners[0])),showTitleScreen&&drawTitle(e,["Welcome to Thaddée Tyl's…","NOT MY TERRITORY","(YET)"]),displayedPaintContext.drawImage(canvas,0,0)}function nth(e){var t=""+(e|=0);if(49===t.charCodeAt(t.length-2))return t+"th";var i=e%10;return 1===i?t+"st":2===i?t+"nd":3===i?t+"rd":t+"th"}function drawTitle(e,t,i){var r=e.ctx,n=e.width,a=e.height,o=t[0],s=t[1],l=t[2];r.fillStyle=i||"black",i&&(r.strokeStyle="black"),r.textAlign="center",r.font=a/16+'px "Linux Biolinum", sans-serif',r.fillText(o,n/2,1*a/3),i&&r.strokeText(o,n/2,1*a/3),r.font=a/8+'px "Linux Biolinum", sans-serif',r.fillText(s,n/2,13*a/24),i&&r.strokeText(s,n/2,13*a/24),r.font=a/16+'px "Linux Biolinum", sans-serif',r.fillText(l,n/2,2*a/3),i&&r.strokeText(l,n/2,2*a/3),r.textAlign="start"}setTimeout(function(){showTitleScreen=!1},2e3);var mapIndex=Object.create(null);function fillMapIndex(e){for(var t in e)mapIndex["2:"+t]=e[t]}function drawMapPlaces(e){var t=e.ctx;for(var i in t.fillStyle="black",t.strokeStyle="lightgrey",t.textAlign="center",mapIndex){var r=i.split(":"),n=+r[0],a=pixelFromTile({q:0|r[1],r:0|r[2]},e.origin,e.hexSize),o=mapIndex[i];t.font="bold italic "+e.hexSize*n*7+'px "Linux Biolinum", sans-serif',t.strokeText(o,a.x,a.y-15),t.fillText(o,a.x,a.y-15)}t.textAlign="start"}var numberOfHumanAnimations=20,humanAnimation=new Array(numberOfHumanAnimations);function initHumans(){for(var e=0;e<numberOfHumanAnimations;e++)humanAnimation[e]={x:Math.random(),y:Math.random(),targetx:Math.random(),targety:Math.random(),period:20*Math.random()+3|0,tick:0}}function updateHumans(){for(var e=0;e<humanAnimation.length;e++){var t=humanAnimation[e];t.x+=(t.targetx-t.x)/t.period,t.y+=(t.targety-t.y)/t.period,t.tick++,t.tick>t.period&&(t.targetx=Math.random(),t.targety=Math.random(),t.tick=0)}}function paintHumans(e,t){var i=e.ctx,r=e.hexSize,n=e.origin;if(!(r<20))for(var a in i.drawImage(displayedPaint,0,0),t){for(var o=a.split(":"),s=+o[0],l=+o[1],c=t[a],u=terrain.tile(terrain.tileFromKey(a)),d=pixelFromTile({q:s,r:l},n,r),h=d.x,m=d.y,p=[],g=[2,4,8,16,32,64],y=0;y<g.length;y++)0!=(c.o&g[y])&&p.push(g[y]);var f=(u.type===tileTypes.water||u.type===tileTypes.swamp)&&0!=(c.o&manufacture.boat),v=(u.type===tileTypes.water||u.type===tileTypes.swamp)&&0!=(c.o&manufacture.plane),T=c.h;T>humanAnimation.length&&(T=humanAnimation.length);for(var x=0;x<T;x++){var w=humanAnimation[Math.abs(x+s^l^c.f)%humanAnimation.length],M=h-r+2*w.x*r|0,P=m-r+2*w.y*r|0,k=-1;f?k=manufacture.boat:v?k=manufacture.plane:0<p.length&&(k=p[x%p.length]),paintHuman(e,k,u,M,P,r)}}}function paintHuman(e,t,i,r,n){var a=e.ctx,o=e.hexSize/20;t<0?(a.fillStyle="black",a.fillRect(r,n,o,2*o)):t===manufacture.boat?(a.fillStyle="#aaf",a.fillRect(r-o,n-o,o,o),a.fillRect(r,n,7*o,o),a.fillRect(r+7*o,n-o,o,o)):t===manufacture.car?(a.fillStyle="#420",a.fillRect(r,n,3*o,2*o)):t===manufacture.plane?(a.fillStyle="#edf",a.fillRect(r-o,n-o,2*o,o),a.fillRect(r,n,9*o,o),a.fillRect(r+5*o,n-o,o,o),a.fillRect(r+3*o,n+o,o,o)):t===manufacture.artillery?(a.fillStyle="#425",a.fillRect(r-2*o,n,5*o,2*o),a.fillRect(r,n-1*o,5*o,1*o)):t===manufacture.gun&&(a.fillStyle="#440",a.fillRect(r,n,o,2*o))}function animateHumans(){paintHumans(gs,humanityData),updateHumans(),paintMovementAnimations()}initHumans();var humanAnimationTimeout=setInterval(animateHumans,100);function InterpolationAnimation(e,t,i,r,n){this.gs=e,this.from=t,this.to=i,this.pos={x:this.from.x,y:this.from.y},this.velocity=r,this.deltaX=i.x-t.x,this.deltaY=i.y-t.y,this.length=Math.sqrt(this.deltaX*this.deltaX+this.deltaY*this.deltaY),this.portions=this.length/r,this.usedPortions=0,this.dx=this.deltaX/this.portions,this.dy=this.deltaY/this.portions,this.normalizedDx=this.deltaX/this.length,this.normalizedDy=this.deltaY/this.length,this.drawFunction=n}function paintMovementAnimations(){for(var e=0;e<movementAnimations.length;e++)movementAnimations[e].draw()}InterpolationAnimation.prototype={draw:function(){if(this.drawFunction(),this.pos.x+=this.dx,this.pos.y+=this.dy,this.usedPortions++,this.usedPortions>this.portions){var e=movementAnimations.indexOf(this);movementAnimations.splice(e,1)}}};var movementAnimations=[],animationVelocity=32;function drawShell(){var e=this.gs.ctx;e.lineWidth=2;for(var t=Math.min(this.usedPortions,8),i=this.pos.x,r=this.pos.y,n=4*this.normalizedDx,a=4*this.normalizedDy,o=9;8-t<o;o--)e.beginPath(),e.moveTo(i,r),i-=n,r-=a,e.lineTo(i,r),e.strokeStyle="rgba(0,0,0,0."+o+")",e.stroke()}function addShells(e,t){var i=listVisibleHumans(gs);for(var r in t)for(var n=t[r],a=0;a<n.length;a++){var o=n[a];if(0<=i.indexOf(o)||0<=i.indexOf(r)){var s=terrain.tileFromKey(o),l=terrain.tileFromKey(r),c=pixelFromTile(s,gs.origin,gs.hexSize),u=pixelFromTile(l,gs.origin,gs.hexSize),d=new InterpolationAnimation(gs,c,u,animationVelocity,drawShell);e.push(d)}}}function listVisibleHumans(e){e.ctx;var t,i,r,n,a,o=e.hexSize,s=e.origin;i=(a=tileFromPixel({x:0,y:e.height},s,o)).q-1,r=a.r+1,t=(a=tileFromPixel({x:e.width,y:0},s,o)).q+1,n=a.r-1;var l=[];for(var c in humanityData)tile=terrain.tileFromKey(c),tile.q>=i&&tile.q<=t&&tile.r>=n&&tile.r<=r&&null!=humanityData[c].c&&l.push(c);return l}var numberOfCamps=3;function paintCamps(e){for(var t=e.ctx,i=e.hexSize,r=e.origin,n=listVisibleHumans(e),a=new Array(numberOfCamps),o=0;o<numberOfCamps;o++)a[o]={};for(o=0;o<n.length;o++){a[humanityData[n[o]].c][n[o]]=!0}var s=2*e.hexSize/9,l=e.hexSize*Math.sqrt(3),c=3*e.hexSize/2;if(i<5){t.fillStyle="black";var u=2*i;for(o=0;o<numberOfCamps;o++){var d=a[o];for(var h in d){var m=pixelFromTile(terrain.tileFromKey(h),r,i);t.fillRect(m.x-u,m.y-u,2*u,2*u)}}for(o=0;o<numberOfCamps;o++){t.fillStyle=campHsl(o);d=a[o];for(var h in d){m=pixelFromTile(terrain.tileFromKey(h),r,i);t.fillRect(m.x-i,m.y-i,2*i,2*i)}}}else{for(o=0;o<numberOfCamps;o++)pathFromTiles(e,a[o],l,c,!0,!1),t.lineWidth=2*s,t.strokeStyle="hsla("+campHueCreator9000(o)+",30%,40%,0.4)",t.stroke();for(o=0;o<numberOfCamps;o++)pathFromTiles(e,a[o],l,c,!0,!1),t.save(),t.clip(),t.lineWidth=s,t.strokeStyle=campHsl(o,70,35,.4),t.stroke(),pathFromTiles(e,a[o],l,c,!0,!0),t.strokeStyle=campHsl(o,80,42,.4),t.stroke(),t.restore();t.lineWidth=1}}function campHsl(e,t,i,r){return null==t&&(t=100),null==i&&(i=45),null==r?"hsl("+campHueCreator9000(e)+","+t+"%,"+i+"%)":"hsla("+campHueCreator9000(e)+","+t+"%,"+i+"%,"+r+")"}var campHue=[];function campHueCreator9000(e){return void 0!==campHue[e]?campColors[e]:0===e?270:(campHueCreator9000(e-1)+60)%360}function paintPopulation(){if(humanityPopulation){var e="<svg id=populationMonitor>";e+='<rect stroke="hsl(0,0%,40%)" stroke-width="1" x="0" y="0" rx="3" ry="3" width="187" height="10" />';for(var t=0,i=0;i<humanityPopulation.length;i++)t+=humanityPopulation[i];var r,n=1,a=0;for(i=0;i<humanityPopulation.length-1;i++)a+=r=185*humanityPopulation[i]/t|0,e+='<rect fill="'+campHsl(i)+'" x="'+n+'" y="1" width="'+r+'" height="8" />',n+=r;r=185-a,e+='<rect fill="'+campHsl(i)+'" x="'+n+'" y="1" width="'+r+'" height="8" /><linearGradient id="grad" y2="100%" x2="0"><stop offset="0" stop-color="#fff" stop-opacity=".1"/><stop offset="1" stop-color="#000" stop-opacity=".2"/></linearGradient><rect fill="url(#grad)" x="1" y="1" width="185" height="8"/></svg>',populationMonitor.outerHTML=e}}var surrenderMessages=["We surrender!","I give up!","Enemies captured!","I, for one, welcome our new overlords."],hungerMessages=["Make a farm.","Hungry!","Is dinner ready?","I can't feel my stomach!","You're starving us!","I could eat anything. Rats. Babies.","You look like a sandwich to me."],warMessages=["You've got red on you.","Silence will fall!","Silence! I kill you!","Boy, that escalated quickly.","Sorry Mommy!","New legs, please!","Have you seen my head?","There is wine on the floor…","They're bleeding demised!","Them ex-people make daisies happy.","⬐ Acclimated to the being dead position","So much for survival!","Today I died.","I dare you! I double-dare you!","Mayday!","Area pacified, over!","Resistance is futile.","All your base are belong to us.","Nobody expects the Spanish Inquisition!","Whoop-de-doo!","You'll never take me alive!","Told you he wasn't immortal!","Tu quoque, fili mi!","Do not disturb my circles!","This is no time to be making enemies.","I owe a cock to Asclepius.","More light!","Life's too short!","What will you do, kill m—?!","Drink to me!"],warTiles={},surrenderTiles={},starvedTiles={};function addHumanMessages(t,e,i){for(var r=0;r<e.length;r++){var n=e[r];t[n]&&clearTimeout(t[n].timeout);var a=i[i.length*Math.random()|0];t[n]={message:a,timeout:setTimeout(function(e){return function(){delete t[e],paint(gs)}}(n),2e3)}}}function addStarveMessages(e){var t=[];for(var i in e)0<e[i].h&&e[i].f<4&&t.push(i);addHumanMessages(starvedTiles,t,hungerMessages)}function paintMessage(e,t,i){var r=e.ctx,n=e.hexSize,a=e.origin;r.font='14px "Linux Biolinum", sans-serif';var o=r.measureText(i).width,s=pixelFromTile(terrain.tileFromKey(t),a,n),l=s.x+n/4,c=s.y-n/4;r.beginPath(),r.moveTo(l,c),r.lineTo(l+2,c-10),r.lineTo(l-12,c-10),r.lineTo(l-10,c-40),r.lineTo(l+o+10,c-35),r.lineTo(l+o,c-10),r.lineTo(l+12,c-10),r.closePath(),r.fillStyle="rgba(0,0,0,0.8)",r.fill(),r.strokeStyle="white",r.strokeText(i,l-4,c-20)}function paintTileMessages(e){e.ctx,e.hexSize,e.origin;for(var t in warTiles)paintMessage(e,t,warTiles[t].message);for(var t in surrenderTiles)paintMessage(e,t,surrenderTiles[t].message);for(var t in starvedTiles)paintMessage(e,t,starvedTiles[t].message)}function attributeNameFromTile(){var e=[],t=0;for(var i in tileTypes)e[t++]=i;return e}var lockedTiles,accessibleTiles,currentTile,tileNames=attributeNameFromTile(),tileInfo=document.getElementById("info");function showTileInformation(e){var t=terrain.tile(e),i=terrain.commodity(e,t),r="a "+tileNames[t.type];0===t.type&&(r=tileNames[t.type]),0<=i&&(r+=" with "+tileNames[i]);var n=humanity.tile(e);if(null!=n&&(null!=n.b&&(r=("a"===tileNames[n.b][0]?"an ":"a ")+tileNames[n.b]+" built in "+r),0<n.h)){var a="",o=!1;0!=(n.o&manufacture.plane)&&(a+="on a plane ",o=!0),0!=(n.o&manufacture.boat)&&(a+=(t.type!==tileTypes.water||o?"with":(o=!0,"in"))+" a boat "),0!=(n.o&manufacture.artillery)&&(a+="with cannons "),0!=(n.o&manufacture.car)&&(a+=(o?"with":"in")+" a car "),r=n.h+(0!=(n.o&manufacture.gun)?" armed":"")+" folk"+(1===n.h?"":"s")+" "+a+"in "+r}tileInfo.value=r}var buildSelectionButtons=document.querySelectorAll("p.buildSelection");function indicateValidConstructions(e){for(var t=0;t<buildSelectionButtons.length;t++){var i=+buildSelectionButtons[t].dataset.b;terrain.validConstruction(i,e,resources)?buildSelectionButtons[t].classList.add("validSelection"):buildSelectionButtons[t].classList.remove("validSelection")}}function hookBuildSelectionButtons(){for(var e=0;e<buildSelectionButtons.length;e++){var t=function(e){return function(){sendBuild(currentTile,e),enterMode(selectionModes.normal)}}(+buildSelectionButtons[e].dataset.b);buildSelectionButtons[e].addEventListener("click",t)}}function updateCurrentTileInformation(){void 0!==currentTile&&(showTileInformation(currentTile),accessibleTiles=terrain.humanTravelFrom(currentTile),indicateValidConstructions(currentTile))}hookBuildSelectionButtons();var selectionModes={normal:1,settings:2,travel:3,build:4,places:5},selectionMode=selectionModes.normal;function hidePanel(e,t){e.style.display="none",t.style.fill="black",t.firstElementChild.style.display="block",t.firstElementChild.nextElementSibling.style.display="none"}function showPanel(e,t){e.style.display="block",t.style.fill="#800080",t.firstElementChild.style.display="none",t.firstElementChild.nextElementSibling.style.display="block"}function enterMode(e){selectionMode!==e&&(selectionMode===selectionModes.settings?(hidePanel(settingsPanel,settingsBut),settingsBut.removeEventListener("click",enterNormalMode),settingsBut.addEventListener("click",enterSettingsMode)):selectionMode===selectionModes.travel?(hidePanel(travelPanel,travelBut),targetTile=null,travelBut.removeEventListener("click",enterNormalMode),travelBut.addEventListener("click",enterTravelMode)):selectionMode===selectionModes.build?(hidePanel(buildPanel,buildBut),buildBut.removeEventListener("click",enterNormalMode),buildBut.addEventListener("click",enterBuildMode)):selectionMode===selectionModes.places&&(hidePanel(placesPanel,placesBut),placesBut.removeEventListener("click",enterNormalMode),placesBut.addEventListener("click",enterPlacesMode)),e===selectionModes.settings?(showPanel(settingsPanel,settingsBut),settingsBut.addEventListener("click",enterNormalMode)):e===selectionModes.travel?(splitPanelSetMoveStay(),showPanel(travelPanel,travelBut),travelBut.addEventListener("click",enterNormalMode)):e===selectionModes.build?(showPanel(buildPanel,buildBut),buildBut.addEventListener("click",enterNormalMode)):e===selectionModes.places&&(orientPlacesArrow(),showPanel(placesPanel,placesBut),placesBut.addEventListener("click",enterNormalMode)),selectionMode=e,mousePosition&&showPath({clientX:mousePosition.x,clientY:mousePosition.y}),e===selectionModes.normal&&paint(gs))}function enterNormalMode(){enterMode(selectionModes.normal)}function enterSettingsMode(){enterMode(selectionModes.settings)}function enterTravelMode(){enterMode(selectionModes.travel)}function enterBuildMode(){enterMode(selectionModes.build)}function enterPlacesMode(){enterMode(selectionModes.places)}function splitPanelSlider(e){splitInputWidget.value=""+e,splitPanelPortion.textContent=""+e}function splitPanelSetMoveStay(){var e=humanity.tile(currentTile),t=0;null!=e&&(t=e.h);var i=t*splitInputWidget.value/100|0,r=t-i;splitPanelPortionMove.textContent=""+i,splitPanelPortionStay.textContent=""+r}travelBut.addEventListener("click",enterTravelMode),buildBut.addEventListener("click",enterBuildMode),settingsBut.addEventListener("click",enterSettingsMode),placesBut.addEventListener("click",enterPlacesMode),splitInputWidget.addEventListener("input",function(){splitPanelPortion.textContent=""+splitInputWidget.value,splitPanelSetMoveStay()});var mousePosition,targetTile,buildHotKeys={48:tileTypes.airport,51:tileTypes.farm,52:tileTypes.residence,53:tileTypes.skyscraper,54:tileTypes.factory,55:tileTypes.dock,56:tileTypes.gunsmith,57:tileTypes.airland};function travelingNumber(e){return e*splitInputWidget.value/100|0}function mouseSelection(e){gs.canvas.removeEventListener("mousemove",mouseDrag),gs.canvas.removeEventListener("mouseup",mouseSelection);var t=tileFromPixel({x:e.clientX,y:e.clientY},gs.origin,gs.hexSize);if(selectionMode===selectionModes.travel&&void 0!==currentTile&&void 0!==humanity.tile(currentTile)){var i=humanity.tile(currentTile),r=travelingNumber(i.h),n=t;if(1<terrain.humanTravelSpeedPath(currentTile,n).length&&i.c===playerCamp){if(i.f<=0){var a={};a[terrain.keyFromTile(currentTile)]=i,addStarveMessages(a)}sendMove(currentTile,n,r)}else if(0<r){var o,s=MAX_INT;for(var l in accessibleTiles){var c=terrain.tileFromKey(l),u=terrain.distanceBetweenTiles(c,n);u<s&&(o=c,s=u)}null!=o&&(sendMove(currentTile,o,r),t=o)}enterMode(selectionModes.normal)}else sendPos(currentTile,t);currentTile=t,updateCurrentTileInformation(),paint(gs)}function showPath(e){mousePosition={x:e.clientX,y:e.clientY},currentTile&&selectionMode===selectionModes.travel&&(targetTile=tileFromPixel(mousePosition,gs.origin,gs.hexSize),paint(gs),paintHumans(gs,humanityData))}function mouseDrag(e){gs.canvas.style.cursor="move",gs.canvas.removeEventListener("mousemove",mouseDrag),gs.canvas.removeEventListener("mouseup",mouseSelection),gs.canvas.addEventListener("mouseup",mouseEndDrag),gs.canvas.addEventListener("mousemove",dragMap),clearInterval(humanAnimationTimeout),currentlyDragging=!0,resetDragVector(),dragVelTo=setInterval(resetDragVector,dragVelInterval)}function mouseEndDrag(e){gs.canvas.style.cursor="",gs.canvas.removeEventListener("mousemove",dragMap),gs.canvas.removeEventListener("mouseup",mouseEndDrag),humanAnimationTimeout=setInterval(animateHumans,100),currentlyDragging=!1,paint(gs),clearInterval(dragVelTo),computeDragVelocity(),inertiaDragMap()}window.onkeydown=function(e){var t=!1,i=!1;if(39===e.keyCode||68===e.keyCode)gs.origin.x0+=gs.width/2|0,i=!0;else if(38===e.keyCode||87===e.keyCode)gs.origin.y0-=gs.height/2|0,i=!0;else if(37===e.keyCode||65===e.keyCode)gs.origin.x0-=gs.width/2|0,i=!0;else if(40===e.keyCode||83===e.keyCode)gs.origin.y0+=gs.height/2|0,i=!0;else if(187===e.keyCode||61===e.keyCode){var r=16;gs.hexSize*=r,gs.origin.x0=(gs.origin.x0*r|0)+((r-1)*gs.width>>1),gs.origin.y0=(gs.origin.y0*r|0)+((r-1)*gs.height>>1),i=t=!0}else if(173===e.keyCode||189===e.keyCode||109===e.keyCode||219===e.keyCode||169===e.keyCode){r=16;gs.hexSize/=r,gs.origin.x0=(gs.origin.x0/r|0)-((1-1/r)*gs.width>>1),gs.origin.y0=(gs.origin.y0/r|0)-((1-1/r)*gs.height>>1),i=t=!0}else 84===e.keyCode?(splitPanelSlider(100),enterMode(selectionModes.travel)):70===e.keyCode?(splitPanelSlider(50),enterMode(selectionModes.travel)):67===e.keyCode?enterMode(selectionModes.build):192===e.keyCode?sendBuild(currentTile,null):27===e.keyCode?(enterMode(selectionModes.normal),helpPane.style.display="none"):48<=e.keyCode&&e.keyCode<=57&&sendBuild(currentTile,buildHotKeys[e.keyCode]);t&&(cachedPaint={}),i&&paint(gs)},canvas.addEventListener("mousemove",showPath),gs.canvas.onmousedown=function(e){0===e.button?(gs.canvas.addEventListener("mouseup",mouseSelection),gs.canvas.addEventListener("mousemove",mouseDrag),lastMousePosition.clientX=e.clientX,lastMousePosition.clientY=e.clientY):2===e.button&&(enterTravelMode(),splitPanelSlider(100),mouseSelection(e),enterNormalMode())},gs.canvas.oncontextmenu=function(e){e.preventDefault()},function(){var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,0)};window.requestAnimationFrame=e}();var lastMousePosition={clientX:0,clientY:0},drawingWhileDragging=!1,currentlyDragging=!1;function dragMap(e){if(!drawingWhileDragging){drawingWhileDragging=!0;var t=lastMousePosition.clientX-e.clientX,i=lastMousePosition.clientY-e.clientY;gs.origin.x0+=t,gs.origin.y0+=i,lastMousePosition.clientX=e.clientX,lastMousePosition.clientY=e.clientY,paint(gs),requestAnimationFrame(function(){drawingWhileDragging=!1})}}canvas.onselectstart=function(){return!1};var dragVelTo,dragVelocity=[0,0],dragVector=[0,0],dragTime=0,dragVelInterval=200;function resetDragVector(){dragTime=Date.now(),dragVector[0]=gs.origin.x0,dragVector[1]=gs.origin.y0}function computeDragVelocity(){dragTime=Date.now()-dragTime,dragVector[0]=gs.origin.x0-dragVector[0],dragVector[1]=gs.origin.y0-dragVector[1];var e=.03*dragTime;dragVelocity[0]=dragVector[0]/e|0,dragVelocity[1]=dragVector[1]/e|0}function inertiaDragMap(){gs.origin.x0+=dragVelocity[0],gs.origin.y0+=dragVelocity[1],dragVelocity[0]=dragVelocity[0]/1.1|0,dragVelocity[1]=dragVelocity[1]/1.1|0,paint(gs),requestAnimationFrame(function(){0===dragVelocity[0]&&0===dragVelocity[1]||inertiaDragMap()})}