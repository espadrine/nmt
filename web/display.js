function tileType(e,t){return t?tileVegetationTypeFromSteepness[e]:e}function terrain(e){var t,i;void 0===e.x?(t=Math.sqrt(3)*(e.q+e.r/2)|0,i=1.5*e.r):(t=e.x,i=e.y);var n=simplex2.noise2D(i/500,t/500),r=1-Math.abs((4*simplex1.noise2D(t/4/factor,i/4/factor)+2*simplex1.noise2D(t/2/factor,i/2/factor)+1*simplex1.noise2D(t/1/factor,i/1/factor)+.5*simplex1.noise2D(2*t/factor,2*i/factor))/7.5),a=Math.sin(-(5*n)*Math.abs(simplex1.noise2D(.25*t/factor,.25*i/factor))+simplex1.noise2D(t/factor,i/factor)-.5*simplex1.noise2D(2*t/factor,2*i/factor)+.25*simplex1.noise2D(4*t/factor,4*i/factor)-1/8*simplex1.noise2D(8*t/factor,8*i/factor)+1/16*simplex1.noise2D(16*t/factor,16*i/factor)),o=-simplex2.noise2D(i/factor/8,t/factor/8)+simplex2.noise2D(i/factor/4,t/factor/4)+a/2,s=n*simplex2.noise2D(t/factor,i/factor)+.5*simplex2.noise2D(2*t/factor,2*i/factor)+.25*simplex2.noise2D(4*t/factor,4*i/factor)+1/8*simplex2.noise2D(8*t/factor,8*i/factor)+1/16*simplex2.noise2D(16*t/factor,16*i/factor),l=r-(a>.6?r:0)>.98||-.7>3*o/4+a/4?tileTypes.water:-1>s?tileTypes.hill:.1>a-r/2?tileTypes.steppe:.2>a-r?tileTypes.hill:tileTypes.mountain,c=s-(l===tileTypes.water?2*o:0)+Math.abs(a+.15)<0,u={steepness:l,vegetation:c,type:tileType(l,c),rain:-s/2};return u}function distance(e){var t=terrain(e),i=humanity(e),n=distances[i&&i.b?i.b:t.type];return void 0===n&&(n=distances[t.type]),n}function neighborFromTile(e,t){return 0===t?{q:e.q+1,r:e.r}:1===t?{q:e.q+1,r:e.r-1}:2===t?{q:e.q,r:e.r-1}:3===t?{q:e.q-1,r:e.r}:4===t?{q:e.q-1,r:e.r+1}:5===t?{q:e.q,r:e.r+1}:void 0}function keyFromTile(e){return e.q+":"+e.r}function tileFromKey(e){var t=e.split(":");return{q:+t[0],r:+t[1]}}function travelFrom(e,t){var i=humanity(e).c,n={},r=keyFromTile(e);n[r]=null;var a={};a[r]=0;var o=[];for(o.push(r);o.length>0;){r=o.shift();var s=humanity(tileFromKey(r));if(!s||null==s.c||s.c===i)for(var l=0;6>l;l++){var c=neighborFromTile(tileFromKey(r),l),u=a[r]+distance(c);if(t>=u){var d=keyFromTile(c);if(void 0!==a[d]&&u<a[d]&&delete a[d],void 0===a[d]&&void 0===n[d]){a[d]=u,n[d]=r;for(var m=-1,p=0;p<o.length;p++)if(void 0!==a[o[p]]){if(a[d]<=a[o[p]]){m=p;break}}else o.splice(p,1),p--;-1===m?o.push(d):o.splice(m,0,d)}}}}return n}function travelTo(e,t,i,n,r){null==n&&(n=MAX_INT),null==r&&(r=humanity(e));var a=r.c,o=keyFromTile(t),s={},l={},c={},u=[],d={},m=keyFromTile(e);for(d[m]=null,l[m]=0,u.push(m);u.length>0&&o!==m;){m=u.shift(),s[m]=!0;var p=humanity(tileFromKey(m));if(!p||null==p.c||p.c===a)for(var h=0;6>h;h++){var g=neighborFromTile(tileFromKey(m),h),y=distance(g);if(!(y>i)){if(0>=n)return null;n--;var f=l[m]+y,v=keyFromTile(g);if(void 0!==l[v]&&f<l[v]&&delete l[v],void 0===l[v]&&void 0===s[v]){l[v]=f,c[v]=f+(Math.abs(t.q-g.q)+Math.abs(t.r-g.r)+Math.abs(t.q+t.r-g.q-g.r))/2;for(var T=-1,x=0;x<u.length;x++)if(void 0!==c[u[x]]){if(c[v]<=c[u[x]]){T=x;break}}else u.splice(x,1),x--;-1===T?u.push(v):u.splice(T,0,v),d[v]=m}}}}return o!==m?null:{endKey:o,parents:d,costs:l}}function pathFromParents(e,t){var i=[];if(null==t[e])return[];for(;null!==t[e];)i.push(e),e=t[e];return i.push(e),i.reverse()}function setDistancesForHuman(e){0!==(e.o&manufacture.boat)?(distances[tileTypes.water]=1,distances[tileTypes.swamp]=1):0!==(e.o&manufacture.plane)&&(distances[tileTypes.water]=2,distances[tileTypes.swamp]=2)}function unsetDistancesForHuman(){distances[tileTypes.water]=normalWater,distances[tileTypes.swamp]=normalSwamp}function humanTravelFrom(e){var t=humanity(e);if(!t||t.h<=0)return{};setDistancesForHuman(t);var i=travelFrom(e,speedFromHuman(t));return unsetDistancesForHuman(t),i}function humanTravelTo(e,t,i,n){if(null==n&&(n=humanity(e)),!n||n.h<=0)return null;setDistancesForHuman(n);var r=travelTo(e,t,speedFromHuman(n),i,n);return unsetDistancesForHuman(n),r}function humanTravelPath(e,t){var i=humanTravelTo(e,t);return null==i?[]:pathFromParents(i.endKey,i.parents)}function manufactureFromBuilding(e){return e===tileTypes.dock?manufacture.boat:e===tileTypes.factory?manufacture.car:e===tileTypes.airport?manufacture.plane:e===tileTypes.gunsmith?manufacture.gun:null}function speedFromHuman(e){return 0!==(e.o&manufacture.plane)?32:0!==(e.o&manufacture.car)?16:8}function validConstruction(e,t,i){if(null==e)return!0;var n=humanity(t),r=terrain(t),a=i.lumber-i.usedLumber,o=i.metal-i.usedMetal,s=i.farm-i.usedFarm;if(!n||n.h<=0)return!1;if(r.type===tileTypes.water&&(e===tileTypes.farm||e===tileTypes.residence||e===tileTypes.skyscraper||e===tileTypes.factory||e===tileTypes.airland||e===tileTypes.airport||e===tileTypes.gunsmith))return!1;if(void 0!==buildingTileDependency[e]){for(var l=!1,c=0;c<buildingTileDependency[e].length;c++)(buildingTileDependency[e][c]===r.type||buildingTileDependency[e][c]===n.b)&&(l=!0);if(!l)return!1}if(void 0!==buildingDependencies[e]){for(var u=buildingDependencies[e],d=new Array(u.length),c=0;c<d.length;c++)d[c]=0;for(var c=0;6>c;c++)for(var m=neighborFromTile(t,c),p=humanity(m),h=terrain(m),g=0;g<u.length;g++)if(u[g][1]>=0&&p&&p.b===u[g][1]||h.type===u[g][1])d[g]++;else if(u[g][1]<0){if(u[g][1]===resourceTypes.lumber&&a<u[g][0])return!1;if(u[g][1]===resourceTypes.metal&&o<u[g][0])return!1;if(u[g][1]===resourceTypes.farm&&s<u[g][0])return!1;d[g]=u[g][0]}for(var g=0;g<d.length;g++)if(d[g]<u[g][0])return!1;return!0}return!0}function addPlan(e){plans[e.at]=e}function eachPlan(e){for(var t in plans)e(plans[t])}function clearPlans(){plans={}}function connectSocket(e){e=e||function(){},socket=new WebSocket("ws"+window.location.protocol.slice(4)+"//"+window.location.hostname+(window.location.port.length>0?":"+window.location.port:"")+"/$websocket:act"),socket.onmessage=socketMessage,socket.onclose=socket.onerror=socketError,socket.onopen=function(){retries=0,e()}}function socketMessage(e){var t=JSON.parse(e.data);if(t.lockedTiles)lockedTiles=t.lockedTiles;else if(t.winners)gameOver={},gameOver.winners=t.winners,gameOver.winType=t.winType,gameOver.winners[0]===playerCamp&&(localStorage.getItem("gamesWon")||localStorage.setItem("gamesWon",0),localStorage.setItem("gamesWon",+localStorage.getItem("gamesWon")+1));else{if(void 0!==t.camp&&(playerCamp=t.camp,delete t.camp),void 0!==t.resources&&(campResources=t.resources,resources=t.resources[playerCamp],delete t.resources),void 0!==t.population&&(humanityPopulation=t.population,delete t.population),void 0!==t.war&&(addHumanMessages(warTiles,t.war,warMessages),delete t.war),void 0!==t.surrender&&(addHumanMessages(surrenderTiles,t.surrender,surrenderMessages),delete t.surrender),void 0!==t.goto&&(gotoPlace(t.goto),delete t.goto),void 0!==t.places&&(insertPlaces(t.places),delete t.places),void 0!==t.campNames&&(campNames=t.campNames,delete t.campNames),humanityPopulation){var i=humanityResource(function(e){return e.farm-e.usedFarm}),n=humanityResource(function(e){return e.lumber-e.usedLumber}),r=humanityResource(function(e){return e.metal-e.usedMetal}),a=humanityResource(function(e){return Object.keys(e.acquiredUniversitiesMap).length});setResourcePanel(humanityPopulation,populationPanel,populationMaxPanel,populationMaxCampPanel),setResourcePanel(i,farmPanel,farmMaxPanel,farmMaxCampPanel),setResourcePanel(n,woodPanel,woodMaxPanel,woodMaxCampPanel),setResourcePanel(r,metalPanel,metalMaxPanel,metalMaxCampPanel),setResourcePanel(a,uniPanel,uniMaxPanel,uniMaxCampPanel)}addStarveMessages(t),changeHumanity(humanityData,t),paintPopulation(),updateCurrentTileInformation(),updateCachedPaint(gs,t)}paint(gs),paintHumans(gs,humanityData)}function socketError(){retries++,1>retries?setTimeout(connectSocket,50):1===retries&&alert("You are disconnected.\nPlease reload the page.")}function sendMove(e,t,i){if(e&&t){var n=keyFromTile(t);if(registerMoves[n]=e,1===socket.readyState){var r=keyFromTile(e);socket.send(JSON.stringify({at:r,"do":planTypes.move,to:n,h:i}))}else connectSocket(function(){sendMove(e,t,i)})}}function sendPos(e,t){socket.send(JSON.stringify({at:e?keyFromTile(e):null,to:keyFromTile(t)}))}function sendBuild(e,t){e&&(1===socket.readyState?socket.send(JSON.stringify({at:keyFromTile(e),"do":planTypes.build,b:t})):connectSocket(function(){sendBuild(e,t)}))}function insertPlaces(e){placesPanel.innerHTML=defaultPlacesPanelHTML;for(var t in e){var i=document.createElement("p");i.classList.add("buildSelection"),i.classList.add("validSelection");var n=document.createElement("hr");n.classList.add("separator"),placesPanel.appendChild(n);var r=tileFromKey(t);i.setAttribute("data-tilekey",t),i.innerHTML='<div style="position:absolute;">→</div> <br>'+e[t],i.addEventListener("click",function(e){return function(){gotoPlace(e),paint(gs)}}(r)),placesPanel.appendChild(i)}}function setResourcePanel(e,t,i,n){t.value=e[playerCamp];for(var r=0,a=0,o=0;o<e.length;o++)e[o]>a&&(r=o,a=e[o]);i.value=a,n.value=campNames[r],n.style.color=campHsl(r)}function humanityResource(e){for(var t=[],i=0;i<campResources.length;i++)t[i]=e(campResources[i]);return t}function gotoPlace(e){var t=pixelFromTile(e,{x0:0,y0:0},gs.hexSize);gs.origin.x0=t.x-(gs.width/2|0),gs.origin.y0=t.y-(gs.height/2|0)}function orientPlacesArrow(){for(var e=1;e<placesPanel.childNodes.length;e++){var t=placesPanel.childNodes[e];if(t.getAttribute&&null!=t.getAttribute("data-tilekey")){var i={x:gs.origin.x0+(gs.width/2|0),y:gs.origin.y0+(gs.height/2|0)},n=pixelFromTile(tileFromKey(t.getAttribute("data-tilekey")),{x0:0,y0:0},gs.hexSize),r=-orientation(i,n),a=t.firstChild;a.style.transform="rotate("+r+"rad)",a.style.WebkitTransform="rotate("+r+"rad)",a.nextSibling.textContent=kmDistance(i,n).toFixed(2)+"km"}}}function orientation(e,t){var i=Math.atan((e.y-t.y)/Math.abs(t.x-e.x));return t.x<e.x&&(i=Math.PI-i),i}function pixelDistance(e,t){var i=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return Math.sqrt(i*i+n*n)}function kmDistance(e,t){return pixelDistance(e,t)/gs.hexSize*.025}function humanity(e){return humanityData[e.q+":"+e.r]}function changeHumanity(e,t){for(var i in t)e[i]=t[i],delete registerMoves[i]}function showHelp(e){helpPane.src="help/"+e+".html",helpPane.onload=function(){helpPane.style.display="block",helpPane.style.height=helpPane.contentWindow.document.body.clientHeight+40+"px",addEventListener("click",hideHelp)}}function hideHelp(){helpPane.style.display="none",removeEventListener("click",hideHelp)}function intPointFromReal(e){var t=e.q,i=e.r,n=-t-i,r=Math.round(t),a=Math.round(n),o=Math.round(i),s=Math.abs(r-t),l=Math.abs(a-n),c=Math.abs(o-i);return s>l&&s>c?r=-a-o:l>c?a=-r-o:o=-r-a,{q:r,r:o}}function tileFromPixel(e,t,i){var n=e.x+t.x0,r=e.y+t.y0;return intPointFromReal({q:(Math.sqrt(3)*n-r)/3/i,r:2*r/3/i})}function pixelFromTile(e,t,i){return{x:(i*Math.sqrt(3)*(e.q+e.r/2)|0)-t.x0,y:3*i/2*e.r-t.y0}}function noisyPixel(e,t){var i=terrain(t),n={x:0,y:0};return n.x+=(t.q^t.r^(128*i.rain|0))%e,n.y+=(t.q^t.r^(256*i.rain|0))%e,n}function loadSprites(){var e=new Image;return e.src="sprites.png",e}function makeGraphicState(e,t){var i=e.getContext("2d"),n=20,r=2*n;return{hexSize:n,origin:{x0:0,y0:0},canvas:e,ctx:i,width:e.width,height:e.height,sprites:t,spritesWidth:r}}function pathAlongTiles(e,t){var i=e.ctx,n=e.hexSize,r=e.origin;if(i.beginPath(),!(t.length<2)){{var a,o=pixelFromTile(tileFromKey(t[0]),r,n);0|o.x,0|o.y}i.moveTo(0|o.x,0|o.y);for(var s=0;s<t.length-1;s++){cpNext=pixelFromTile(tileFromKey(t[s+1]),r,n);var l=averagePoint(o,cpNext);i.quadraticCurveTo(0|o.x,0|o.y,0|l.x,0|l.y),s===t.length-2&&(a=o),o=cpNext}o=pixelFromTile(tileFromKey(t[t.length-1]),r,n);var c=(a.x-o.x)/10,u=(a.y-o.y)/10;i.lineTo(o.x+c,o.y+u),i.lineTo(o.x+c-2*u/3,o.y+u+2*c/3),i.lineTo(o.x,o.y),i.lineTo(o.x+c+2*u/3,o.y+u-2*c/3),i.lineTo(o.x+c,o.y+u)}}function paintAlongTiles(e,t){{var i=e.ctx;e.hexSize,e.origin}pathAlongTiles(e,t),i.strokeStyle="#ccf",i.lineWidth="5",i.stroke(),i.strokeStyle="red",i.lineWidth="3",i.stroke(),i.lineWidth="1"}function straightPathFromTiles(e,t,i,n){var r=e.ctx,a=e.hexSize,o=e.origin;r.beginPath();for(var s in t){for(var l=tileFromKey(s),c=pixelFromTile(l,o,a),u=(c.x,c.y,0),d=0;6>d;d++){var m=neighborFromTile(l,d);u|=(void 0!==t[keyFromTile(m)]|0)<<d}partialPathFromHex(e,c,u,i,n)}}function pathFromTiles(e,t,i,n,r,a){var o=e.ctx,s=e.hexSize,l=e.origin;o.beginPath();var c=[];for(var u in t)for(var d=tileFromKey(u),m=(pixelFromTile(d,l,s),0);6>m;m++){var p=neighborFromTile(d,m);void 0===t[keyFromTile(p)]&&(c=c.concat(vertexFromFace(u,m)))}pathFromPolygons(e,polygonFromVertices(e,c,i,r),!!a)}function straightPolygonPathFromTiles(e,t){var i=e.ctx,n=e.hexSize,r=e.origin,a=n*Math.sqrt(3);i.beginPath();var o=[];for(var s in t)for(var l=tileFromKey(s),c=(pixelFromTile(l,r,n),0);6>c;c++){var u=neighborFromTile(l,c);void 0===t[keyFromTile(u)]&&(o=o.concat(vertexFromFace(s,c)))}for(var d=polygonFromVertices(e,o,a),m=0;m<d.length;m++)partialPathFromPolygon(e,d[m])}function vertexFromFace(e,t){var i=(t+4)%6,n=(i+1)%6;return[vertexFromTileKey(e,i),vertexFromTileKey(e,n)]}function vertexFromTileKey(e,t){return 0===t?keyFromTile(neighborFromTile(tileFromKey(e),2))+":0":1===t?keyFromTile(neighborFromTile(tileFromKey(e),3))+":1":2===t?keyFromTile(neighborFromTile(tileFromKey(e),3))+":0":3===t?keyFromTile(neighborFromTile(tileFromKey(e),4))+":1":4===t?e+":0":5===t?e+":1":"invalid:vertex:key"}function pointFromVertex(e,t,i,n){var r=e.hexSize,a=e.origin,o=+t.slice(-1),s=t.slice(0,-2),l=tileFromKey(s),c=pixelFromTile(l,a,r),u=0|c.x,d=0|c.y,m=i/2|0,p=r/2|0,h=n?noisyPixel(r/2,l):{x:0,y:0};return 0===o?{x:u+m+h.x,y:d+p+h.y}:1===o?{x:u+m,y:d-p}:void 0}function polygonFromVertices(e,t,i,n){for(var r=(e.hexSize,e.origin,new Array(t.length)),a=0;a<t.length;a++)r[a]=t[a];for(var o=[];r.length>0;){for(var s=r.shift(),l=r.shift(),c=[pointFromVertex(e,s,i,n),pointFromVertex(e,l,i,n)],u=1e4;l!==s&&u-->0;)for(var a=0;a<r.length;a+=2){if(r[a]===l){c.push(pointFromVertex(e,r[a+1],i,n)),l=r[a+1],r.splice(a,2);break}if(r[a+1]===l){c.push(pointFromVertex(e,r[a],i,n)),l=r[a],r.splice(a,2);break}}c.pop(),o.push(c)}return o}function partialPathFromPolygon(e,t){var i=e.ctx;i.moveTo(t[0].x,t[0].y);for(var n=1;n<t.length;n++)i.lineTo(t[n].x,t[n].y);i.closePath()}function pathFromPolygons(e,t,i){var n=e.ctx;n.beginPath();for(var r=0;r<t.length;r++)partialPathForSmoothPolygon(e,t[r],!!i)}function averagePoint(e,t){return{x:e.x+t.x>>1,y:e.y+t.y>>1}}function extremizePoint(e,t){var i=averagePoint(a1,c2),n=averagePoint(a2,c1);return{x:t.x-(i.x-t.x)/2|0+(n.x-t.x)/2|0,y:t.y-(i.y-t.y)/2|0+(n.y-t.y)/2|0}}function partialPathForSmoothPolygon(e,t,i){i=!!i;var n=e.ctx;if(t.length<3)return partialPathFromPolygon(e,t);for(var r,a=new Array(t.length),o=0;o<t.length;o++)r=averagePoint(t[o],t[(o+1)%t.length]),a[o]=r;var r=averagePoint(a[0],a[1]);n.moveTo(r.x,r.y);for(var o=1;o<a.length;o++)r=averagePoint(a[o],a[(o+1)%a.length]),i&&o%2===0?n.moveTo(r.x,r.y):n.quadraticCurveTo(a[o].x,a[o].y,r.x,r.y);i||(r=averagePoint(a[0],a[1]),n.quadraticCurveTo(a[0].x,a[0].y,r.x,r.y))}function partialPathFromHex(e,t,i,n){var r=e.ctx,a=e.hexSize;i=0|i;var o=0|t.x,s=0|t.y,l=n/2|0,c=a/2|0;r.moveTo(o,s-a);var u=o-l,d=s-c;0===(4&i)?r.lineTo(u,d):r.moveTo(u,d),u=o-l,d=s+c,0===(8&i)?r.lineTo(u,d):r.moveTo(u,d),u=o,d=s+a,0===(16&i)?r.lineTo(u,d):r.moveTo(u,d),u=o+l,d=s+c,0===(32&i)?r.lineTo(u,d):r.moveTo(u,d),u=o+l,d=s-c,0===(1&i)?r.lineTo(u,d):r.moveTo(u,d),u=o,d=s-a,0===(2&i)?r.lineTo(u,d):r.moveTo(u,d)}function pathFromHex(e,t,i,n){{var r=e.ctx;e.hexSize}r.beginPath(),partialPathFromHex(e,t,0,i,n)}function paintAroundTiles(e,t,i){var n=e.ctx,r=e.hexSize,a=(e.origin,r*Math.sqrt(3)),o=3*r/2;pathFromTiles(e,t,a,o,!0),n.strokeStyle=i||"white",n.stroke()}function paintStraightAroundTiles(e,t,i){var n=e.ctx,r=e.hexSize,a=(e.origin,r*Math.sqrt(3)),o=3*r/2;straightPathFromTiles(e,t,a,o),n.strokeStyle=i||"white",n.stroke()}function paintTileHexagon(e,t,i,n){var r=e.ctx,a=e.hexSize,o=e.origin,s=(a*Math.sqrt(3),3*a/2),l=pixelFromTile(t,o,a),c=s;r.beginPath(),r.arc(l.x,l.y,c,0,2*Math.PI,!0),r.closePath(),r.strokeStyle=i,r.lineWidth=n?n:3,r.stroke(),r.lineWidth=1}function paintSprite(e,t,i,n,r){var a=e.ctx,o=e.hexSize,s=e.spritesWidth;a.save(),a.translate(t,i),a.rotate(r*mπd3),a.drawImage(sprites,0,s*n|0,s,s,0|-o,0|-o,2*o|0,2*o|0),a.restore()}function paintBuilding(e,t,i,n,r){var a=(e.ctx,e.hexSize,humanity(n));if(null!=a&&null!=a.b)if(a.b===tileTypes.road||a.b===tileTypes.wall||a.b===tileTypes.airland){for(var o=!1,s=0;6>s;s++){var l=humanity(neighborFromTile(n,s));l&&((a.b===tileTypes.road||a.b===tileTypes.wall)&&l.b===a.b||a.b===tileTypes.airland&&l.b===tileTypes.airport)&&(paintSprite(e,t,i,a.b,s),o=!0)}o||paintSprite(e,t,i,a.b,0)}else a.b===tileTypes.airport||a.b===tileTypes.factory||a.b>tileTypes.wall?paintSprite(e,t,i,a.b,0):paintSprite(e,t,i,a.b,r)}function paintBuildingsSprited(e){for(var t=e.width,i=e.height,n=(e.ctx,e.origin),r=e.hexSize,a=tileFromPixel({x:0,y:0},n,r),o=pixelFromTile({q:a.q,r:a.r-1},n,r),s=o.x,l=o.y,c=r*Math.sqrt(3),u=3*r/2,d=!0;i>l-u;){for(;t>s-c;){a=tileFromPixel({x:s,y:l},e.origin,r);var m=terrain(a),p=(a.q^a.r^(128*m.rain|0))%6;paintBuilding(e,s,l,a,p),s+=c}l+=u,s=o.x,d?(s-=c/2,d=!1):d=!0,s=Math.floor(s),l=Math.floor(l)}}function paintTerrain(e,t,i,n,r,a){var o=e.ctx,s=(e.hexSize,terrain(a)),l=(a.q^a.r^(128*s.rain|0))%6;paintSprite(e,t,i,s.type,l),pathFromHex(e,{x:t,y:i},n,r);var c=0|Math.floor((1-s.rain)/2*127);if(s.type===tileTypes.water){for(var u=!1,d=0;6>d;d++)terrain(neighborFromTile(a,d)).type!==tileTypes.water&&(u=!0);u&&(c+=20),o.fillStyle="rgba("+c+","+c+","+c+",0.3)"}else{var m=Math.abs(c-63.5)/1|0,p=c,h=c;if(63.5>c?(p-=m,h+=m):c>63.5&&(p+=2*m,h+=m),s.type===tileTypes.steppe){var g=neighborFromTile(a,0),y=neighborFromTile(a,3);(terrain(g).type===tileTypes.water||terrain(y).type===tileTypes.water)&&(p+=(127-c)/2|0,h+=(127-c)/4|0)}o.fillStyle="rgba("+p+","+h+","+c+",0.3)"}o.fill()}function paintTilesSprited(e){var t=e.width,i=e.height,n=e.ctx,r=e.hexSize,a=e.origin,o=tileFromPixel({x:0,y:0},a,r),s=pixelFromTile({q:o.q,r:o.r-1},a,r),l=s.x,c=s.y,u=r*Math.sqrt(3),d=3*r/2,m=r+":"+a.x0+":"+a.y0;if(void 0===cachedTerrainPaint[m]){var p=document.createElement("canvas");p.width=canvas.width,p.height=canvas.height;var h=makeGraphicState(p,sprites);h.hexSize=e.hexSize;for(var g=!0;i>c-d;){for(;t>l-u;)o=tileFromPixel({x:l,y:c},a,r),paintTerrain(h,l,c,u,d,o),l+=u;c+=d,l=s.x,g?(l-=u/2,g=!1):g=!0,l=Math.floor(l),c=Math.floor(c)}cachedTerrainPaint[m]=p}n.drawImage(cachedTerrainPaint[m],0,0)}function paintTilesRaw(e){for(var t=n.canvas.width,i=n.canvas.height,n=e.ctx,r=e.hexSize,a=e.origin,o=n.getImageData(0,0,t,i),s=o.data,l=0;i>l;l++)for(var c=0;t>c;c++){var u=tileFromPixel({x:c,y:l},a,r),d=terrain(u),m=[180,0,0];d.steepness==tileTypes.water?m=[50,50,180]:d.steepness==tileTypes.steppe?m=[0,180,0]:d.steepness==tileTypes.hill&&(m=[180,100,0]);var p=Math.min(Math.abs(m[0]-m[1])/2*d.rain,255);m[0]-=p,m[1]-=p,m[2]-=Math.min(50*d.rain,255),d.vegetation&&(m[0]-=100,m[1]-=50,m[2]-=100);var h=4*(c+l*t);s[h+0]=m[0],s[h+1]=m[1],s[h+2]=m[2],s[h+3]=255}n.putImageData(o,0,0)}function paintTiles(e,t){var i=e.ctx,n=e.hexSize,r=e.origin;5>n?(renderWorker.addEventListener("message",function a(e){e.data.origin.x0===r.x0&&e.data.origin.y0===r.y0&&e.data.size===n&&(i.putImageData(e.data.image,0,0),renderWorker.removeEventListener("message",a),t())}),workerMessage.image=imageBuffer,workerMessage.size=n,workerMessage.origin=r,renderWorker.postMessage(workerMessage)):(paintTilesSprited(e),paintBuildingsSprited(e),t())}function getCachedPaint(e,t,i,n){var r=t+":"+i,a=cachedPaint[r];if(null==a){var o=document.createElement("canvas");if(o.width=e.width,o.height=e.height,void 0===a){var s=o.getContext("2d");s.fillStyle="black",s.fillRect(0,0,e.width,e.height),n(o)}if(void 0===cachePending[r]){cachePending[r]=n;var l=makeGraphicState(o,sprites);l.hexSize=e.hexSize,l.origin={x0:t,y0:i},paintTiles(l,function(){a=cachedPaint[r]=o,cachePending[r](a),delete cachePending[r]})}else cachePending[r]=n}else n(a)}function drawCachedPaint(e,t,i,n,r){var a=t+":"+i,o=cachedPaint[a];null!=o&&e.ctx.drawImage(o,n,r)}function regionFromPixel(e,t,i,n){var r,a,r=e%i;0>r&&(r+=i);var a=t%n;0>a&&(a+=n);var o=e-r,s=t-a;return o+":"+s}function updateCachedRegion(e,t,i,n){cachedPaint[regionFromPixel(e,t,i,n)]=null}function updateCachedPaint(e,t){var i=e.hexSize,n=e.origin;for(var r in t){var a=tileFromKey(r),o=pixelFromTile(a,n,i),s=e.width,l=e.height,c=o.x+n.x0-i/2,u=o.y+n.y0-i/2;updateCachedRegion(c,u,s,l),updateCachedRegion(c+i,u,s,l),updateCachedRegion(c,u+i,s,l),updateCachedRegion(c+i,u+i,s,l)}}function paintTilesFromCache(e,t){var i=e.ctx,n=e.origin,r=e.width,a=e.height,o=n.x0%r;0>o&&(o+=r);var s=n.y0%a;0>s&&(s+=a);var l=n.x0-o,c=n.x0+r-o,u=n.y0-s,d=n.y0+a-s,m=0,p=function(n,r){return function(a){4>=m?i.drawImage(a,n,r):paintTilesFromCurrentCache(e),m++,m>=4&&t()}};getCachedPaint(e,l,u,p(-o,-s)),getCachedPaint(e,c,u,p(r-o,-s)),getCachedPaint(e,l,d,p(-o,a-s)),getCachedPaint(e,c,d,p(r-o,a-s))}function paintTilesFromCurrentCache(e){var t=(e.ctx,e.origin),i=e.width,n=e.height,r=t.x0%i;0>r&&(r+=i);var a=t.y0%n;0>a&&(a+=n);var o=t.x0-r,s=t.x0+i-r,l=t.y0-a,c=t.y0+n-a;drawCachedPaint(e,o,l,-r,-a),drawCachedPaint(e,s,l,i-r,-a),drawCachedPaint(e,o,c,-r,n-a),drawCachedPaint(e,s,c,i-r,n-a)}function paint(e){e.ctx,e.hexSize,e.origin;selectionMode===selectionModes.places&&orientPlacesArrow(),spritesLoaded&&paintTilesFromCache(e,function(){paintIntermediateUI(e)})}function paintIntermediateUI(e){{var t=e.ctx;e.hexSize,e.origin}for(var i in lockedTiles)paintTileHexagon(e,tileFromKey(i),campHsl(lockedTiles[i]),1);null!=currentTile&&null!=playerCamp&&paintTileHexagon(e,currentTile,campHsl(playerCamp,100,40)),paintCamps(e),t.lineWidth=1.5,paintAroundTiles(e,accessibleTiles),t.lineWidth=1,null==currentTile||null==targetTile||selectionMode!==selectionModes.travel&&selectionMode!==selectionModes.split||paintAlongTiles(e,pathFromParents(keyFromTile(targetTile),accessibleTiles));for(var n in registerMoves)paintAlongTiles(e,humanTravelPath(registerMoves[n],tileFromKey(n)));paintTileMessages(e),void 0!==gameOver&&drawTitle(e,[campNames[gameOver.winners[0]]+" won a "+gameOver.winType+" Victory.",gameOver.winners[0]===playerCamp?"YOU WON! ("+nth(localStorage.getItem("gamesWon"))+" win!)":"YOU NEARLY WON! ("+nth(gameOver.winners.indexOf(playerCamp)+1)+" place!)","You can reload to engage in the next game!"],campHsl(gameOver.winners[0])),showTitleScreen&&drawTitle(e,["Welcome to Thaddée Tyl's…","NOT MY TERRITORY","(YET)"]),displayedPaintContext.drawImage(canvas,0,0)}function nth(e){e=0|e;var t=""+e;if(49===t.charCodeAt(t.length-2))return t+"th";var i=e%10;return 1===i?t+"st":2===i?t+"nd":3===i?t+"rd":t+"th"}function drawTitle(e,t,i){var n,r=e.ctx,a=e.width,o=e.height,s=t[0],l=t[1],c=t[2];r.fillStyle=i||"black",r.strokeStyle="black",r.textAlign="center",r.font=o/16+'px "Linux Biolinum", sans-serif',n=r.measureText(s).width,r.fillText(s,a/2,1*o/3),r.strokeText(s,a/2,1*o/3),r.font=o/8+'px "Linux Biolinum", sans-serif',n=r.measureText(l).width,r.fillText(l,a/2,13*o/24),r.strokeText(l,a/2,13*o/24),r.font=o/16+'px "Linux Biolinum", sans-serif',n=r.measureText(c).width,r.fillText(c,a/2,2*o/3),r.strokeText(c,a/2,2*o/3),r.textAlign="start"}function initHumans(){for(var e=0;numberOfHumanAnimations>e;e++)humanAnimation[e]={x:Math.random(),y:Math.random(),targetx:Math.random(),targety:Math.random(),period:20*Math.random()+3|0,tick:0}}function updateHumans(){for(var e=0;e<humanAnimation.length;e++){var t=humanAnimation[e];t.x+=(t.targetx-t.x)/t.period,t.y+=(t.targety-t.y)/t.period,t.tick++,t.tick>t.period&&(t.targetx=Math.random(),t.targety=Math.random(),t.tick=0)}}function paintHumans(e,t){var i=e.ctx,n=e.hexSize,r=e.origin;if(!(20>n)){i.drawImage(displayedPaint,0,0);for(var a in t){var o=a.split(":"),s=+o[0],l=+o[1],c=t[a],u=terrain(tileFromKey(a)),d=pixelFromTile({q:s,r:l},r,n),m=d.x,p=d.y,h=c.h;h>humanAnimation.length&&(h=humanAnimation.length);for(var g=0;h>g;g++){var y=humanAnimation[Math.abs(g+s^l^c.f)%humanAnimation.length],f=m-n+2*y.x*n|0,v=p-n+2*y.y*n|0,T=n/20;i.fillStyle="black",u.type!==tileTypes.water&&u.type!==tileTypes.swamp||0===(c.o&manufacture.boat)?0!==(c.o&manufacture.plane)?(i.fillStyle="#edf",i.fillRect(f-T,v-T,2*T,T),i.fillRect(f,v,9*T,T),i.fillRect(f+5*T,v-T,T,T),i.fillRect(f+3*T,v+T,T,T)):0!==(c.o&manufacture.car)?(i.fillStyle="#420",i.fillRect(f,v,3*T,2*T)):i.fillRect(f,v,T,2*T):(i.fillStyle="#aaf",i.fillRect(f-T,v-T,T,T),i.fillRect(f,v,7*T,T),i.fillRect(f+7*T,v-T,T,T))}}}}function animateHumans(){paintHumans(gs,humanityData),updateHumans()}function listVisibleHumans(e){var t,i,n,r,a,o=(e.ctx,e.hexSize),s=e.origin;a=tileFromPixel({x:0,y:e.height},s,o),i=a.q-1,n=a.r+1,a=tileFromPixel({x:e.width,y:0},s,o),t=a.q+1,r=a.r-1;var l=[];for(var c in humanityData)tile=tileFromKey(c),tile.q>=i&&tile.q<=t&&tile.r>=r&&tile.r<=n&&null!=humanityData[c].c&&l.push(c);return l}function paintCamps(e){for(var t=e.ctx,i=e.hexSize,n=e.origin,r=listVisibleHumans(e),a=new Array(numberOfCamps),o=0;numberOfCamps>o;o++)a[o]={};for(var o=0;o<r.length;o++){var s=humanityData[r[o]];a[s.c][r[o]]=!0}var l=2*e.hexSize/3,c=e.hexSize*Math.sqrt(3),u=3*e.hexSize/2;if(5>i)for(var o=0;numberOfCamps>o;o++){t.fillStyle=campHsl(o);var d=a[o];for(var m in d){var p=pixelFromTile(tileFromKey(m),n,i);t.fillRect(p.x-i,p.y-i,2*i,2*i)}}else{for(var o=0;numberOfCamps>o;o++)pathFromTiles(e,a[o],c,u,!0),t.lineWidth=l/4,t.strokeStyle=campHsl(o,70,35),t.stroke(),pathFromTiles(e,a[o],c,u,!0,!0),t.lineWidth=l/8,t.strokeStyle=campHsl(o,80,42),t.stroke();for(var o=0;numberOfCamps>o;o++){pathFromTiles(e,a[o],c,u,!0,!1),t.save(),t.clip(),t.lineWidth=l;var h="hsla("+campHueCreator9000(o)+",70%,40%,0.4)";t.strokeStyle=h,t.stroke(),t.lineWidth=l/4,t.strokeStyle=campHsl(o,70,35),t.stroke(),t.restore(),t.lineWidth=1}}}function campHsl(e,t,i){return null==t&&(t=100),null==i&&(i=45),"hsl("+campHueCreator9000(e)+","+t+"%,"+i+"%)"}function campHueCreator9000(e){return void 0!==campHue[e]?campColors[e]:0===e?270:(campHueCreator9000(e-1)+60)%360}function paintPopulation(){if(humanityPopulation){var e=187,t=10,i="<svg id=populationMonitor>";i+='<rect stroke="hsl(0,0%,40%)" stroke-width="1" x="0" y="0" rx="3" ry="3" width="'+e+'" height="'+t+'" />';for(var n=0,r=0;r<humanityPopulation.length;r++)n+=humanityPopulation[r];for(var a,o=1,s=e-2,l=0,r=0;r<humanityPopulation.length-1;r++)a=s*humanityPopulation[r]/n|0,l+=a,i+='<rect fill="'+campHsl(r)+'" x="'+o+'" y="1" width="'+a+'" height="'+(t-2)+'" />',o+=a;a=s-l,i+='<rect fill="'+campHsl(r)+'" x="'+o+'" y="1" width="'+a+'" height="'+(t-2)+'" /><linearGradient id="grad" y2="100%" x2="0"><stop offset="0" stop-color="#fff" stop-opacity=".1"/><stop offset="1" stop-color="#000" stop-opacity=".2"/></linearGradient><rect fill="url(#grad)" x="1" y="1" width="'+(e-2)+'" height="'+(t-2)+'"/></svg>',populationMonitor.outerHTML=i}}function addHumanMessages(e,t,i){for(var n=0;n<t.length;n++){var r=t[n];e[r]&&clearTimeout(e[r].timeout);var a=i[i.length*Math.random()|0];e[r]={message:a,timeout:setTimeout(function(t){return function(){delete e[t],paint(gs)}}(r),2e3)}}}function addStarveMessages(e){var t=[];for(var i in e)e[i].h>0&&e[i].f<4&&t.push(i);addHumanMessages(starvedTiles,t,hungerMessages)}function paintMessage(e,t,i){var n=e.ctx,r=e.hexSize,a=e.origin;n.font='14px "Linux Biolinum", sans-serif';var o=n.measureText(i).width,s=pixelFromTile(tileFromKey(t),a,r),l=s.x+r/4,c=s.y-r/4;n.beginPath(),n.moveTo(l,c),n.lineTo(l+2,c-10),n.lineTo(l-12,c-10),n.lineTo(l-10,c-40),n.lineTo(l+o+10,c-35),n.lineTo(l+o,c-10),n.lineTo(l+12,c-10),n.closePath(),n.fillStyle="rgba(0,0,0,0.8)",n.fill(),n.strokeStyle="white",n.strokeText(i,l-4,c-20)}function paintTileMessages(e){e.ctx,e.hexSize,e.origin;for(var t in warTiles)paintMessage(e,t,warTiles[t].message);for(var t in surrenderTiles)paintMessage(e,t,surrenderTiles[t].message);for(var t in starvedTiles)paintMessage(e,t,starvedTiles[t].message)}function attributeNameFromTile(){var e=[],t=0;for(var i in tileTypes)e[t++]=i;return e}function showTileInformation(e){var t=terrain(e),i="a "+tileNames[t.type],n=humanity(e);if(null!=n&&(null!=n.b&&(i=("a"===tileNames[n.b][0]?"an ":"a ")+tileNames[n.b]+" built in "+i),n.h>0)){var r="",a=!1;0!==(n.o&manufacture.plane)&&(r+="on a plane ",a=!0),0!==(n.o&manufacture.boat)&&(r+=(t.type!==tileTypes.water||a?"with":(a=!0,"in"))+" a boat "),0!==(n.o&manufacture.car)&&(r+=(a?"with":"in")+" a car "),i=n.h+(0!==(n.o&manufacture.gun)?" armed":"")+" folk"+(1===n.h?"":"s")+" "+r+"in "+i}tileInfo.value=i}function indicateValidConstructions(e){for(var t=0;t<buildingTypes.length;t++)validConstruction(buildingTypes[t],e,resources)?buildSelectionButtons[t].classList.add("validSelection"):buildSelectionButtons[t].classList.remove("validSelection")}function hookBuildSelectionButtons(){for(var e=0;e<buildingTypes.length;e++){var t=function(e){return function(){sendBuild(currentTile,e),enterMode(selectionModes.normal)}}(buildingTypes[e]);buildSelectionButtons[e].addEventListener("click",t)}}function updateCurrentTileInformation(){void 0!==currentTile&&(showTileInformation(currentTile),accessibleTiles=humanTravelFrom(currentTile),indicateValidConstructions(currentTile))}function hidePanel(e,t){e.style.display="none",t.style.fill="black",t.firstElementChild.style.display="block",t.firstElementChild.nextElementSibling.style.display="none"}function showPanel(e,t){e.style.display="block",t.style.fill="#800080",t.firstElementChild.style.display="none",t.firstElementChild.nextElementSibling.style.display="block"}function enterMode(e){selectionMode!==e&&(selectionMode===selectionModes.travel?(hidePanel(travelPanel,travelBut),targetTile=null,travelBut.removeEventListener("click",enterNormalMode),travelBut.addEventListener("click",enterTravelMode)):selectionMode===selectionModes.build?(hidePanel(buildPanel,buildBut),buildBut.removeEventListener("click",enterNormalMode),buildBut.addEventListener("click",enterBuildMode)):selectionMode===selectionModes.split?(hidePanel(splitPanel,splitBut),splitBut.removeEventListener("click",enterNormalMode),splitBut.addEventListener("click",enterSplitMode)):selectionMode===selectionModes.places&&(hidePanel(placesPanel,placesBut),placesBut.removeEventListener("click",enterNormalMode),placesBut.addEventListener("click",enterPlacesMode)),e===selectionModes.travel?(showPanel(travelPanel,travelBut),travelBut.addEventListener("click",enterNormalMode)):e===selectionModes.build?(showPanel(buildPanel,buildBut),buildBut.addEventListener("click",enterNormalMode)):e===selectionModes.split?(splitPanelSetMoveStay(),showPanel(splitPanel,splitBut),splitBut.addEventListener("click",enterNormalMode)):e===selectionModes.places&&(orientPlacesArrow(),showPanel(placesPanel,placesBut),placesBut.addEventListener("click",enterNormalMode)),selectionMode=e,mousePosition&&showPath({clientX:mousePosition.x,clientY:mousePosition.y}),e===selectionModes.normal&&paint(gs))}function enterNormalMode(){enterMode(selectionModes.normal)}function enterTravelMode(){enterMode(selectionModes.travel)}function enterBuildMode(){enterMode(selectionModes.build)}function enterSplitMode(){enterMode(selectionModes.split)}function enterPlacesMode(){enterMode(selectionModes.places)}function splitPanelSetMoveStay(){var e=humanity(currentTile),t=e.h*splitInputWidget.value/100|0,i=e.h-t;splitPanelPortionMove.textContent=""+t,splitPanelPortionStay.textContent=""+i}function mouseSelection(e){gs.canvas.removeEventListener("mousemove",mouseDrag),gs.canvas.removeEventListener("mouseup",mouseSelection);var t=tileFromPixel({x:e.clientX,y:e.clientY},gs.origin,gs.hexSize);if(selectionMode!==selectionModes.travel&&selectionMode!==selectionModes.split||void 0===currentTile||void 0===humanity(currentTile))sendPos(currentTile,t);else{var i=humanity(currentTile),n=i.h;selectionMode===selectionModes.split&&(n=n*splitInputWidget.value/100|0);var r=t;if(humanTravelPath(currentTile,r).length>1&&i.c===playerCamp){if(i.f<=0){var a={};a[keyFromTile(currentTile)]=i,addStarveMessages(a)}sendMove(currentTile,r,n)}enterMode(selectionModes.normal)}currentTile=t,updateCurrentTileInformation(),paint(gs)}function showPath(e){mousePosition={x:e.clientX,y:e.clientY},!currentTile||selectionMode!==selectionModes.travel&&selectionMode!==selectionModes.split||(targetTile=tileFromPixel(mousePosition,gs.origin,gs.hexSize),paint(gs),paintHumans(gs,humanityData))
}function mouseDrag(){gs.canvas.style.cursor="move",gs.canvas.removeEventListener("mousemove",mouseDrag),gs.canvas.removeEventListener("mouseup",mouseSelection),gs.canvas.addEventListener("mouseup",mouseEndDrag),gs.canvas.addEventListener("mousemove",dragMap),clearInterval(humanAnimationTimeout),currentlyDragging=!0,resetDragVector(),dragVelTo=setInterval(resetDragVector,dragVelInterval)}function mouseEndDrag(){gs.canvas.style.cursor="",gs.canvas.removeEventListener("mousemove",dragMap),gs.canvas.removeEventListener("mouseup",mouseEndDrag),humanAnimationTimeout=setInterval(animateHumans,100),currentlyDragging=!1,paint(gs),clearInterval(dragVelTo),computeDragVelocity(),inertiaDragMap()}function dragMap(e){if(!drawingWhileDragging){drawingWhileDragging=!0;var t=lastMousePosition.clientX-e.clientX,i=lastMousePosition.clientY-e.clientY;gs.origin.x0+=t,gs.origin.y0+=i,lastMousePosition.clientX=e.clientX,lastMousePosition.clientY=e.clientY,paint(gs),requestAnimationFrame(function(){drawingWhileDragging=!1})}}function resetDragVector(){dragTime=Date.now(),dragVector[0]=gs.origin.x0,dragVector[1]=gs.origin.y0}function computeDragVelocity(){dragTime=Date.now()-dragTime,dragVector[0]=gs.origin.x0-dragVector[0],dragVector[1]=gs.origin.y0-dragVector[1];var e=.03*dragTime;dragVelocity[0]=dragVector[0]/e|0,dragVelocity[1]=dragVector[1]/e|0}function inertiaDragMap(){gs.origin.x0+=dragVelocity[0],gs.origin.y0+=dragVelocity[1],dragVelocity[0]=dragVelocity[0]/1.1|0,dragVelocity[1]=dragVelocity[1]/1.1|0,paint(gs),requestAnimationFrame(function(){(0!==dragVelocity[0]||0!==dragVelocity[1])&&inertiaDragMap()})}!function(){function e(e){e||(e=Math.random),this.p=new Uint8Array(256),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var t=0;256>t;t++)this.p[t]=256*e();for(t=0;512>t;t++)this.perm[t]=this.p[255&t],this.permMod12[t]=this.perm[t]%12}var t=.5*(Math.sqrt(3)-1),i=(3-Math.sqrt(3))/6,n=1/3,r=1/6,a=(Math.sqrt(5)-1)/4,o=(5-Math.sqrt(5))/20;e.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(e,n){var r,a,o=this.permMod12,s=this.perm,l=this.grad3,c=0,u=0,d=0,m=(e+n)*t,p=Math.floor(e+m),h=Math.floor(n+m),g=(p+h)*i,y=p-g,f=h-g,v=e-y,T=n-f;v>T?(r=1,a=0):(r=0,a=1);var x=v-r+i,M=T-a+i,P=v-1+2*i,w=T-1+2*i,b=255&p,k=255&h,F=.5-v*v-T*T;if(F>=0){var S=3*o[b+s[k]];F*=F,c=F*F*(l[S]*v+l[S+1]*T)}var C=.5-x*x-M*M;if(C>=0){var D=3*o[b+r+s[k+a]];C*=C,u=C*C*(l[D]*x+l[D+1]*M)}var H=.5-P*P-w*w;if(H>=0){var A=3*o[b+1+s[k+1]];H*=H,d=H*H*(l[A]*P+l[A+1]*w)}return 70*(c+u+d)},noise3D:function(e,t,i){var a,o,s,l,c,u,d,m,p,h,g=this.permMod12,y=this.perm,f=this.grad3,v=(e+t+i)*n,T=Math.floor(e+v),x=Math.floor(t+v),M=Math.floor(i+v),P=(T+x+M)*r,w=T-P,b=x-P,k=M-P,F=e-w,S=t-b,C=i-k;F>=S?S>=C?(c=1,u=0,d=0,m=1,p=1,h=0):F>=C?(c=1,u=0,d=0,m=1,p=0,h=1):(c=0,u=0,d=1,m=1,p=0,h=1):C>S?(c=0,u=0,d=1,m=0,p=1,h=1):C>F?(c=0,u=1,d=0,m=0,p=1,h=1):(c=0,u=1,d=0,m=1,p=1,h=0);var D=F-c+r,H=S-u+r,A=C-d+r,E=F-m+2*r,q=S-p+2*r,I=C-h+2*r,L=F-1+3*r,N=S-1+3*r,B=C-1+3*r,R=255&T,z=255&x,V=255&M,W=.6-F*F-S*S-C*C;if(0>W)a=0;else{var K=3*g[R+y[z+y[V]]];W*=W,a=W*W*(f[K]*F+f[K+1]*S+f[K+2]*C)}var O=.6-D*D-H*H-A*A;if(0>O)o=0;else{var _=3*g[R+c+y[z+u+y[V+d]]];O*=O,o=O*O*(f[_]*D+f[_+1]*H+f[_+2]*A)}var Y=.6-E*E-q*q-I*I;if(0>Y)s=0;else{var X=3*g[R+m+y[z+p+y[V+h]]];Y*=Y,s=Y*Y*(f[X]*E+f[X+1]*q+f[X+2]*I)}var U=.6-L*L-N*N-B*B;if(0>U)l=0;else{var G=3*g[R+1+y[z+1+y[V+1]]];U*=U,l=U*U*(f[G]*L+f[G+1]*N+f[G+2]*B)}return 32*(a+o+s+l)},noise4D:function(e,t,i,n){var r,s,l,c,u,d=(this.permMod12,this.perm),m=this.grad4,p=(e+t+i+n)*a,h=Math.floor(e+p),g=Math.floor(t+p),y=Math.floor(i+p),f=Math.floor(n+p),v=(h+g+y+f)*o,T=h-v,x=g-v,M=y-v,P=f-v,w=e-T,b=t-x,k=i-M,F=n-P,S=0,C=0,D=0,H=0;w>b?S++:C++,w>k?S++:D++,w>F?S++:H++,b>k?C++:D++,b>F?C++:H++,k>F?D++:H++;var A,E,q,I,L,N,B,R,z,V,W,K;A=S>=3?1:0,E=C>=3?1:0,q=D>=3?1:0,I=H>=3?1:0,L=S>=2?1:0,N=C>=2?1:0,B=D>=2?1:0,R=H>=2?1:0,z=S>=1?1:0,V=C>=1?1:0,W=D>=1?1:0,K=H>=1?1:0;var O=w-A+o,_=b-E+o,Y=k-q+o,X=F-I+o,U=w-L+2*o,G=b-N+2*o,J=k-B+2*o,j=F-R+2*o,$=w-z+3*o,Q=b-V+3*o,Z=k-W+3*o,et=F-K+3*o,tt=w-1+4*o,it=b-1+4*o,nt=k-1+4*o,rt=F-1+4*o,at=255&h,ot=255&g,st=255&y,lt=255&f,ct=.6-w*w-b*b-k*k-F*F;if(0>ct)r=0;else{var ut=d[at+d[ot+d[st+d[lt]]]]%32*4;ct*=ct,r=ct*ct*(m[ut]*w+m[ut+1]*b+m[ut+2]*k+m[ut+3]*F)}var dt=.6-O*O-_*_-Y*Y-X*X;if(0>dt)s=0;else{var mt=d[at+A+d[ot+E+d[st+q+d[lt+I]]]]%32*4;dt*=dt,s=dt*dt*(m[mt]*O+m[mt+1]*_+m[mt+2]*Y+m[mt+3]*X)}var pt=.6-U*U-G*G-J*J-j*j;if(0>pt)l=0;else{var ht=d[at+L+d[ot+N+d[st+B+d[lt+R]]]]%32*4;pt*=pt,l=pt*pt*(m[ht]*U+m[ht+1]*G+m[ht+2]*J+m[ht+3]*j)}var gt=.6-$*$-Q*Q-Z*Z-et*et;if(0>gt)c=0;else{var yt=d[at+z+d[ot+V+d[st+W+d[lt+K]]]]%32*4;gt*=gt,c=gt*gt*(m[yt]*$+m[yt+1]*Q+m[yt+2]*Z+m[yt+3]*et)}var ft=.6-tt*tt-it*it-nt*nt-rt*rt;if(0>ft)u=0;else{var vt=d[at+1+d[ot+1+d[st+1+d[lt+1]]]]%32*4;ft*=ft,u=ft*ft*(m[vt]*tt+m[vt+1]*it+m[vt+2]*nt+m[vt+3]*rt)}return 27*(r+s+l+c+u)}},"undefined"!=typeof define&&define.amd&&define(function(){return e}),"undefined"!=typeof exports?exports.SimplexNoise=e:"undefined"!=typeof navigator&&(this.SimplexNoise=e),"undefined"!=typeof module&&(module.exports=e)}();var MersenneTwister=function(e){void 0==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,this.init_genrand(e)};MersenneTwister.prototype.init_genrand=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++){var e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0}},MersenneTwister.prototype.init_by_array=function(e,t){var i,n,r;for(this.init_genrand(19650218),i=1,n=0,r=this.N>t?this.N:t;r;r--){var a=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&a)>>>16)<<16)+1664525*(65535&a))+e[n]+n,this.mt[i]>>>=0,i++,n++,i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),n>=t&&(n=0)}for(r=this.N-1;r;r--){var a=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1566083941*((4294901760&a)>>>16)<<16)+1566083941*(65535&a))-i,this.mt[i]>>>=0,i++,i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1)}this.mt[0]=2147483648},MersenneTwister.prototype.genrand_int32=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_genrand(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,e^=e>>>18,e>>>0},MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>>1},MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967295)},MersenneTwister.prototype.random=function(){return this.genrand_int32()*(1/4294967296)},MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)},MersenneTwister.prototype.genrand_res53=function(){var e=this.genrand_int32()>>>5,t=this.genrand_int32()>>>6;return(67108864*e+t)*(1/9007199254740992)};var prng=new MersenneTwister(0),simplex1=new SimplexNoise(prng.random.bind(prng)),simplex2=new SimplexNoise(prng.random.bind(prng)),factor=50,tileTypes={water:0,steppe:1,hill:2,mountain:3,swamp:4,meadow:5,forest:6,taiga:7,farm:8,residence:9,skyscraper:10,factory:11,dock:12,airland:13,airport:14,gunsmith:15,road:16,wall:17,blackdeath:18,metal:19,lumber:20,mine:21,industry:22,citrus:23,university:24},buildingTypes=[8,9,10,11,12,13,14,15,16,17,20,21,22,24],resourceTypes={lumber:-1,metal:-2,farm:-3},listOfResourceTypes=[resourceTypes.lumber,resourceTypes.metal,resourceTypes.farm],tileVegetationTypeFromSteepness=[];tileVegetationTypeFromSteepness[tileTypes.water]=tileTypes.swamp,tileVegetationTypeFromSteepness[tileTypes.steppe]=tileTypes.meadow,tileVegetationTypeFromSteepness[tileTypes.hill]=tileTypes.forest,tileVegetationTypeFromSteepness[tileTypes.mountain]=tileTypes.taiga;var distances=[];distances[tileTypes.water]=2989,distances[tileTypes.steppe]=2,distances[tileTypes.hill]=4,distances[tileTypes.mountain]=16,distances[tileTypes.swamp]=8,distances[tileTypes.meadow]=3,distances[tileTypes.forest]=8,distances[tileTypes.taiga]=24,distances[tileTypes.road]=1,distances[tileTypes.wall]=32;var MAX_INT=9007199254740992,normalWater=distances[tileTypes.water],normalSwamp=distances[tileTypes.swamp],manufacture={boat:1,car:2,plane:4,gun:8},buildingDependencies=[,,,,,,,,,[[2,tileTypes.farm]],[[6,tileTypes.residence]],[[3,tileTypes.residence],[2,tileTypes.road]],[[1,tileTypes.residence],[1,tileTypes.water],[1,resourceTypes.lumber]],[[2,tileTypes.road]],[[1,tileTypes.gunsmith],[3,tileTypes.airland],[1,resourceTypes.lumber]],[[1,tileTypes.skyscraper],[1,tileTypes.factory]],,,,,[[1,tileTypes.residence]],[[1,resourceTypes.lumber],[1,tileTypes.factory]],[[10,resourceTypes.farm],[1,tileTypes.mine],[5,tileTypes.road]],,[[1,resourceTypes.metal],[20,resourceTypes.farm],[2,tileTypes.wall]]],buildingTileDependency=[,,,,,,,,,,,,,,,,,,,,[tileTypes.forest,tileTypes.taiga],[tileTypes.metal],,,[tileTypes.citrus]],planTypes={move:1,build:2},plans={},gameOver,socket,retries=0;connectSocket();var registerMoves=Object.create(null),campNames,defaultPlacesPanelHTML=placesPanel.innerHTML,humanityData={},humanityPopulation,playerCamp,resources={farm:0,usedFarm:0,lumber:0,usedLumber:0,metal:0,usedMetal:0},campResources,helpPane=document.getElementById("helpPane");addEventListener("load",function(){localStorage.getItem("firstRun")?Math.random()<.5&&localStorage.getItem("paid")!==""+(new Date).getFullYear()&&showHelp("intro"):localStorage.setItem("firstRun","no")}),travelPanel.onclick=function(){showHelp("welcome")},buildPanel.firstElementChild.onclick=function(){showHelp("build")};var sprites=loadSprites(),spritesLoaded=!1;sprites.onload=function(){spritesLoaded=!0,paint(gs)};var canvas=document.getElementById("canvas");canvas.width=document.documentElement.clientWidth,canvas.height=document.documentElement.clientHeight;var gs=makeGraphicState(canvas,sprites);document.styleSheets[0].insertRule("div.controlPanel { max-height:"+(gs.height-16-58)+"px; }",0);var mπd3=-Math.PI/3,cachedTerrainPaint={},canvasBuffer=document.createElement("canvas");canvasBuffer.width=gs.width,canvasBuffer.height=gs.height;var imageBuffer=canvasBuffer.getContext("2d").getImageData(0,0,gs.width,gs.height),workerMessage={image:null,size:gs.hexSize,origin:gs.origin},renderWorker=new Worker("render-worker.js"),cachedPaint={},cachePending={},displayedPaint=document.createElement("canvas");displayedPaint.width=gs.width,displayedPaint.height=gs.height;var displayedPaintContext=displayedPaint.getContext("2d"),showTitleScreen=!0;setTimeout(function(){showTitleScreen=!1},2e3);var numberOfHumanAnimations=20,humanAnimation=new Array(numberOfHumanAnimations);initHumans();var humanAnimationTimeout=setInterval(animateHumans,100),numberOfCamps=3,campHue=[],surrenderMessages=["We surrender!","I give up!","Enemies captured!","I, for one, welcome our new overlords."],hungerMessages=["Make a farm.","Hungry!","Is dinner ready?","I can't feel my stomach!","You're starving us!","I could eat anything. Rats. Babies.","You look like a sandwich to me."],warMessages=["You've got red on you.","Silence will fall!","Silence! I kill you!","Boy, that escalated quickly.","Sorry Mommy!","New legs, please!","Have you seen my head?","There is wine on the floor…","They're bleeding demised!","Them ex-people make daisies happy.","⬐ Acclimated to the being dead position","So much for survival!","Today I died.","I dare you! I double-dare you!","Mayday!","Area pacified, over!","Resistance is futile.","All your base are belong to us.","Nobody expects the Spanish Inquisition!","Whoop-de-doo!","You'll never take me alive!","Told you he wasn't immortal!","Tu quoque, fili mi!","Do not disturb my circles!","This is no time to be making enemies.","I owe a cock to Asclepius.","More light!","Life's too short!","What will you do, kill m—?!","Drink to me!"],warTiles={},surrenderTiles={},starvedTiles={},tileNames=attributeNameFromTile(),tileInfo=document.getElementById("info"),lockedTiles,accessibleTiles,currentTile,buildSelectionButtons=document.querySelectorAll("p.buildSelection");hookBuildSelectionButtons();var selectionModes={normal:1,travel:2,build:3,split:4,places:5},selectionMode=selectionModes.normal;travelBut.addEventListener("click",enterTravelMode),buildBut.addEventListener("click",enterBuildMode),splitBut.addEventListener("click",enterSplitMode),placesBut.addEventListener("click",enterPlacesMode),splitInputWidget.addEventListener("input",function(){splitPanelPortion.textContent=""+splitInputWidget.value,splitPanelSetMoveStay()});var buildHotKeys={48:tileTypes.airport,49:tileTypes.wall,50:tileTypes.road,51:tileTypes.farm,52:tileTypes.residence,53:tileTypes.skyscraper,54:tileTypes.factory,55:tileTypes.dock,56:tileTypes.gunsmith,57:tileTypes.airland};window.onkeydown=function(e){var t=!1,i=!1;39===e.keyCode||68===e.keyCode?(gs.origin.x0+=gs.width/2|0,i=!0):38===e.keyCode||87===e.keyCode?(gs.origin.y0-=gs.height/2|0,i=!0):37===e.keyCode||65===e.keyCode?(gs.origin.x0-=gs.width/2|0,i=!0):40===e.keyCode||83===e.keyCode?(gs.origin.y0+=gs.height/2|0,i=!0):187===e.keyCode||61===e.keyCode?(gs.hexSize*=2,gs.origin.x0=2*gs.origin.x0+gs.width/2|0,gs.origin.y0=2*gs.origin.y0+gs.height/2|0,t=!0,i=!0):173===e.keyCode||189===e.keyCode||109===e.keyCode||219===e.keyCode||169===e.keyCode?gs.hexSize>2&&(gs.hexSize=gs.hexSize/2,gs.origin.x0=gs.origin.x0/2-gs.width/4|0,gs.origin.y0=gs.origin.y0/2-gs.height/4|0,t=!0,i=!0):84===e.keyCode?enterMode(selectionModes.travel):67===e.keyCode?enterMode(selectionModes.build):70===e.keyCode?enterMode(selectionModes.split):192===e.keyCode?sendBuild(currentTile,null):27===e.keyCode?(enterMode(selectionModes.normal),helpPane.style.display="none"):48<=e.keyCode&&e.keyCode<=57&&sendBuild(currentTile,buildHotKeys[e.keyCode]),t&&(cachedPaint={}),i&&paint(gs)};var mousePosition,targetTile;canvas.addEventListener("mousemove",showPath),gs.canvas.onmousedown=function(e){0===e.button?(gs.canvas.addEventListener("mouseup",mouseSelection),gs.canvas.addEventListener("mousemove",mouseDrag),lastMousePosition.clientX=e.clientX,lastMousePosition.clientY=e.clientY):2===e.button&&(enterTravelMode(),mouseSelection(e),enterNormalMode())},gs.canvas.oncontextmenu=function(e){e.preventDefault()},function(){var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,0)};window.requestAnimationFrame=e}();var lastMousePosition={clientX:0,clientY:0},drawingWhileDragging=!1,currentlyDragging=!1;canvas.onselectstart=function(){return!1};var dragVelocity=[0,0],dragVector=[0,0],dragTime=0,dragVelTo,dragVelInterval=200;