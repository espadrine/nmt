!function(){var _=.5*(Math.sqrt(3)-1),N=(3-Math.sqrt(3))/6,B=1/6,ce=(Math.sqrt(5)-1)/4,fe=(5-Math.sqrt(5))/20;function e(e){e||(e=Math.random),this.p=new Uint8Array(256),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var t=0;t<256;t++)this.p[t]=256*e();for(t=0;t<512;t++)this.perm[t]=this.p[255&t],this.permMod12[t]=this.perm[t]%12}e.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(e,t){var i,r,s=this.permMod12,n=this.perm,a=this.grad3,o=0,l=0,p=0,h=(e+t)*_,u=Math.floor(e+h),m=Math.floor(t+h),c=(u+m)*N,f=e-(u-c),y=t-(m-c);y<f?(i=1,r=0):(i=0,r=1);var T=f-i+N,d=y-r+N,v=f-1+2*N,g=y-1+2*N,M=255&u,w=255&m,b=.5-f*f-y*y;if(0<=b){var x=3*s[M+n[w]];o=(b*=b)*b*(a[x]*f+a[x+1]*y)}var D=.5-T*T-d*d;if(0<=D){var F=3*s[M+i+n[w+r]];l=(D*=D)*D*(a[F]*T+a[F+1]*d)}var q=.5-v*v-g*g;if(0<=q){var P=3*s[M+1+n[w+1]];p=(q*=q)*q*(a[P]*v+a[P+1]*g)}return 70*(o+l+p)},noise3D:function(e,t,i){var r,s,n,a,o,l,p,h,u,m,c=this.permMod12,f=this.perm,y=this.grad3,T=(e+t+i)*(1/3),d=Math.floor(e+T),v=Math.floor(t+T),g=Math.floor(i+T),M=(d+v+g)*B,w=e-(d-M),b=t-(v-M),x=i-(g-M);b<=w?x<=b?(u=h=o=1,m=p=l=0):x<=w?(u=p=l=0,m=h=o=1):(u=l=o=0,m=h=p=1):b<x?(h=l=o=0,m=u=p=1):w<x?(h=p=o=0,m=u=l=1):(u=h=l=1,m=p=o=0);var D=w-o+B,F=b-l+B,q=x-p+B,P=w-h+2*B,_=b-u+2*B,N=x-m+2*B,A=w-1+.5,k=b-1+.5,S=x-1+.5,R=255&d,K=255&v,H=255&g,U=.6-w*w-b*b-x*x;if(U<0)r=0;else{var E=3*c[R+f[K+f[H]]];r=(U*=U)*U*(y[E]*w+y[E+1]*b+y[E+2]*x)}var O=.6-D*D-F*F-q*q;if(O<0)s=0;else{var L=3*c[R+o+f[K+l+f[H+p]]];s=(O*=O)*O*(y[L]*D+y[L+1]*F+y[L+2]*q)}var V=.6-P*P-_*_-N*N;if(V<0)n=0;else{var C=3*c[R+h+f[K+u+f[H+m]]];n=(V*=V)*V*(y[C]*P+y[C+1]*_+y[C+2]*N)}var W=.6-A*A-k*k-S*S;if(W<0)a=0;else{var z=3*c[R+1+f[K+1+f[H+1]]];a=(W*=W)*W*(y[z]*A+y[z+1]*k+y[z+2]*S)}return 32*(r+s+n+a)},noise4D:function(e,t,i,r){this.permMod12;var s,n,a,o,l,p,h,u,m,c,f,y,T,d,v,g,M,w=this.perm,b=this.grad4,x=(e+t+i+r)*ce,D=Math.floor(e+x),F=Math.floor(t+x),q=Math.floor(i+x),P=Math.floor(r+x),_=(D+F+q+P)*fe,N=e-(D-_),A=t-(F-_),k=i-(q-_),S=r-(P-_),R=0,K=0,H=0,U=0;A<N?R++:K++,k<N?R++:H++,S<N?R++:U++,k<A?K++:H++,S<A?K++:U++,S<k?H++:U++;var E=N-(p=3<=R?1:0)+fe,O=A-(h=3<=K?1:0)+fe,L=k-(u=3<=H?1:0)+fe,V=S-(m=3<=U?1:0)+fe,C=N-(c=2<=R?1:0)+2*fe,W=A-(f=2<=K?1:0)+2*fe,z=k-(y=2<=H?1:0)+2*fe,B=S-(T=2<=U?1:0)+2*fe,I=N-(d=1<=R?1:0)+3*fe,X=A-(v=1<=K?1:0)+3*fe,j=k-(g=1<=H?1:0)+3*fe,G=S-(M=1<=U?1:0)+3*fe,J=N-1+4*fe,Q=A-1+4*fe,Y=k-1+4*fe,Z=S-1+4*fe,$=255&D,ee=255&F,te=255&q,ie=255&P,re=.6-N*N-A*A-k*k-S*S;if(re<0)s=0;else{var se=w[$+w[ee+w[te+w[ie]]]]%32*4;s=(re*=re)*re*(b[se]*N+b[se+1]*A+b[se+2]*k+b[se+3]*S)}var ne=.6-E*E-O*O-L*L-V*V;if(ne<0)n=0;else{var ae=w[$+p+w[ee+h+w[te+u+w[ie+m]]]]%32*4;n=(ne*=ne)*ne*(b[ae]*E+b[ae+1]*O+b[ae+2]*L+b[ae+3]*V)}var oe=.6-C*C-W*W-z*z-B*B;if(oe<0)a=0;else{var le=w[$+c+w[ee+f+w[te+y+w[ie+T]]]]%32*4;a=(oe*=oe)*oe*(b[le]*C+b[le+1]*W+b[le+2]*z+b[le+3]*B)}var pe=.6-I*I-X*X-j*j-G*G;if(pe<0)o=0;else{var he=w[$+d+w[ee+v+w[te+g+w[ie+M]]]]%32*4;o=(pe*=pe)*pe*(b[he]*I+b[he+1]*X+b[he+2]*j+b[he+3]*G)}var ue=.6-J*J-Q*Q-Y*Y-Z*Z;if(ue<0)l=0;else{var me=w[$+1+w[ee+1+w[te+1+w[ie+1]]]]%32*4;l=(ue*=ue)*ue*(b[me]*J+b[me+1]*Q+b[me+2]*Y+b[me+3]*Z)}return 27*(s+n+a+o+l)}},"undefined"!=typeof define&&define.amd&&define(function(){return e}),"undefined"!=typeof exports?exports.SimplexNoise=e:"undefined"!=typeof navigator&&(this.SimplexNoise=e),"undefined"!=typeof module&&(module.exports=e)}();var MersenneTwister=function(e){null==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,this.init_genrand(e)};MersenneTwister.prototype.init_genrand=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++){e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0}},MersenneTwister.prototype.init_by_array=function(e,t){var i,r,s;for(this.init_genrand(19650218),i=1,r=0,s=this.N>t?this.N:t;s;s--){var n=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&n)>>>16)<<16)+1664525*(65535&n))+e[r]+r,this.mt[i]>>>=0,r++,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),t<=r&&(r=0)}for(s=this.N-1;s;s--){n=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1566083941*((4294901760&n)>>>16)<<16)+1566083941*(65535&n))-i,this.mt[i]>>>=0,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1)}this.mt[0]=2147483648},MersenneTwister.prototype.genrand_int32=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_genrand(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,(e^=e>>>18)>>>0},MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>>1},MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967295)},MersenneTwister.prototype.random=function(){return this.genrand_int32()*(1/4294967296)},MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)},MersenneTwister.prototype.genrand_res53=function(){return(67108864*(this.genrand_int32()>>>5)+(this.genrand_int32()>>>6))*(1/9007199254740992)};var prng=new MersenneTwister(0),simplex1=new SimplexNoise(prng.random.bind(prng)),simplex2=new SimplexNoise(prng.random.bind(prng)),factor=50,tileTypes={water:0,steppe:1,hill:2,mountain:3,swamp:4,meadow:5,forest:6,taiga:7,farm:8,residence:9,skyscraper:10,factory:11,dock:12,airland:13,airport:14,gunsmith:15,road:16,wall:17,blackdeath:18,metal:19,lumber:20,mine:21,industry:22,citrus:23,university:24,beach:25,arsenal:26,smoke:27,impact:28,curvedRoad:29,whales:30,pearls:31,fish:32,algae:33,glass:34,salt:35,cattle:36,poultry:37,ivory:38,limestone:39,wool:40,grapes:41,fur:42,pigments:43,rubber:44,coal:45,crocodile:46,petroleum:47,shrimp:48,clay:49,spices:50,cotton:51,coffee:52,tea:53,resin:54,cocoa:55,honey:56,silk:57,gems:58,fungus:59,pelt:60,amber:61,field:62,market:63,"space mission":64,"stock exchange":65,monument:66},buildingTypes=[8,9,10,11,12,13,14,15,16,17,20,21,22,24,26,62,63,64,65,66],resourceTypes={fuel:-1,metal:-2,wealth:-3},listOfResourceTypes=[resourceTypes.fuel,resourceTypes.metal,resourceTypes.wealth];function setupStringFromTileType(){var e=Object.create(null);for(var t in tileTypes)e[tileTypes[t]]=t;for(var t in resourceTypes)e[resourceTypes[t]]=t;return e}var stringFromTileType=setupStringFromTileType(),tileVegetationTypeFromSteepness=[];function tileType(e,t){return t?tileVegetationTypeFromSteepness[e]:e}function heatmap(e,t,i,r,s){for(var n=0,a=0,o=0;o<s;o++){var l=Math.pow(2,o);n+=i.noise2D(e/r*l,t/r*l)/l,a+=1/l}return n/a}tileVegetationTypeFromSteepness[tileTypes.water]=tileTypes.swamp,tileVegetationTypeFromSteepness[tileTypes.steppe]=tileTypes.meadow,tileVegetationTypeFromSteepness[tileTypes.hill]=tileTypes.forest,tileVegetationTypeFromSteepness[tileTypes.mountain]=tileTypes.taiga;var distancesNormal=[17,2,4,16,8,3,8,24,,,,,,,,,1,32],distancesBoat=[1,4,8,16,1,8,16,24,,,,,,,,,1,32],distancesPlane=[1,1,2,2,1,1,2,2,,,,,,,,,1,8],MAX_INT=9007199254740992,manufacture={boat:1,car:2,plane:4,artillery:8,gun:16},buildingDependencies=[,,,,,,,,,[[2,tileTypes.farm]],[[6,tileTypes.residence]],[[3,tileTypes.residence]],[[1,tileTypes.residence],[1,tileTypes.water],[1,resourceTypes.fuel]],[[2,tileTypes.road]],[[1,tileTypes.gunsmith],[3,tileTypes.airland],[1,resourceTypes.fuel]],[[1,tileTypes.skyscraper],[1,tileTypes.factory]],,,,,[[1,tileTypes.residence]],[[1,resourceTypes.fuel],[1,tileTypes.factory]],[[10,resourceTypes.wealth],[1,tileTypes.mine],[5,tileTypes.road]],,[[1,tileTypes.meadow],[1,tileTypes.water],[2,tileTypes.residence]],,[[1,tileTypes.gunsmith],[1,resourceTypes.metal]],,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,[],[[1,tileTypes.dock],[1,tileTypes.skyscraper],[4,resourceTypes.metal]],[[2,tileTypes.airport],[20,resourceTypes.metal],[20,resourceTypes.fuel]],[[1,tileTypes.market],[1,tileTypes.university],[200,resourceTypes.wealth],[20,resourceTypes.metal]],[[3,tileTypes.skyscraper],[200,resourceTypes.wealth],[20,resourceTypes.fuel]]],buildingTileDependency=[,,,,,,,,,,,,,,,,,,,,[tileTypes.forest,tileTypes.taiga],[tileTypes.metal],,,,,[tileTypes.steppe]],planTypes={move:1,build:2};function Terrain(e){this.humanity=e,this.plans={}}Terrain.prototype={humanity:null,centerTile:{q:0,r:0},centerPoint:{x:0,y:0},tileTypes:tileTypes,buildingTypes:buildingTypes,resourceTypes:resourceTypes,listOfResourceTypes:listOfResourceTypes,stringFromTileType:function(e){return stringFromTileType[e]},tileType:tileType,heatmap:heatmap,setCenterTile:function(e){this.centerTile=e,this.centerPoint.x=Math.sqrt(3)*(e.q+e.r/2)|0,this.centerPoint.y=1.5*e.r},continent:function(e,t){var i=heatmap(e,t,simplex1,512,8),r=this.centerPoint,s=(e-r.x)*(e-r.x)+(t-r.y)*(t-r.y),n=heatmap(e,t,simplex1,2048,8),a=+(i+.7)*Math.exp(-s/262144);return a<n&&(a=n),a=Math.min(1,a)},continentLimit:.42,tile:function(e){var t,i;void 0===e.x?(t=Math.sqrt(3)*(e.q+e.r/2)|0,i=1.5*e.r):(t=e.x,i=e.y);var r=simplex2.noise2D(i/4/factor,t/4/factor),s=1-Math.abs((4*simplex1.noise2D(t/4/factor,i/4/factor)+2*simplex1.noise2D(t/2/factor,i/2/factor)+1*simplex1.noise2D(t/1/factor,i/1/factor)+.5*simplex1.noise2D(2*t/factor,2*i/factor))/7.5),n=Math.sin(-5*r*Math.abs(simplex1.noise2D(1/8*t/factor,1/8*i/factor))+simplex1.noise2D(t/factor,i/factor)-.5*simplex1.noise2D(2*t/factor,2*i/factor)+.25*simplex1.noise2D(4*t/factor,4*i/factor)-1/8*simplex1.noise2D(8*t/factor,8*i/factor)+1/16*simplex1.noise2D(16*t/factor,16*i/factor)),a=-simplex2.noise2D(i/factor/8,t/factor/8)+simplex2.noise2D(i/factor/4,t/factor/4)+n/2,o=r*simplex2.noise2D(t/factor,i/factor)+.5*simplex2.noise2D(2*t/factor,2*i/factor)+.25*simplex2.noise2D(4*t/factor,4*i/factor)+1/8*simplex2.noise2D(8*t/factor,8*i/factor)+1/16*simplex2.noise2D(16*t/factor,16*i/factor),l=n-s,p=this.continent(t,i);if(p>this.continentLimit)var h,u=o-((m=!(.6<n)&&.98<s||3*a/4+n/4<-1?(l=p*(h=(-1.5- -1.3)/(this.continentLimit-1))-1.3-h,tileTypes.water):o<-1?tileTypes.hill:l<-.2?tileTypes.steppe:l<.2?tileTypes.hill:tileTypes.mountain)===tileTypes.water?2*a:0)+Math.abs(n+.15)<0;else{var m=tileTypes.water;u=!1;l=p-1.92}var c={steepness:m,vegetation:u,type:this.tileType(m,u),height:l,rain:-o/2};return c},commodity:function(e,t){var i,r,s=e.q,n=e.r,a=(-simplex1.noise2D(s/60,n/60)/8+1)/2,o=(simplex1.noise2D(s/60,n/60)/8+1)/2,l=(-simplex2.noise2D(s/60,n/60)/8+1)/2,p=(simplex2.noise2D(s/60,n/60)/8+1)/2,h=a*simplex1.noise2D(s/4,n/4),u=o*simplex1.noise2D(s/16,n/16),m=l*simplex2.noise2D(s/2,n/2),c=p*simplex2.noise2D(s/8,n/8);if(.49<h)i=0;else if(.49<u)i=1;else if(.45<m)i=2;else{if(!(.45<c))return-1;i=3}return r=null!=t?t.type:this.tile(e).type,tileTypes.whales+(r<<2)+i},distances:distancesNormal,distance:function(e){var t=this.tile(e),i=this.humanity.tile(e),r=this.distances[i&&i.b?i.b:t.type];return void 0===r&&(r=this.distances[t.type]),r},distanceBetweenTiles:function(e,t){return(Math.abs(e.q-t.q)+Math.abs(e.r-t.r)+Math.abs(e.q+e.r-t.q-t.r))/2},neighborFromTile:function(e,t){return 0===t?{q:e.q+1,r:e.r}:1===t?{q:e.q+1,r:e.r-1}:2===t?{q:e.q,r:e.r-1}:3===t?{q:e.q-1,r:e.r}:4===t?{q:e.q-1,r:e.r+1}:5===t?{q:e.q,r:e.r+1}:void 0},keyFromTile:function(e){return e.q+":"+e.r},tileFromKey:function(e){var t=e.split(":");return{q:0|t[0],r:0|t[1]}},manufacture:manufacture,manufactureFromBuilding:function(e){return e===tileTypes.dock?manufacture.boat:e===tileTypes.factory?manufacture.car:e===tileTypes.airport?manufacture.plane:e===tileTypes.gunsmith?manufacture.gun:null},speedFromHuman:function(e){var t=8;return 0!=(e.o&manufacture.car)&&(t+=8),t},travelFrom:function(e,t){var i=this.humanity.tile(e).c,r={},s=this.keyFromTile(e);r[s]=null;var n={};n[s]=0;var a=[];for(a.push(s);0<a.length;){s=a.shift();var o=this.humanity.tile(this.tileFromKey(s));if(!o||null==o.c||o.c===i)for(var l=0;l<6;l++){var p=this.neighborFromTile(this.tileFromKey(s),l),h=n[s]+this.distance(p);if(h<=t){var u=this.keyFromTile(p);if(void 0!==n[u]&&h<n[u]&&delete n[u],void 0===n[u]&&void 0===r[u]){n[u]=h,r[u]=s;for(var m=-1,c=0;c<a.length;c++)if(void 0!==n[a[c]]){if(n[u]<=n[a[c]]){m=c;break}}else a.splice(c,1),c--;-1===m?a.push(u):a.splice(m,0,u)}}}}return r},travelTo:function(e,t,i,r,s,n){null==s&&(s=MAX_INT),null==n&&(n=this.humanity.tile(e));var a=n.c,o=this.keyFromTile(t),l={},p={},h={},u=[],m={},c=this.keyFromTile(e);for(m[c]=null,p[c]=0,u.push(c);0<u.length&&o!==c;){l[c=u.shift()]=!0;var f=this.humanity.tile(this.tileFromKey(c));if(!f||null==f.c||f.c===a)for(var y=0;y<6;y++){var T=this.neighborFromTile(this.tileFromKey(c),y),d=this.distance(T);if(!(i<d)){if(s<=0)return null;s--;var v=p[c]+d;if(!(r&&i<v)){var g=this.keyFromTile(T);if(void 0!==p[g]&&v<p[g]&&delete p[g],void 0===p[g]&&void 0===l[g]){p[g]=v,h[g]=v+(Math.abs(t.q-T.q)+Math.abs(t.r-T.r)+Math.abs(t.q+t.r-T.q-T.r))/2;for(var M=-1,w=0;w<u.length;w++)if(void 0!==h[u[w]]){if(h[g]<=h[u[w]]){M=w;break}}else u.splice(w,1),w--;-1===M?u.push(g):u.splice(M,0,g),m[g]=c}}}}}return o!==c?null:{endKey:o,parents:m,costs:p}},pathFromParents:function(e,t){var i=[];if(null==t[e])return[];for(;null!==t[e];)i.push(e),e=t[e];return i.push(e),i.reverse()},setDistancesForHuman:function(e){0!=(e.o&manufacture.plane)?this.distances=distancesPlane:0!=(e.o&manufacture.boat)&&(this.distances=distancesBoat)},unsetDistancesForHuman:function(e){this.distances=distancesNormal},humanTravelFrom:function(e){var t=this.humanity.tile(e);if(!t||t.h<=0)return{};this.setDistancesForHuman(t);var i=this.travelFrom(e,this.speedFromHuman(t));return this.unsetDistancesForHuman(t),i},humanTravelTo:function(e,t,i,r,s){if(null==s&&(s=this.humanity.tile(e)),!s||s.h<=0)return null;this.setDistancesForHuman(s);var n=this.travelTo(e,t,this.speedFromHuman(s),i,r,s);return this.unsetDistancesForHuman(s),n},humanTravelPath:function(e,t){var i=this.humanTravelTo(e,t);return null==i?[]:this.pathFromParents(i.endKey,i.parents)},humanTravelSpeedPath:function(e,t){var i=this.humanTravelTo(e,t,!0);return null==i?[]:this.pathFromParents(i.endKey,i.parents)},buildingDependencies:buildingDependencies,buildingTileDependency:buildingTileDependency,validConstruction:function(e,t,i){if(null==e)return!0;var r=this.humanity.tile(t),s=this.tile(t),n=i.fuel-i.usedFuel,a=i.metal-i.usedMetal,o=i.wealth-i.usedWealth;if(!r||r.h<=0)return!1;if(e===tileTypes.field)return 0<=this.commodity(t,s);if(s.type===tileTypes.water&&(e===tileTypes.farm||e===tileTypes.residence||e===tileTypes.skyscraper||e===tileTypes.factory||e===tileTypes.airland||e===tileTypes.airport||e===tileTypes.gunsmith))return!1;if(void 0!==buildingTileDependency[e]){for(var l=!1,p=0;p<buildingTileDependency[e].length;p++)buildingTileDependency[e][p]!==s.type&&buildingTileDependency[e][p]!==r.b||(l=!0);if(!l)return!1}if(void 0!==buildingDependencies[e]){var h=buildingDependencies[e],u=new Array(h.length);for(p=0;p<u.length;p++)u[p]=0;for(p=0;p<6;p++)for(var m=this.neighborFromTile(t,p),c=this.humanity.tile(m),f=this.tile(m),y=0;y<h.length;y++)if(0<=h[y][1]&&c&&c.b===h[y][1]||f.type===h[y][1])u[y]++;else if(h[y][1]<0){if(h[y][1]===resourceTypes.fuel&&n<h[y][0])return!1;if(h[y][1]===resourceTypes.metal&&a<h[y][0])return!1;if(h[y][1]===resourceTypes.wealth&&o<h[y][0])return!1;u[y]=h[y][0]}for(y=0;y<u.length;y++)if(u[y]<h[y][0])return!1;return!0}return!0},planTypes:planTypes,plans:{},addPlan:function(e){plans[e.at]=e},eachPlan:function(e){for(var t in plans)e(plans[t])},clearPlans:function(){plans={}}};var terrain=new Terrain;function intPointFromReal(e){var t=e.q,i=e.r,r=-t-i,s=Math.round(t),n=Math.round(r),a=Math.round(i),o=Math.abs(s-t),l=Math.abs(n-r),p=Math.abs(a-i);return l<o&&p<o?s=-n-a:p<l?n=-s-a:a=-s-n,{q:s,r:a}}function tileFromPixel(e,t,i){var r=e.x+t.x0,s=e.y+t.y0;return intPointFromReal({q:(Math.sqrt(3)*r-s)/3/i,r:2*s/3/i})}onmessage=function(e){e.data.centerTile?terrain.setCenterTile(e.data.centerTile):("raw"===e.data.type?paintTilesRaw(e.data.image,e.data.size,e.data.origin):"rainfall"===e.data.type&&paintRainfall(e.data.image,e.data.size,e.data.origin),postMessage({image:e.data.image,size:e.data.size,origin:e.data.origin}))};var cachedTerrainPaint={};function paintTilesRaw(e,t,i){var r=e.width,s=e.height,n=r*s*4,a=t+":"+i.x0+":"+i.y0;if(void 0===cachedTerrainPaint[a]){for(var o=new Uint8ClampedArray(n),l=0;l<s;l++)for(var p=!1,h=0;h<r;h++){var u=terrain.tile({x:(h+i.x0)/t,y:(l+i.y0)/t}),m=[0,0,0],c=0,f=0,y=0,T=0,d=-1,v=1;u.steepness===tileTypes.water?(m[2]=180,y=c=0,T=f=80,d=-2,v=-1.5):u.steepness===tileTypes.steppe?(c=100,y=160,f=85,T=140,d=-1.5,v=-.2,p&&(T=f=y=c=170)):u.steepness===tileTypes.hill?(c=100,y=140,f=150,T=110,d=-.2,v=.2):(c=150,y=100,f=40,T=10,d=.2,v=1),p=u.steepness===tileTypes.water,u.type===tileTypes.forest&&(c=20,f=50,T=y=100);var g=(u.height-d)/(v-d);m[0]=g*f+(1-g)*c,m[1]=g*T+(1-g)*y;var M=Math.min(Math.abs(m[0]-m[1])/2*u.rain,255);m[1]-=M,m[2]-=Math.min(20*u.rain,255),u.vegetation&&(m[0]-=50,m[1]-=25,m[2]-=50);var w=4*(h+l*r);o[w+0]=m[0],o[w+1]=m[1],o[w+2]=m[2],o[w+3]=255}cachedTerrainPaint[a]=o}e.data.set(cachedTerrainPaint[a])}function paintRainfall(e,t,i){for(var r=e.width,s=e.height,n=new Uint8ClampedArray(r*s*4),a=0;a<s;a++)for(var o=0;o<r;o++){var l=tileFromPixel({x:o,y:a},i,t),p=terrain.tile(l),h=(1-p.rain)/2,u=h=157*h+10|0,m=h;if(p.type===tileTypes.water);else{var c=0|Math.abs(h-78);h<78?(u-=c,m+=c):78<h&&(u+=2*c,m+=c)}var f=4*(o+a*r);n[f+0]=u,n[f+1]=m,n[f+2]=h,n[f+3]=60}e.data.set(n)}